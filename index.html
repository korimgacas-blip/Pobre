<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>O app do Pobre</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --income: #059669;
            --expense: #dc2626;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --radius: 20px;
            --chart-1: #4f46e5;
            --chart-2: #10b981;
            --chart-3: #f59e0b;
            --chart-4: #ef4444;
            --chart-5: #ec4899;
            --chart-6: #8b5cf6;
            --chart-7: #14b8a6;
            --chart-8: #f97316;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            margin: 0;
            padding-bottom: 110px;
            color: #111;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* --- CLASSE PARA ESCONDER MENU AO DIGITAR --- */
        body.keyboard-active nav {
            display: none !important;
        }
        body.keyboard-active {
            padding-bottom: 20px !important; /* Remove o padding extra do body quando teclado abre */
        }

        .gpu-accelerated {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 20px 24px 70px;
            border-radius: 0 0 36px 36px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            position: relative;
            z-index: 10;
        }

        .header-content { display: flex; flex-direction: column; justify-content: center; }
        .user-greeting { font-size: 0.8rem; font-weight: 500; opacity: 0.9; margin-top: 4px; display: none; }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 0 24px;
            margin-top: -50px;
            position: relative;
            z-index: 20;
        }

        .dash-card {
            background: var(--card-bg);
            padding: 20px 16px;
            border-radius: var(--radius);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            text-align: center;
            contain: content;
            transform: translateZ(0);
        }

        .dash-card small { color: #6b7280; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; }
        .dash-card b { font-size: 1.2rem; display: block; margin-top: 5px; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; }

        .view { display: none; will-change: transform, opacity; }
        .view.active { display: block; animation: fadeIn 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.08);
            transform: translateZ(0);
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.99) translateZ(0); }

        input, select { 
            width: 100%; 
            padding: 14px; 
            border-radius: 12px; 
            border: 1px solid #e5e7eb; 
            background: #f9fafb; 
            margin-bottom: 15px; 
            font-size: 16px; 
            transition: all 0.2s;
        }
        input:focus, select:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(79,70,229,0.1); 
            outline: none; 
            background: white;
        }
        
        button { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            transition: all 0.2s; 
        }
        button:active { transform: scale(0.98); opacity: 0.9; }

        .btn-income { background: var(--income); color: white; }
        .btn-expense { background: var(--expense); color: white; }
        .btn-delete { background: #fff1f2; color: #e11d48; margin-top: 10px; border: 1px solid #fecaca; }
        .btn-sec { background: #f3f4f6; color: #4b5563; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-pix { background: #32bcad; color: white; }
        .btn-mp { background: #009ee3; color: white; }
        .btn-wpp { background: #25d366; color: white; }
        .btn-tutorial { background: #8b5cf6; color: white; }

        .category-selector { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px; 
            margin-bottom: 20px; 
        }
        .category-option { 
            padding: 10px 5px; 
            border: 1px solid #e5e7eb; 
            border-radius: 12px; 
            text-align: center; 
            font-size: 0.65rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: white;
        }
        .category-option:hover { background: #f9fafb; }
        .category-option:active { transform: scale(0.95); }
        .category-option.selected { 
            background: #e0e7ff; 
            border-color: var(--primary); 
            color: var(--primary); 
            font-weight: 700; 
            box-shadow: 0 2px 4px rgba(79,70,229,0.2);
        }

        nav {
            position: fixed; bottom: 20px; left: 16px; right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 100;
            transform: translateZ(0);
            transition: transform 0.3s ease; /* Anima√ß√£o suave */
        }
        
        .nav-buttons { display: flex; height: 70px; justify-content: space-around; align-items: center; }
        .tab { color: #9ca3af; font-size: 0.65rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; flex: 1; transition: color 0.2s; }
        .tab.active { color: var(--primary); }
        .tab i { font-size: 1.2rem; margin-bottom: 2px; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .tab.active i { transform: translateY(-3px); }

        .item { 
            display: flex; 
            justify-content: space-between; 
            padding: 15px 0; 
            border-bottom: 1px solid #f3f4f6; 
            cursor: pointer; 
            transition: background 0.1s;
        }
        .item:hover { background: #fafafa; }

        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateZ(0);
            background: #333; color: white; padding: 12px 24px; border-radius: 50px;
            opacity: 0; transition: opacity 0.3s; z-index: 2000; pointer-events: none;
            will-change: opacity;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .info-section { font-size: 0.85rem; line-height: 1.5; color: #4b5563; }
        .info-section h4 { color: var(--primary); margin: 15px 0 8px; display: flex; align-items: center; gap: 6px; }
        .privacy-box { background: #f0fdf4; border: 1px solid #10b981; padding: 15px; border-radius: 15px; margin-top: 15px; color: #065f46; }
        
        canvas { 
            transform: translateZ(0); 
            max-height: 250px; 
            width: 100% !important; 
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(6px);
            z-index: 5000; display: none; align-items: center; justify-content: center;
            padding: 20px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            padding: 30px 20px; border-radius: 30px;
            text-align: center; width: 100%; max-width: 340px;
            transform: translateZ(0);
            animation: floatUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .glass-input {
            background: rgba(255,255,255,0.8);
            border: 2px solid transparent;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        .glass-input:focus { border-color: var(--primary); background: white; }

        @keyframes floatUp {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* --- ESTILOS EXPANDIDOS PARA O TUTORIAL --- */
        .tutorial-list {
            text-align: left;
            padding-left: 0;
            list-style: none;
            margin: 10px 0;
        }
        .tutorial-list h4 {
            margin: 20px 0 8px;
            color: var(--primary);
            font-size: 0.95rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 5px;
        }
        .tutorial-list h4:first-of-type {
            margin-top: 5px;
        }
        .tutorial-list ul {
            padding-left: 20px;
            margin: 0 0 5px 0;
            list-style: none;
        }
        .tutorial-list li {
            margin-bottom: 10px;
            font-size: 0.8rem;
            color: #4b5563;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            line-height: 1.4;
        }
        .tutorial-list li i {
            color: var(--primary);
            margin-top: 2px;
            min-width: 18px;
            text-align: center;
        }
        .tutorial-list li div {
            flex: 1;
        }
        
        .chart-container { 
            position: relative; 
            height: 250px; 
            margin-bottom: 20px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 15px;
            font-size: 0.75rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header class="gpu-accelerated">
        <div class="header-content">
            <div class="app-title" style="font-weight: 800; font-size: 1.2rem;">üí∏ Pobre 3.1</div>
            <div id="user-greeting" class="user-greeting"></div>
        </div>
        <div id="status-tag"><i class="fas fa-piggy-bank"></i></div>
    </header>

    <div class="dashboard">
        <div class="dash-card">
            <small>Saldo Geral</small>
            <b id="dash-saldo">R$ 0,00</b>
        </div>
        <div class="dash-card">
            <small>Gastos (M√™s)</small>
            <b id="dash-gastos-mes" style="color: var(--expense)">R$ 0,00</b>
        </div>
    </div>

    <div id="welcome-modal" class="modal-overlay">
        <div class="glass-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">üëã</div>
            <h2 style="color: var(--primary); margin: 0 0 10px;">Bem-vindo(a)!</h2>
            <p style="color: #4b5563; font-size: 0.9rem; margin-bottom: 20px;">
                Para personalizar seus backups e relat√≥rios, como voc√™ quer ser chamado?
            </p>
            <input type="text" id="user-name-input" class="glass-input" placeholder="Ex: Gabriel, Casa, Loja...">
            <button class="btn-primary" onclick="salvarUsuario()">Come√ßar</button>
        </div>
    </div>

    <div id="tutorial-modal" class="modal-overlay">
        <div class="glass-card" style="max-height: 85vh; overflow-y: auto; padding: 25px 20px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: var(--primary); margin: 0; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-book-open"></i> Guia Completo
                </h3>
                <i class="fas fa-times" onclick="closeTutorialModal()" style="font-size: 1.5rem; color: #9ca3af; cursor: pointer;"></i>
            </div>
            
            <div class="tutorial-list">
                <h4><i class="fas fa-arrow-up"></i> Registrar Receitas</h4>
                <ul>
                    <li><i class="fas fa-pencil-alt"></i> <div><b>Aba "Ganhar":</b> preencha descri√ß√£o, categoria, valor e data.</div></li>
                    <li><i class="fas fa-tags"></i> <div><b>Categorias dispon√≠veis:</b> Sal√°rio, Investimentos, Outros.</div></li>
                    <li><i class="fas fa-check-circle"></i> <div>Clique em <strong>"Salvar Receita"</strong>.</div></li>
                </ul>
                
                <h4><i class="fas fa-arrow-down"></i> Registrar Despesas</h4>
                <ul>
                    <li><i class="fas fa-pencil-alt"></i> <div><b>Aba "Gastar":</b> descri√ß√£o, categoria, valor e data.</div></li>
                    <li><i class="fas fa-tags"></i> <div><b>Categorias (8 op√ß√µes):</b> Alimenta√ß√£o, Transporte, Lazer, Contas, Moradia, Sa√∫de, Educa√ß√£o, Compras.</div></li>
                    <li><i class="fas fa-check-circle"></i> <div>Clique em <strong>"Confirmar Gasto"</strong>.</div></li>
                </ul>
                
                <h4><i class="fas fa-pen"></i> Editar e Excluir Lan√ßamentos</h4>
                <ul>
                    <li><i class="fas fa-mouse-pointer"></i> <div>Na aba <strong>"An√°lise"</strong>, clique sobre qualquer item do extrato.</div></li>
                    <li><i class="fas fa-sync-alt"></i> <div>O formul√°rio ser√° preenchido para edi√ß√£o ‚Äì altere e clique em <strong>"Atualizar"</strong>.</div></li>
                    <li><i class="fas fa-trash"></i> <div>O bot√£o <strong>"Excluir"</strong> aparece ao editar; confirme a remo√ß√£o.</div></li>
                    <li><i class="fas fa-undo-alt"></i> <div>Use o bot√£o <strong>"Voltar"</strong> para cancelar a edi√ß√£o.</div></li>
                </ul>
                
                <h4><i class="fas fa-chart-pie"></i> An√°lise e Relat√≥rios</h4>
                <ul>
                    <li><i class="fas fa-tachometer-alt"></i> <div><b>Dashboard:</b> saldo geral e gastos do m√™s no topo da tela.</div></li>
                    <li><i class="fas fa-filter"></i> <div><b>Filtro de m√™s:</b> selecione o per√≠odo no topo da aba "An√°lise".</div></li>
                    <li><i class="fas fa-chart-pie"></i> <div><b>Gr√°fico de pizza:</b> gastos por categoria no m√™s filtrado.</div></li>
                    <li><i class="fas fa-chart-line"></i> <div><b>Gr√°fico de barras:</b> evolu√ß√£o mensal (receitas vs despesas) dos √∫ltimos 6 meses.</div></li>
                    <li><i class="fas fa-list-ul"></i> <div><b>Extrato:</b> todos os lan√ßamentos do m√™s, com √≠cones de edi√ß√£o.</div></li>
                    <li><i class="fas fa-file-pdf"></i> <div><b>Exportar PDF:</b> gera um relat√≥rio profissional com resumo, tabelas e categorias.</div></li>
                </ul>
                
                <h4><i class="fas fa-database"></i> Backup e Seguran√ßa</h4>
                <ul>
                    <li><i class="fas fa-download"></i> <div><b>Backup:</b> exporta um arquivo .json com todos os seus dados (armazenado onde quiser).</div></li>
                    <li><i class="fas fa-upload"></i> <div><b>Restaurar:</b> importe um backup pr√©vio para recuperar os dados.</div></li>
                    <li><i class="fas fa-trash-alt"></i> <div><b>Limpar Dados:</b> remove permanentemente todas as informa√ß√µes.</div></li>
                    <li><i class="fas fa-lock"></i> <div><b>Privacidade radical:</b> seus dados NUNCA saem do seu celular (IndexedDB local).</div></li>
                </ul>
                
                <h4><i class="fas fa-microchip"></i> Recursos Avan√ßados</h4>
                <ul>
                    <li><i class="fas fa-mobile-alt"></i> <div><b>Instale como App (PWA):</b> no Chrome, use "Adicionar √† tela inicial".</div></li>
                    <li><i class="fas fa-wifi-slash"></i> <div><b>Funciona offline:</b> use no avi√£o, no s√≠tio, sem internet.</div></li>
                    <li><i class="fas fa-tachometer-alt"></i> <div><b>Acelera√ß√£o GPU:</b> anima√ß√µes suaves (60fps) e economia de bateria.</div></li>
                    <li><i class="fas fa-user-secret"></i> <div><b>Sem rastreadores:</b> zero trackers, zero an√∫ncios, zero servidores.</div></li>
                </ul>
                
                <h4><i class="fas fa-heart"></i> Apoie o Desenvolvimento</h4>
                <ul>
                    <li><i class="fas fa-qrcode"></i> <div><b>PIX:</b> QR Code dispon√≠vel na aba "Apoie".</div></li>
                    <li><i class="fas fa-credit-card"></i> <div><b>Mercado Pago:</b> bot√£o para doa√ß√£o via cart√£o ou boleto.</div></li>
                    <li><i class="fab fa-whatsapp"></i> <div><b>Contato:</b> fale direto com o desenvolvedor pelo WhatsApp.</div></li>
                    <li><i class="fas fa-book-reader"></i> <div><b>Tutorial:</b> este guia est√° sempre dispon√≠vel no bot√£o "Tutorial" da aba Apoie.</div></li>
                </ul>
            </div>
            
            <button class="btn-primary" onclick="closeTutorialModal()" style="margin-top: 20px; width: 100%;">
                <i class="fas fa-check"></i> Entendi, vamos l√°!
            </button>
        </div>
    </div>

    <div id="pix-modal" class="modal-overlay">
        <div class="glass-card">
            <h3 style="color: var(--primary); margin-top: 0;">Ajude com um caf√© ao dev ‚òï</h3>
            <div style="background: white; padding: 15px; border-radius: 15px; display: inline-block; margin: 10px 0;">
                <img src="qrcode.png" alt="QR Code PIX" style="width: 200px; height: 200px; object-fit: contain; display: block;" onerror="this.src='https://placehold.co/200x200?text=QR+Code+Ausente'">
            </div>
            <p style="font-size: 0.85rem; color: #4b5563; margin-bottom: 20px; line-height: 1.5;">
                Seu apoio mant√©m as atualiza√ß√µes gratuitas!<br>
                <b>Scaneie e ajude com um pix.</b>
            </p>
            <button class="btn-primary" onclick="closePixModal()" style="background: #374151;">
                <i class="fas fa-times"></i> Fechar a janela
            </button>
        </div>
    </div>

    <div class="container">
        <div id="v-receita" class="view active">
            <div class="card">
                <h3 id="titulo-receita"><i class="fas fa-plus"></i> Nova Receita</h3>
                <input type="hidden" id="receita-id">
                <input type="text" id="descricao-receita" placeholder="Ex: Sal√°rio Freelance">
                <div class="category-selector" id="categoria-receita-selector">
                    <div class="category-option selected" data-category="salario" onclick="selectCategory('receita', 'salario')">üíº<br>Sal√°rio</div>
                    <div class="category-option" data-category="investimentos" onclick="selectCategory('receita', 'investimentos')">üìà<br>Invest.</div>
                    <div class="category-option" data-category="outros" onclick="selectCategory('receita', 'outros')">üéÅ<br>Outros</div>
                </div>
                <input type="hidden" id="categoria-receita" value="salario">
                <input type="number" id="valor-receita" placeholder="Valor R$" step="0.01">
                <input type="date" id="data-receita">
                <button id="btn-salvar-receita" class="btn-income" onclick="salvar('receita')"><i class="fas fa-check"></i> Salvar Receita</button>
                <button id="del-receita" class="btn-delete" style="display:none;" onclick="deletarRegistro('receita')"><i class="fas fa-trash"></i> Excluir</button>
                <button id="btn-cancel-receita" class="btn-sec" style="display:none;" onclick="cancelarEdicao('receitas')">Voltar</button>
            </div>
        </div>

        <div id="v-despesa" class="view">
            <div class="card">
                <h3 id="titulo-despesa"><i class="fas fa-minus"></i> Novo Gasto</h3>
                <input type="hidden" id="despesa-id">
                <input type="text" id="descricao-despesa" placeholder="Onde voc√™ gastou?">
                <div class="category-selector" id="categoria-despesa-selector">
                    <div class="category-option selected" data-category="alimentacao" onclick="selectCategory('despesa', 'alimentacao')">üçï<br>Comida</div>
                    <div class="category-option" data-category="transporte" onclick="selectCategory('despesa', 'transporte')">üöó<br>Transporte</div>
                    <div class="category-option" data-category="lazer" onclick="selectCategory('despesa', 'lazer')">üçø<br>Lazer</div>
                    <div class="category-option" data-category="contas" onclick="selectCategory('despesa', 'contas')">üßæ<br>Contas</div>
                    <div class="category-option" data-category="moradia" onclick="selectCategory('despesa', 'moradia')">üè†<br>Moradia</div>
                    <div class="category-option" data-category="saude" onclick="selectCategory('despesa', 'saude')">üíä<br>Sa√∫de</div>
                    <div class="category-option" data-category="educacao" onclick="selectCategory('despesa', 'educacao')">üìö<br>Educa√ß√£o</div>
                    <div class="category-option" data-category="compras" onclick="selectCategory('despesa', 'compras')">üõí<br>Compras</div>
                </div>
                <input type="hidden" id="categoria-despesa" value="alimentacao">
                <input type="number" id="valor-despesa" placeholder="Valor R$" step="0.01">
                <input type="date" id="data-despesa">
                <button id="btn-salvar-despesa" class="btn-expense" onclick="salvar('despesa')"><i class="fas fa-money-bill-wave"></i> Confirmar Gasto</button>
                <button id="del-despesa" class="btn-delete" style="display:none;" onclick="deletarRegistro('despesa')"><i class="fas fa-trash"></i> Excluir Registro</button>
                <button id="btn-cancel-despesa" class="btn-sec" style="display:none;" onclick="cancelarEdicao('despesas')">Voltar</button>
            </div>
        </div>

        <div id="v-consulta" class="view">
            <div class="card">
                <h3><i class="fas fa-chart-pie"></i> Gastos por Categoria</h3>
                <select id="filtroMes" onchange="render()"></select>
                <div class="chart-container">
                    <canvas id="graficoPizza"></canvas>
                </div>
                <div id="categoria-legend" class="legend"></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-chart-line"></i> Evolu√ß√£o Mensal (Receitas vs Despesas)</h3>
                <div class="chart-container">
                    <canvas id="graficoMensal"></canvas>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-history"></i> Extrato</h3>
                <div id="lista-detalhada"></div>
            </div>

            <div class="card" style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-sec" onclick="gerarRelatorioPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF Completo</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-sec" onclick="exportarBackup()"><i class="fas fa-download"></i> Backup</button>
                    <button class="btn-sec" onclick="document.getElementById('restore-file').click()"><i class="fas fa-upload"></i> Restaurar</button>
                    <input type="file" id="restore-file" style="display:none" accept=".json" onchange="restaurarBackup(this)">
                </div>
                <button onclick="confirmarLimpeza()" style="color: var(--expense); background: #fee2e2;"><i class="fas fa-trash-alt"></i> Limpar Dados</button>
            </div>
        </div>

        <div id="v-apoie" class="view">
            <div class="card">
                <h3><i class="fas fa-hand-holding-heart" style="color: #e11d48;"></i> Por que apoiar?</h3>
                
                <div class="info-section">
                    <p>O <b>Pobre 3.1</b> n√£o √© apenas um app de finan√ßas. √â um manifesto de <b>Engenharia de Software √âtica</b>. Veja o que torna este aplicativo √∫nico:</p>
                    
                    <h4><i class="fas fa-user-shield"></i> Privacidade Radical (Client-Side)</h4>
                    <p>A maioria dos apps envia seus gastos para "a nuvem" (servidores), onde seus dados podem ser analisados ou vazados. Aqui, usamos tecnologia <b>IndexedDB</b> criptografada. Isso significa que seus dados financeiros <b>nunca saem do seu aparelho</b>. N√≥s literalmente <i>n√£o conseguimos</i> ver o que voc√™ gasta.</p>

                    <h4><i class="fas fa-tachometer-alt"></i> Performance Extrema</h4>
                    <p>Cansado de apps que travam ou aquecem o celular? O Pobre 3.1 utiliza <b>Acelera√ß√£o de Hardware (GPU)</b> para renderizar as telas. Isso garante anima√ß√µes fluidas (60fps) e economiza sua bateria, rodando liso at√© em celulares mais antigos ou modestos.</p>

                    <h4><i class="fas fa-wifi"></i> Soberania Digital (Offline)</h4>
                    <p>Voc√™ n√£o precisa de internet para controlar seu dinheiro. Gra√ßas √† tecnologia <b>PWA Offline-First</b>, o app funciona no modo avi√£o, no metr√¥ ou no s√≠tio. Voc√™ √© o √∫nico dono do seu backup (JSON).</p>
                    
                    <div class="privacy-box" style="background: #fff1f2; border-color: #e11d48; color: #9f1239;">
                        <p><i class="fas fa-mug-hot"></i> <b>Mantido por Doa√ß√µes</b><br>
                        Este software √© livre de mensalidades, livre de an√∫ncios chatos e livre de rastreadores espi√µes. Desenvolver tecnologia independente, segura e de alta performance consome centenas de horas.
                        <br><br>
                        Se este app te ajuda a economizar, considere me pagar um caf√©. Isso mant√©m as atualiza√ß√µes vivas!</p>
                    </div>
                </div>
        
                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 15px;">
                    <button class="btn-tutorial" onclick="openTutorialModal()">
                        <i class="fas fa-book-reader"></i> Tutorial: Como usar o App
                    </button>

                    <button class="btn-pix" onclick="openPixModal()">
                        <i class="fas fa-qrcode"></i> Apoiar via PIX (QR Code)
                    </button>

                    <button class="btn-mp" onclick="window.open('https://link.mercadopago.com.br/cuecasa', '_blank')">
                        <i class="fas fa-credit-card"></i> Apoiar via Cart√£o/MP
                    </button>
                    <button class="btn-wpp" onclick="window.open('https://wa.me/5547996249149', '_blank')">
                        <i class="fab fa-whatsapp"></i> Contato do Desenvolvedor
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 20px; color: #9ca3af; font-size: 0.7rem;">
                    Vers√£o 3.1 Pro ‚Ä¢ Build 2023.10<br>Feito com √≥dio aos juros abusivos.
                </div>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-buttons">
            <div class="tab active" onclick="navTo('v-receita',this)"><i class="fas fa-arrow-up"></i><span>Ganhar</span></div>
            <div class="tab" onclick="navTo('v-despesa',this)"><i class="fas fa-arrow-down"></i><span>Gastar</span></div>
            <div class="tab" onclick="navTo('v-consulta',this)"><i class="fas fa-chart-bar"></i><span>An√°lise</span></div>
            <div class="tab" onclick="navTo('v-apoie',this)"><i class="fas fa-heart"></i><span>Apoie</span></div>
        </div>
    </nav>

    <div id="toast">Mensagem</div>

    <script>
        // ==================== CONFIGURA√á√ÉO INICIAL ====================
        const channel = new BroadcastChannel('pobre_3_1_auth');
        channel.postMessage('ping');
        channel.onmessage = (event) => {
            if (event.data === 'ping') channel.postMessage('pong');
            else if (event.data === 'pong') {
                document.body.innerHTML = '<div style="display:flex;height:100vh;align-items:center;justify-content:center;"><h1>‚ö†Ô∏è App j√° aberto</h1></div>';
                window.stop();
            }
        };

        if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {}));

        let db;
        let chartInstancePie;
        let chartInstanceMonthly;
        const FORMAT_BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

        const CATEGORIES = {
            receita: { salario: "Sal√°rio", investimentos: "Investimentos", outros: "Outros" },
            despesa: { 
                alimentacao: "Alimenta√ß√£o", 
                transporte: "Transporte", 
                lazer: "Lazer", 
                contas: "Contas",
                moradia: "Moradia",
                saude: "Sa√∫de",
                educacao: "Educa√ß√£o",
                compras: "Compras"
            }
        };

        const CHART_COLORS = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#8b5cf6', '#14b8a6', '#f97316'];

        // ==================== SISTEMA DE USU√ÅRIO ====================
        function checkUser() {
            const user = localStorage.getItem('pobre_user_name');
            if (!user) {
                document.getElementById('welcome-modal').style.display = 'flex';
            } else {
                updateUserUI(user);
            }
        }

        function salvarUsuario() {
            const name = document.getElementById('user-name-input').value.trim();
            if (!name) return alert("Por favor, digite um nome.");
            localStorage.setItem('pobre_user_name', name);
            document.getElementById('welcome-modal').style.display = 'none';
            updateUserUI(name);
            showToast(`Bem-vindo, ${name}!`);
        }

        function updateUserUI(name) {
            const el = document.getElementById('user-greeting');
            el.innerText = `Ol√°, ${name}`;
            el.style.display = 'block';
        }

        function getUserName() {
            return localStorage.getItem('pobre_user_name') || "Usu√°rio";
        }
        
        function getSafeFileName() {
            return getUserName().replace(/[^a-z0-9]/gi, '_');
        }

        // ==================== MODAIS ====================
        function openPixModal() { document.getElementById('pix-modal').style.display = 'flex'; }
        function closePixModal() { document.getElementById('pix-modal').style.display = 'none'; }
        function openTutorialModal() { document.getElementById('tutorial-modal').style.display = 'flex'; }
        function closeTutorialModal() { document.getElementById('tutorial-modal').style.display = 'none'; }

        // ==================== UTILIT√ÅRIOS ====================
        function removerAcentos(str) {
            if (!str) return "";
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
        }

        // ==================== INDEXED DB ====================
        async function initDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open("GastosProDB", 3);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains("receitas")) db.createObjectStore("receitas", { keyPath: "id", autoIncrement: true });
                    if (!db.objectStoreNames.contains("despesas")) db.createObjectStore("despesas", { keyPath: "id", autoIncrement: true });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(); };
            });
        }

        async function getAll(storeName) {
            const tx = db.transaction(storeName, "readonly");
            return new Promise(r => { 
                const req = tx.objectStore(storeName).getAll();
                req.onsuccess = () => r(req.result || []);
            });
        }

        // ==================== CRUD ====================
        async function salvar(tipo) {
            const id = document.getElementById(`${tipo}-id`).value;
            const item = {
                descricao: document.getElementById(`descricao-${tipo}`).value,
                categoria: document.getElementById(`categoria-${tipo}`).value,
                valor: parseFloat(document.getElementById(`valor-${tipo}`).value),
                data: document.getElementById(`data-${tipo}`).value
            };
            if (!item.descricao || isNaN(item.valor) || !item.data) { showToast("Preencha tudo certinho!"); return; }
            if (id) item.id = parseInt(id);

            const storeName = tipo === 'receita' ? "receitas" : "despesas";
            const tx = db.transaction(storeName, "readwrite");
            tx.objectStore(storeName).put(item);
            tx.oncomplete = () => { showToast(id ? "Atualizado!" : "Salvo!"); cancelarEdicao(storeName); render(); };
        }

        async function deletarRegistro(tipo) {
            const id = parseInt(document.getElementById(`${tipo}-id`).value);
            if (!id || !confirm("Quer apagar mesmo?")) return;
            const storeName = tipo === 'receita' ? "receitas" : "despesas";
            const tx = db.transaction(storeName, "readwrite");
            tx.objectStore(storeName).delete(id);
            tx.oncomplete = () => { showToast("Removido."); cancelarEdicao(storeName); render(); navTo('v-consulta', document.querySelectorAll('.tab')[2]); };
        }

        // ==================== EXPORTA√á√ÉO / IMPORTA√á√ÉO ====================
        async function exportarBackup() {
            const data = { receitas: await getAll("receitas"), despesas: await getAll("despesas") };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `backup_${getSafeFileName()}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        async function restaurarBackup(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm("Importar dados? Isso substituir√° todos os dados atuais.")) {
                        await db.transaction("receitas", "readwrite").objectStore("receitas").clear();
                        await db.transaction("despesas", "readwrite").objectStore("despesas").clear();
                        
                        const txR = db.transaction("receitas", "readwrite");
                        data.receitas.forEach(r => { delete r.id; txR.objectStore("receitas").add(r); });
                        const txD = db.transaction("despesas", "readwrite");
                        data.despesas.forEach(d => { delete d.id; txD.objectStore("despesas").add(d); });
                        showToast("Dados restaurados!"); render();
                    }
                } catch(err) { showToast("Erro no arquivo!"); }
            };
            reader.readAsText(file);
        }

        // ==================== PDF COMPLETO E PROFISSIONAL ====================
        async function gerarRelatorioPDF() {
            showToast("Gerando relat√≥rio completo...");
            const [receitas, despesas] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const mesSelecionado = document.getElementById('filtroMes')?.value || new Date().toISOString().substring(0, 7);

            const receitasMes = receitas.filter(r => r.data.startsWith(mesSelecionado));
            const despesasMes = despesas.filter(d => d.data.startsWith(mesSelecionado));

            const totalReceitas = receitasMes.reduce((s, i) => s + i.valor, 0);
            const totalDespesas = despesasMes.reduce((s, i) => s + i.valor, 0);
            const saldoMes = totalReceitas - totalDespesas;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 14;
            
            const safeText = (txt) => removerAcentos(txt);
            const fmtBRL = (val) => "R$ " + val.toFixed(2).replace('.', ',');

            // ----- CABE√áALHO -----
            doc.setFillColor(79, 70, 229);
            doc.rect(0, 0, pageWidth, 55, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", 'bold');
            doc.text(safeText("RELAT√ìRIO FINANCEIRO"), pageWidth/2, 22, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont("helvetica", 'normal');
            doc.text(safeText(`${getUserName()} ‚Ä¢ ${mesSelecionado.replace('-', '/')}`), pageWidth/2, 38, { align: 'center' });
            
            let yPos = 70;
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(9);
            doc.text(`Emiss√£o: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, margin, yPos);
            
            // ----- RESUMO (CARD) -----
            yPos += 10;
            doc.setFillColor(245, 247, 250);
            doc.roundedRect(margin, yPos, pageWidth - (margin*2), 35, 3, 3, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont("helvetica", 'bold');
            doc.text("RESUMO DO M√äS", margin + 5, yPos + 8);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", 'normal');
            doc.text("Receitas:", margin + 5, yPos + 20);
            doc.text(fmtBRL(totalReceitas), margin + 50, yPos + 20);
            doc.text("Despesas:", margin + 90, yPos + 20);
            doc.text(fmtBRL(totalDespesas), margin + 135, yPos + 20);
            doc.text("Saldo:", margin + 5, yPos + 30);
            doc.setTextColor(saldoMes >= 0 ? 5 : 220, saldoMes >= 0 ? 150 : 38, saldoMes >= 0 ? 105 : 38);
            doc.setFont("helvetica", 'bold');
            doc.text(fmtBRL(saldoMes), margin + 50, yPos + 30);
            
            yPos += 45;

            // ----- TABELA DE RECEITAS -----
            doc.setTextColor(5, 150, 105);
            doc.setFontSize(14);
            doc.setFont("helvetica", 'bold');
            doc.text("RECEITAS", margin, yPos);
            yPos += 5;
            
            const rowsReceitas = receitasMes.map(r => [
                r.data.split('-').reverse().join('/'),
                safeText(r.descricao),
                safeText(CATEGORIES.receita[r.categoria] || r.categoria),
                fmtBRL(r.valor)
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['Data', 'Descri√ß√£o', 'Categoria', 'Valor']],
                body: rowsReceitas.length ? rowsReceitas : [['-', 'Nenhuma receita', '-', '-']],
                theme: 'striped',
                headStyles: { fillColor: [5, 150, 105], textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: { 0: { cellWidth: 25 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 30 }, 3: { halign: 'right', cellWidth: 30 } },
                styles: { fontSize: 9, cellPadding: 3 },
                margin: { left: margin, right: margin }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;

            // ----- TABELA DE DESPESAS -----
            doc.setTextColor(220, 38, 38);
            doc.setFontSize(14);
            doc.setFont("helvetica", 'bold');
            doc.text("DESPESAS", margin, yPos);
            yPos += 5;
            
            const rowsDespesas = despesasMes.map(d => [
                d.data.split('-').reverse().join('/'),
                safeText(d.descricao),
                safeText(CATEGORIES.despesa[d.categoria] || d.categoria),
                fmtBRL(d.valor)
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['Data', 'Descri√ß√£o', 'Categoria', 'Valor']],
                body: rowsDespesas.length ? rowsDespesas : [['-', 'Nenhuma despesa', '-', '-']],
                theme: 'striped',
                headStyles: { fillColor: [220, 38, 38], textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: { 0: { cellWidth: 25 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 30 }, 3: { halign: 'right', cellWidth: 30 } },
                styles: { fontSize: 9, cellPadding: 3 },
                margin: { left: margin, right: margin }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;

            // ----- GASTOS POR CATEGORIA -----
            doc.setTextColor(79, 70, 229);
            doc.setFontSize(14);
            doc.setFont("helvetica", 'bold');
            doc.text("GASTOS POR CATEGORIA", margin, yPos);
            yPos += 5;
            
            const gastosCat = {};
            despesasMes.forEach(d => {
                const cat = CATEGORIES.despesa[d.categoria] || d.categoria;
                gastosCat[cat] = (gastosCat[cat] || 0) + d.valor;
            });
            
            const rowsCategoria = Object.entries(gastosCat)
                .sort((a,b) => b[1] - a[1])
                .map(([cat, val]) => [cat, fmtBRL(val)]);

            doc.autoTable({
                startY: yPos,
                head: [['Categoria', 'Total Gasto']],
                body: rowsCategoria.length ? rowsCategoria : [['Nenhum gasto', '-']],
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229], textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: { 0: { cellWidth: 'auto' }, 1: { halign: 'right', cellWidth: 40 } },
                styles: { fontSize: 10, cellPadding: 4 },
                margin: { left: margin, right: margin }
            });

            // ----- RODAP√â -----
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Pobre 3.1 Pro+ ‚Ä¢ Relat√≥rio gerado automaticamente", pageWidth/2, finalY, { align: 'center' });

            // ----- SALVAR PDF -----
            doc.save(`Relatorio_${getSafeFileName()}_${mesSelecionado}.pdf`);
            showToast("PDF completo salvo!");
        }

        // ==================== NAVEGA√á√ÉO ====================
        function navTo(id, el) {
            requestAnimationFrame(() => {
                document.querySelectorAll('.view, .tab').forEach(e => e.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                el.classList.add('active');
                if (id === 'v-consulta') {
                    popularFiltro();
                    render();
                }
            });
        }

        // ==================== CATEGORIAS ====================
        function selectCategory(tipo, cat) {
            document.querySelectorAll(`#categoria-${tipo}-selector .category-option`).forEach(e => e.classList.remove('selected'));
            const opt = document.querySelector(`#categoria-${tipo}-selector [data-category="${cat}"]`);
            if (opt) opt.classList.add('selected');
            document.getElementById(`categoria-${tipo}`).value = cat;
        }

        // ==================== EDI√á√ÉO ====================
        function openEdit(item) {
            const tipo = item.t;
            navTo(tipo === 'receita' ? 'v-receita' : 'v-despesa', document.querySelectorAll('.tab')[tipo === 'receita' ? 0 : 1]);
            
            document.getElementById(`${tipo}-id`).value = item.id;
            document.getElementById(`descricao-${tipo}`).value = item.descricao;
            document.getElementById(`valor-${tipo}`).value = item.valor;
            document.getElementById(`data-${tipo}`).value = item.data;
            selectCategory(tipo, item.categoria);
            
            document.getElementById(`del-${tipo}`).style.display = "block";
            document.getElementById(`btn-cancel-${tipo}`).style.display = "block";
            
            const btnSalvar = document.getElementById(`btn-salvar-${tipo}`);
            if(btnSalvar) btnSalvar.innerHTML = `<i class="fas fa-sync-alt"></i> Atualizar ${tipo === 'receita' ? 'Receita' : 'Gasto'}`;
            
            const titulo = document.getElementById(`titulo-${tipo}`);
            if(titulo) titulo.innerHTML = `<i class="fas fa-pen"></i> Editando ${tipo === 'receita' ? 'Receita' : 'Gasto'}`;
        }

        function cancelarEdicao(store) {
            const tipo = store === 'receitas' ? 'receita' : 'despesa';
            document.getElementById(`${tipo}-id`).value = "";
            document.getElementById(`descricao-${tipo}`).value = "";
            document.getElementById(`valor-${tipo}`).value = "";
            document.getElementById(`data-${tipo}`).value = new Date().toISOString().split('T')[0];
            document.getElementById(`del-${tipo}`).style.display = "none";
            document.getElementById(`btn-cancel-${tipo}`).style.display = "none";
            
            const btnSalvar = document.getElementById(`btn-salvar-${tipo}`);
            if(btnSalvar) {
                if(tipo === 'receita') btnSalvar.innerHTML = `<i class="fas fa-check"></i> Salvar Receita`;
                else btnSalvar.innerHTML = `<i class="fas fa-money-bill-wave"></i> Confirmar Gasto`;
            }
            const titulo = document.getElementById(`titulo-${tipo}`);
            if(titulo) {
                if(tipo === 'receita') titulo.innerHTML = `<i class="fas fa-plus"></i> Nova Receita`;
                else titulo.innerHTML = `<i class="fas fa-minus"></i> Novo Gasto`;
            }
        }

        // ==================== RENDERIZA√á√ÉO PRINCIPAL ====================
        async function render() {
            if (!db) return;
            const [r, d] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            
            const mesAtual = new Date().toISOString().substring(0, 7);
            const filtro = (document.getElementById('filtroMes') && document.getElementById('filtroMes').value) || mesAtual;
            
            const totalR = r.reduce((s, i) => s + i.valor, 0);
            const totalD = d.reduce((s, i) => s + i.valor, 0);
            document.getElementById('dash-saldo').innerText = FORMAT_BRL.format(totalR - totalD);
            
            const gastosMes = d.filter(i => i.data.startsWith(filtro)).reduce((s, i) => s + i.valor, 0);
            document.getElementById('dash-gastos-mes').innerText = FORMAT_BRL.format(gastosMes);
            
            // Lista detalhada
            const listCont = document.getElementById('lista-detalhada');
            listCont.innerHTML = "";
            
            const receitasMes = r.filter(i => i.data.startsWith(filtro));
            const despesasMes = d.filter(i => i.data.startsWith(filtro));
            
            const fragment = document.createDocumentFragment();
            [...receitasMes.map(x => ({...x, t:'receita'})), ...despesasMes.map(x => ({...x, t:'despesa'}))]
                .sort((a,b) => b.data.localeCompare(a.data))
                .forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'item';
                    el.onclick = () => openEdit(item);
                    el.innerHTML = `
                        <div style="flex: 1;">
                            <b style="font-size: 0.95rem;">${item.descricao}</b>
                            <br>
                            <small style="color: #6b7280; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; margin-top: 4px;">
                                <i class="far fa-calendar"></i> ${item.data.split('-').reverse().join('/')} 
                                <span style="background: #e0e7ff; color: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: 600; font-size: 0.65rem;">
                                    <i class="fas fa-pen"></i> Editar
                                </span>
                            </small>
                        </div>
                        <div style="font-weight: 700; font-size: 0.95rem; color:${item.t === 'receita' ? 'var(--income)' : 'var(--expense)'}">
                            ${item.t === 'receita' ? '+' : '-'} ${FORMAT_BRL.format(item.valor)}
                        </div>`;
                    fragment.appendChild(el);
                });
            
            if(fragment.childElementCount === 0) {
                listCont.innerHTML = '<div style="text-align:center; padding: 20px; color: #9ca3af;">Nenhum lan√ßamento neste m√™s.</div>';
            } else {
                listCont.appendChild(fragment);
            }
            
            // Atualiza gr√°ficos
            updateChart(despesasMes);
            updateMonthlyChart(r, d);
        }

        // ==================== GR√ÅFICO DE PIZZA ====================
        function updateChart(dados) {
            const ctx = document.getElementById('graficoPizza').getContext('2d');
            if (chartInstancePie) chartInstancePie.destroy();
            
            const cats = {};
            dados.forEach(d => cats[d.categoria] = (cats[d.categoria] || 0) + d.valor);
            
            const labels = Object.keys(cats).map(k => CATEGORIES.despesa[k] || k);
            const values = Object.values(cats);
            
            const legendDiv = document.getElementById('categoria-legend');
            legendDiv.innerHTML = '';
            labels.forEach((label, i) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<span class="legend-color" style="background: ${CHART_COLORS[i % CHART_COLORS.length]}"></span> ${label} (${FORMAT_BRL.format(values[i])})`;
                legendDiv.appendChild(item);
            });
            
            chartInstancePie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: CHART_COLORS.slice(0, labels.length),
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.label}: ${FORMAT_BRL.format(ctx.raw)}`
                            }
                        }
                    }
                }
            });
        }

        // ==================== GR√ÅFICO MENSAL ====================
        function updateMonthlyChart(receitas, despesas) {
            const ctx = document.getElementById('graficoMensal').getContext('2d');
            if (chartInstanceMonthly) chartInstanceMonthly.destroy();
            
            const hoje = new Date();
            const meses = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                meses.push(d.toISOString().substring(0, 7));
            }
            
            const receitasPorMes = meses.map(m => 
                receitas.filter(r => r.data.startsWith(m)).reduce((s, i) => s + i.valor, 0)
            );
            const despesasPorMes = meses.map(m => 
                despesas.filter(d => d.data.startsWith(m)).reduce((s, i) => s + i.valor, 0)
            );
            
            const labels = meses.map(m => {
                const [ano, mes] = m.split('-');
                return `${mes}/${ano.substring(2)}`;
            });
            
            chartInstanceMonthly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Receitas',
                            data: receitasPorMes,
                            backgroundColor: 'rgba(5, 150, 105, 0.7)',
                            borderColor: '#059669',
                            borderWidth: 1,
                            borderRadius: 6
                        },
                        {
                            label: 'Despesas',
                            data: despesasPorMes,
                            backgroundColor: 'rgba(220, 38, 38, 0.7)',
                            borderColor: '#dc2626',
                            borderWidth: 1,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${FORMAT_BRL.format(ctx.raw)}`
                            }
                        },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'R$ ' + value.toFixed(0)
                            }
                        }
                    }
                }
            });
        }

        // ==================== FILTRO DE M√äS ====================
        function popularFiltro() {
            const sel = document.getElementById('filtroMes');
            if (!sel) return;
            if (sel.options.length === 0) {
                const hoje = new Date();
                for(let i=0; i<6; i++) {
                    const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    const val = d.toISOString().substring(0, 7);
                    sel.add(new Option(d.toLocaleDateString('pt-BR', {month:'long', year:'numeric'}), val));
                }
            }
        }

        // ==================== TOAST ====================
        function showToast(m) {
            const t = document.getElementById("toast");
            t.innerText = m; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        function confirmarLimpeza() {
            if(confirm("‚ö†Ô∏è Isso apagar√° TODOS os dados permanentemente. Continuar?")) {
                db.transaction("receitas", "readwrite").objectStore("receitas").clear();
                db.transaction("despesas", "readwrite").objectStore("despesas").clear();
                showToast("Todos os dados foram limpos!");
                render();
            }
        }

        function copiarPix() {
            navigator.clipboard.writeText("Aquinogabriel@outlook.com").then(() => showToast("Chave PIX copiada!"));
        }

        // ==================== UX/UI: CORRE√á√ÉO DE TECLADO ====================
        // Adiciona listeners para inputs assim que o DOM carregar
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('input, select, textarea');

            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    // 1. Esconde o menu inferior
                    document.body.classList.add('keyboard-active');

                    // 2. Centraliza o campo (com pequeno delay para o teclado subir)
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });

                input.addEventListener('blur', () => {
                    // Mostra o menu novamente
                    setTimeout(() => {
                        document.body.classList.remove('keyboard-active');
                    }, 100);
                });
            });
        });

        // ==================== INICIALIZA√á√ÉO ====================
        window.onload = async () => {
            await initDB();
            checkUser();
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('data-receita').value = hoje;
            document.getElementById('data-despesa').value = hoje;
            popularFiltro();
            render();
        };
    </script>
</body>
</html>
