
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>O app do Pobre</title>
    
    <link rel="icon" href="logo.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="logo.jpg">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f2f2f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            /* Palette Dark (Padr√£o) */
            --primary: #5e5ce6;
            --primary-glow: rgba(94, 92, 230, 0.5);
            --income: #30d158;
            --expense: #ff453a;
            --whatsapp: #25D366;
            
            --bg-base: #000000;
            --text-main: #f5f5f7;
            --text-sec: #8e8e93;
            
            --glass-surface: rgba(28, 28, 30, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            
            --radius-card: 24px;
        }

        /* --- PALETAS DE CORES --- */
        body.palette-default { --primary: #5e5ce6; --primary-glow: rgba(94, 92, 230, 0.5); }
        body.palette-nature { --primary: #10b981; --primary-glow: rgba(16, 185, 129, 0.5); }
        body.palette-ocean { --primary: #0ea5e9; --primary-glow: rgba(14, 165, 233, 0.5); }
        body.palette-solar { --primary: #f59e0b; --primary-glow: rgba(245, 158, 11, 0.5); }
        body.palette-berry { --primary: #ec4899; --primary-glow: rgba(236, 72, 153, 0.5); }
        body.palette-minimal { --primary: #64748b; --primary-glow: rgba(100, 116, 139, 0.5); }

        /* TEMA CLARO */
        body.light-theme {
            --bg-base: #f2f2f7;
            --text-main: #111113;
            --text-sec: #58585e;
            
            --glass-surface: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(0, 0, 0, 0.08);
            --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            /* Gradiente din√¢mico via JS */
            background-color: var(--bg-base);
            background-attachment: fixed;
            margin: 0; padding-top: 65px; padding-bottom: 120px;
            color: var(--text-main);
            transition: background 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
        }

        /* --- HEADER & TERM√îMETRO --- */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: var(--glass-surface);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            z-index: 1000; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; border-bottom: 1px solid var(--glass-border);
            transition: background 0.5s ease, border-color 0.5s ease;
        }
        
        header.header-pos {
            background: linear-gradient(90deg, rgba(59,130,246,0.15), rgba(48,209,88,0.15));
            border-bottom: 1px solid rgba(48, 209, 88, 0.3);
        }
        header.header-neg {
            background: linear-gradient(90deg, rgba(239,68,68,0.15), rgba(255,69,58,0.15));
            border-bottom: 1px solid rgba(255, 69, 58, 0.3);
        }

        .user-area { display: flex; flex-direction: column; justify-content: center; }
        .user-greeting { font-size: 0.7rem; color: var(--text-sec); font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .user-name { font-size: 0.85rem; font-weight: 800; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; }

        #header-title {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-weight: 700; font-size: 0.95rem; color: var(--text-main);
            opacity: 0; animation: fadeIn 0.3s forwards; pointer-events: none;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .status-badge {
            font-size: 0.65rem; font-weight: 800; padding: 1px 5px; border-radius: 4px;
            animation: pulse-status 2s infinite ease-in-out;
        }
        .status-pos { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59,130,246,0.3); }
        .status-neg { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
        @keyframes pulse-status { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        /* --- UI CARDS --- */
        .container { padding: 0 16px; max-width: 600px; margin: 0 auto; }

        .card {
            background: var(--glass-surface); border-radius: var(--radius-card);
            border: 1px solid var(--glass-border); padding: 24px 20px; margin-bottom: 16px;
            box-shadow: var(--card-shadow); backdrop-filter: blur(30px);
        }

        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .dash-card { 
            background: var(--glass-surface); border-radius: 20px; padding: 18px 10px; 
            text-align: center; border: 1px solid var(--glass-border); 
            box-shadow: var(--card-shadow);
        }
        .dash-card small { color: var(--text-sec); font-size: 0.65rem; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; display: block; }
        .dash-card b { font-size: 1.1rem; letter-spacing: -0.5px; }

        label { font-size: 0.75rem; font-weight: 700; color: var(--text-sec); margin: 0 0 6px 4px; display: block; }
        
        input, select {
            width: 100%; padding: 16px; border-radius: 16px; 
            border: 1px solid rgba(120, 120, 128, 0.1);
            background: rgba(120, 120, 128, 0.08); 
            color: var(--text-main); font-size: 1rem; outline: none; margin-bottom: 16px;
            transition: all 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); background: rgba(120, 120, 128, 0.12); }
        
        button {
            width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.95rem; transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.98); }
        
        .btn-income { background: var(--income); color: #fff; }
        .btn-expense { background: var(--expense); color: #fff; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-whatsapp { background: var(--whatsapp); color: #fff; margin-top: 10px; }
        .btn-offline { background: #333; color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        body.light-theme .btn-offline { background: #e5e5ea; color: #000; border: 1px solid rgba(0,0,0,0.1); }
        .btn-sec { background: rgba(120, 120, 128, 0.15); color: var(--text-main); }
        .btn-danger { background: rgba(255, 69, 58, 0.15); color: #ff453a; border: 1px solid rgba(255,69,58,0.3); }
        
        .btn-icon { background: rgba(120,120,128,0.1); color: var(--text-sec); width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-size: 0.9rem; margin:0; padding: 0;}
        .btn-icon.edit { color: var(--primary); }
        .btn-icon.del { color: var(--expense); background: rgba(255, 69, 58, 0.1); }
        
        /* Charts Container */
        .chart-container { position: relative; height: 200px; width: 100%; margin-bottom: 20px; }
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 500px) { .chart-grid { grid-template-columns: 1fr 1fr; } }
        
        /* Empty State GIF */
        .empty-state { text-align: center; padding: 20px; opacity: 0.7; }
        .empty-state img { max-width: 150px; border-radius: 15px; mix-blend-mode: luminosity; }
        .empty-state p { margin-top: 10px; font-size: 0.8rem; color: var(--text-sec); }

        /* Footer Style */
        .app-footer {
            margin-top: 30px; border-top: 1px solid var(--glass-border); padding-top: 20px;
            text-align: center; color: var(--text-sec); font-size: 0.7rem; line-height: 1.6;
        }
        .app-footer strong { color: var(--primary); }

        /* Smart Action Bar */
        .smart-action-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 12px 16px; background: var(--glass-surface);
            border-top: 1px solid var(--glass-border); backdrop-filter: blur(30px);
            z-index: 2000; transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; gap: 10px;
        }
        .smart-action-bar.visible { transform: translateY(0); }

        /* Tiers */
        .tiers-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
        @media (min-width: 480px) { .tiers-grid { grid-template-columns: 1fr 1fr; } }
        .tier-card { 
            background: var(--glass-surface); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 15px; position: relative;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .tier-qr { width: 120px; height: 120px; border-radius: 12px; margin-top: 10px; background: #fff; padding: 5px;}
        .badge-popular { 
            position: absolute; top: 0; right: 0; background: var(--income); color: white; 
            font-size: 0.6rem; padding: 4px 8px; border-bottom-left-radius: 10px; font-weight: 700;
        }

        /* Nav */
        nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px; height: 70px;
            background: var(--glass-surface); backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); border-radius: 35px;
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
            box-shadow: var(--card-shadow); transition: transform 0.3s;
        }
        nav.hidden { transform: translateY(150%); }
        .tab { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-sec); font-size: 0.65rem; opacity: 0.7; transition: 0.2s; }
        .tab.active { color: var(--primary); font-weight: 700; opacity: 1; transform: translateY(-2px); }
        .tab i { font-size: 1.3rem; }

        .view { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .view.active { display: block; opacity: 1; transform: translateY(0); }

        .item { display: flex; justify-content: space-between; align-items: center; padding: 16px 8px; border-bottom: 1px solid rgba(120,120,128,0.1); cursor: pointer; }
        .item-info { flex-grow: 1; }
        .item-actions { display: flex; gap: 10px; margin-left: 10px; }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000;
            display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--glass-surface); color: var(--text-main);
            width: 100%; max-width: 400px; border-radius: 30px; padding: 30px 25px;
            max-height: 85vh; overflow-y: auto; border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .guide-item { background: rgba(120, 120, 128, 0.05); border-radius: 16px; margin-bottom: 10px; border: 1px solid var(--glass-border); overflow: hidden; }
        .guide-header { padding: 15px; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .guide-content { padding: 0 15px 15px; font-size: 0.85rem; color: var(--text-sec); display: none; line-height: 1.6; border-top: 1px solid var(--glass-border); }
        .guide-item.active .guide-content { display: block; background: rgba(120, 120, 128, 0.03); }

        #toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 24px; border-radius: 50px; opacity: 0; z-index: 5000; transition: 0.3s; font-size: 0.85rem; font-weight: 600; pointer-events: none; white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .hidden { display: none !important; }
        
        /* Historico Mensal Table */
        .history-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(120,120,128,0.1); font-size: 0.9rem; }
        .hist-val { font-weight: 700; }
        .hist-pos { color: var(--income); }
        .hist-neg { color: var(--expense); }

        /* --- ESTILOS DO MODAL DE TEMA --- */
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; }
        .theme-option { 
            height: 50px; border-radius: 12px; cursor: pointer; 
            border: 2px solid transparent; background: rgba(120, 120, 128, 0.1);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .theme-option:hover { transform: scale(1.05); }
        .theme-option.selected { border-color: var(--text-main); }
        .theme-circle { width: 24px; height: 24px; border-radius: 50%; }

        .mode-switch { display: flex; background: rgba(120, 120, 128, 0.1); border-radius: 12px; padding: 4px; margin-bottom: 20px; }
        .mode-opt { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: var(--text-sec); transition: 0.2s; }
        .mode-opt.active { background: var(--glass-surface); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    
    <div id="blocker" class="modal-overlay" style="text-align: center; z-index: 9999; display: none;">
        <div class="modal-content">
            <div style="font-size: 3rem;">üõë</div>
            <h2 style="font-size: 1.3rem; margin: 10px 0;">Acesso Interrompido</h2>
            <p style="color: var(--text-sec); font-size: 0.9rem;">O app j√° est√° aberto em outra aba.<br>Use apenas uma para evitar conflitos.</p>
            <button class="btn-primary" onclick="tentarDesbloquear()" style="margin-top: 20px;">Tentar Novamente</button>
        </div>
    </div>

    <header id="main-header">
        <div class="user-area">
            <div class="user-greeting">Ol√°,</div>
            <div class="user-name" id="username-header">...</div>
        </div>
        <div id="header-title"></div> 
        <i class="fas fa-palette" onclick="openModal('modal-theme')" style="cursor: pointer; font-size: 1.2rem; color: var(--primary); padding: 10px;"></i>
    </header>

    <div class="container">
        
        <div id="dashboard-main" class="dashboard">
            <div class="dash-card">
                <small>Saldo Total</small>
                <b id="dash-saldo">R$ 0,00</b>
            </div>
            <div class="dash-card">
                <small>Sa√≠da (M√™s)</small>
                <b id="dash-gastos" style="color: var(--expense);">R$ 0,00</b>
            </div>
            <div class="dash-card">
                <small>Resultado M√©dio</small>
                <b id="dash-media" style="color: var(--primary);">R$ 0,00</b>
            </div>
        </div>

        <div id="v-ganhar" class="view active">
            <div class="card">
                <h3 id="form-title-ganhar" style="margin:0; color: var(--income); font-size: 1.1rem; margin-bottom: 20px;"><i class="fas fa-plus-circle"></i> Nova Receita</h3>
                <input type="hidden" id="edit-id-ganhar">
                
                <label>Descri√ß√£o</label>
                <input type="text" id="desc-ganhar" placeholder="Ex: Sal√°rio, Venda" autocomplete="off">
                
                <label>Valor (R$)</label>
                <input type="tel" id="val-ganhar" inputmode="numeric" placeholder="0,00">
                
                <label>Data</label>
                <input type="date" id="data-ganhar">
                
                <div style="height: 10px;"></div>
                <button id="btn-save-ganhar" class="btn-income" onclick="salvar('ganhar')">Salvar Receita</button>
                <button id="btn-cancel-ganhar" class="btn-sec hidden" onclick="cancelarEdicao('ganhar')" style="margin-top:10px;">Cancelar</button>
            </div>
        </div>

        <div id="v-gastar" class="view">
            <div class="card">
                <h3 id="form-title-gastar" style="margin:0; color: var(--expense); font-size: 1.1rem; margin-bottom: 20px;"><i class="fas fa-minus-circle"></i> Novo Gasto</h3>
                <input type="hidden" id="edit-id-gastar">
                
                <label>Descri√ß√£o</label>
                <input type="text" id="desc-gastar" placeholder="Ex: Mercado, Luz" autocomplete="off">
                
                <label>Categoria</label>
                <select id="cat-gastar">
                    <option value="alimentacao">üçï Alimenta√ß√£o</option>
                    <option value="transporte">üöó Transporte</option>
                    <option value="lazer">üçø Lazer</option>
                    <option value="contas">üßæ Contas</option>
                    <option value="casa">üè† Casa</option>
                    <option value="saude">üíä Sa√∫de</option>
                    <option value="edu">üìö Educa√ß√£o</option>
                    <option value="outros">üõí Outros</option>
                </select>
                
                <label>Valor (R$)</label>
                <input type="tel" id="val-gastar" inputmode="numeric" placeholder="0,00">
                
                <label>Data</label>
                <input type="date" id="data-gastar">
                
                <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px; margin-top: 15px; cursor: pointer;">
                  <input type="checkbox" id="recorrente-gastar" style="width: 20px; margin: 0;">
                  <span style="font-weight: 600; font-size: 0.9rem;">Conta mensal fixa</span>
                </label>

                <div id="opcoes-recorrente" class="hidden" style="background: rgba(120,120,128,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                  <label>Dia fixo do m√™s</label>
                  <input type="number" id="dia-fixo" min="1" max="28" placeholder="Ex: 5">
                  <label>Data de t√©rmino (opcional)</label>
                  <input type="month" id="recorrente-fim">
                </div>

                <div style="height: 10px;"></div>
                <button id="btn-save-gastar" class="btn-expense" onclick="salvar('gastar')">Confirmar Gasto</button>
                <button id="btn-cancel-gastar" class="btn-sec hidden" onclick="cancelarEdicao('gastar')" style="margin-top:10px;">Cancelar</button>
            </div>
        </div>

        <div id="v-analise" class="view">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                    <h3 style="margin:0; font-size: 1rem;">Vis√£o Geral</h3>
                    <select id="filtroMes" onchange="render()" style="width: auto; padding: 5px; background: transparent; border: none; font-weight: 700; color: var(--primary);"></select>
                </div>
                
                <div id="charts-wrapper">
                    <div class="chart-grid">
                        <div class="chart-container">
                            <canvas id="chart-doughnut"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="chart-bar"></canvas>
                        </div>
                    </div>
                </div>

                <div id="empty-state" class="empty-state hidden">
                    <img src="https://media.giphy.com/media/26hkhKd9CQeREKsWk/giphy.gif" alt="Sem dados">
                    <p>Nada por aqui ainda...<br>Cadastre uma receita ou despesa!</p>
                </div>

                <div id="lista-detalhada" style="margin-top: 25px; border-top: 1px solid var(--glass-border); padding-top: 15px;"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0"><i class="fas fa-bullseye"></i> Meta Financeira</h3>
                
                <label>Valor da Meta (R$)</label>
                <input type="tel" id="meta-valor" placeholder="Ex: 10000">

                <label>Prazo (meses)</label>
                <input type="number" id="meta-prazo" placeholder="Ex: 6">

                <button class="btn-primary" onclick="salvarMeta()">Definir Meta</button>

                <div style="margin-top:20px;">
                    <div style="height:14px; background:rgba(120,120,128,0.2); border-radius:20px; overflow:hidden;">
                        <div id="meta-barra" style="height:100%; width:0%; background:var(--income); transition:0.5s;"></div>
                    </div>
                    <div id="meta-status" style="margin-top:8px; font-size:0.8rem; font-weight: 600;"></div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0"><i class="fas fa-chart-line"></i> Evolu√ß√£o & Proje√ß√£o</h3>
                <div class="chart-container">
                    <canvas id="chart-projecao"></canvas>
                </div>
                <div id="projecao-info" style="margin-top:15px; font-size:0.85rem; color:var(--text-sec);"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0"><i class="fas fa-history"></i> Hist√≥rico Mensal</h3>
                <div id="historico-mensal-list">
                    </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0">Dados & Exporta√ß√£o</h3>
                
                <button class="btn-primary" onclick="gerarRelatorioPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                <button class="btn-whatsapp" onclick="compartilharZap()"><i class="fab fa-whatsapp"></i> Enviar Resumo no Zap</button>
                <button class="btn-offline" onclick="abrirOpcoesDownload()" style="margin-top:10px"><i class="fas fa-download"></i> Baixar App Completo (HTML)</button>
                
                <div style="border-top: 1px solid var(--glass-border); margin: 20px 0; padding-top: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn-sec" onclick="backupDados()"><i class="fas fa-download"></i> Backup</button>
                        <button class="btn-sec" onclick="document.getElementById('file-restore').click()"><i class="fas fa-upload"></i> Restaurar</button>
                    </div>
                    
                    <input type="file" id="file-restore" class="hidden" accept=".json" onchange="restoreDados(this)">
                    
                    <button class="btn-danger" onclick="abrirOpcoesReset()" style="margin-top:10px; width:100%"><i class="fas fa-trash"></i> Resetar Tudo</button>
                </div>
            </div>
        </div>

        <div id="v-apoie" class="view">
            <div class="card">
                <h3 style="margin:0; font-size: 1.1rem;"><i class="fas fa-rocket"></i> Guia Pro</h3>
                <p style="font-size: 0.85rem; color: var(--text-sec); margin: 10px 0;">Aprenda a instalar o app e dominar suas finan√ßas.</p>
                <button class="btn-primary" onclick="openModal('modal-tutorial-completo')"><i class="fas fa-book"></i> Ajuda & Manual</button>
            </div>

            <div class="card">
                <h4 style="color: var(--primary); margin: 0 0 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-gift"></i> Escolha como fortalecer
                </h4>
                
                <div class="tiers-grid">
                    <div class="tier-card">
                        <div class="tier-icon">‚òï</div>
                        <div class="tier-title">O Caf√© da Firma</div>
                        <div class="tier-price">R$ 5,00 a R$ 10,00</div>
                        <div class="tier-description">Ajuda a manter o dev acordado programando novas fun√ß√µes!</div>
                        <img src="qrcode.png" class="tier-qr" onclick="zoomPix(this.src, 'O Caf√© da Firma ‚òï (PIX via Banco)')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
                        <div class="zoom-hint" onclick="zoomPix(this.previousElementSibling.src, 'O Caf√© da Firma ‚òï (PIX via Banco)')"><i class="fas fa-search-plus"></i> Ampliar</div>
                    </div>

                    <div class="tier-card" style="background: rgba(48, 209, 88, 0.08); border-color: var(--income);">
                        <div class="badge-popular">‚ú® Popular</div>
                        <div class="tier-icon">ü•™</div>
                        <div class="tier-title">O Lanche</div>
                        <div class="tier-price">R$ 15,00 a R$ 25,00</div>
                        <div class="tier-description">Mais barato que taxa de banco! Retribua pelas horas economizadas.</div>
                        <img src="qrcode.png" class="tier-qr" onclick="zoomPix(this.src, 'O Lanche ü•™ (PIX via Banco)')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
                        <div class="zoom-hint" onclick="zoomPix(this.previousElementSibling.src, 'O Lanche ü•™ (PIX via Banco)')"><i class="fas fa-search-plus"></i> Ampliar</div>
                    </div>

                    <div class="tier-card" style="background: rgba(255, 214, 10, 0.08); border-color: #ffd60a;">
                        <div class="tier-icon">üëë</div>
                        <div class="tier-title">Quer novos recursos e funcionalidades.</div>
                        <div class="tier-price">R$ 50,00+</div>
                        <div class="tier-description">Para quem virou f√£ e quer garantir os melhores recursos</div>
                        <img src="qrcode.png" class="tier-qr" onclick="zoomPix(this.src, 'Patr√£o do App üëë (PIX via Banco)')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
                        <div class="zoom-hint" onclick="zoomPix(this.previousElementSibling.src, 'Patr√£o do App üëë (PIX via Banco)')"><i class="fas fa-search-plus"></i> Ampliar</div>
                        
                        <button onclick="window.open('https://wa.me/5547996057007', '_blank')" style="background: var(--whatsapp); color: white; padding: 10px; margin-top: 10px; font-size: 0.75rem;">
                            <i class="fab fa-whatsapp"></i> contato com o dev
                        </button>
                        <div style="font-size: 0.6rem; color: var(--text-sec); margin-top: 5px;">novos recursos</div>
                    </div>
                </div>

                <div class="app-footer">
                    <p>Feito com c√≥digo limpo e foco total na sua liberdade financeira.<br>
                    <strong>Privacidade Absoluta:</strong> Seus dados financeiros vivem no seu bolso (Local Storage), n√£o na nossa nuvem. Ningu√©m, al√©m de voc√™, tem acesso.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="smart-bar" class="smart-action-bar">
        <button id="smart-save-btn" class="btn-primary" onclick="triggerSmartSave()">
            <i class="fas fa-check"></i> CONFIRMAR
        </button>
        <button class="btn-sec" style="width: 50px;" onclick="document.activeElement.blur()"><i class="fas fa-keyboard"></i></button>
    </div>

    <nav id="main-nav">
        <div class="tab active" onclick="navTo('v-ganhar',this)"><i class="fas fa-arrow-up"></i><span>Ganhar</span></div>
        <div class="tab" onclick="navTo('v-gastar',this)"><i class="fas fa-arrow-down"></i><span>Gastar</span></div>
        <div class="tab" onclick="navTo('v-analise',this)"><i class="fas fa-chart-pie"></i><span>An√°lise</span></div>
        <div class="tab" onclick="navTo('v-apoie',this)"><i class="fas fa-heart"></i><span>Apoie</span></div>
    </nav>

    <div id="modal-theme" class="modal-overlay" onclick="closeModal('modal-theme')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <h3 style="margin-top:0">Personaliza√ß√£o</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem;">Escolha o visual do seu app.</p>

            <label style="text-align:left; display:block; margin-bottom:5px;">Modo</label>
            <div class="mode-switch">
                <div class="mode-opt" id="mode-dark" onclick="setThemeMode('dark')"><i class="fas fa-moon"></i> Escuro</div>
                <div class="mode-opt" id="mode-light" onclick="setThemeMode('light')"><i class="fas fa-sun"></i> Claro</div>
            </div>

            <label style="text-align:left; display:block; margin-bottom:5px;">Cores</label>
            <div class="theme-grid">
                <div class="theme-option" onclick="setPalette('default')"><div class="theme-circle" style="background:#5e5ce6"></div></div>
                <div class="theme-option" onclick="setPalette('nature')"><div class="theme-circle" style="background:#10b981"></div></div>
                <div class="theme-option" onclick="setPalette('ocean')"><div class="theme-circle" style="background:#0ea5e9"></div></div>
                <div class="theme-option" onclick="setPalette('solar')"><div class="theme-circle" style="background:#f59e0b"></div></div>
                <div class="theme-option" onclick="setPalette('berry')"><div class="theme-circle" style="background:#ec4899"></div></div>
                <div class="theme-option" onclick="setPalette('minimal')"><div class="theme-circle" style="background:#64748b"></div></div>
            </div>
            <button class="btn-primary" onclick="closeModal('modal-theme')" style="margin-top:20px">Concluir</button>
        </div>
    </div>

    <div id="modal-funil-identity" class="modal-overlay" onclick="closeModal('modal-funil-identity')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üí°</div>
            <h3 style="margin-top:0">Consci√™ncia Financeira</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px;">
                A maioria das pessoas n√£o sabe para onde o dinheiro vai.<br><b>Voc√™ agora sabe.</b>
            </p>
            <button class="btn-primary" onclick="closeModal('modal-funil-identity')">Continuar no Controle</button>
        </div>
    </div>

    <div id="modal-funil-identity-10" class="modal-overlay" onclick="closeModal('modal-funil-identity-10')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üß†</div>
            <h3 style="margin-top:0">Mem√≥ria Financeira</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px;">
                Seu dinheiro agora tem mem√≥ria.<br>E voc√™ tem controle.
            </p>
            <button class="btn-primary" onclick="closeModal('modal-funil-identity-10')">Seguir Firme</button>
        </div>
    </div>

    <div id="modal-funil-engagement" class="modal-overlay" onclick="closeModal('modal-funil-engagement')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üìà</div>
            <h3 style="margin-top:0">Voc√™ est√° no topo!</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px;">
                Voc√™ j√° registrou <b>15 movimenta√ß√µes</b>.<br>Isso j√° √© mais controle do que 90% das pessoas t√™m.
            </p>
            <button class="btn-primary" onclick="closeModal('modal-funil-engagement')">Orgulho!</button>
        </div>
    </div>

    <div id="modal-cafe" class="modal-overlay" onclick="closeModal('modal-cafe')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üéâ</div>
            <h3 style="margin-top:0">30 Decis√µes Inteligentes</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px;">
                Se cada registro evitou um erro de R$ 10, voc√™ j√° protegueu <b>R$ 300</b>.<br><br>
                Este app n√£o tem an√∫ncios, n√£o coleta dados e n√£o te vende.<br>
                Um caf√© mant√©m tudo assim.
            </p>
            <img src="qrcode.png" class="tier-qr" onclick="zoomPix(this.src, 'O Caf√© da Firma ‚òï (PIX via Banco)')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
            <div class="zoom-hint" onclick="zoomPix(this.previousElementSibling.src, 'O Caf√© da Firma ‚òï (PIX via Banco)')"><i class="fas fa-search-plus"></i> Ampliar</div>
            <button class="btn-primary" onclick="closeModal('modal-cafe')" style="margin-top:20px">Fechar</button>
        </div>
    </div>

    <div id="modal-funil-pride" class="modal-overlay" onclick="closeModal('modal-funil-pride')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üíô</div>
            <h3 style="margin-top:0">Azul Consistente</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px;">
                Voc√™ est√° no azul h√° 2 meses.<br>Isso n√£o √© sorte. √â consci√™ncia.
            </p>
            <button class="btn-primary" onclick="closeModal('modal-funil-pride')">Comemorar</button>
        </div>
    </div>

    <div id="modal-funil-security" class="modal-overlay" onclick="closeModal('modal-funil-security')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üîê</div>
            <h3 style="margin-top:0">Guardi√£o dos Dados</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px;">
                Voc√™ j√° registrou muita informa√ß√£o importante.<br>Que tal proteger o app com PIN?
            </p>
            <button onclick="window.open('https://wa.me/5547996057007?text=Ola%20Gabriel,%20quero%20proteger%20meu%20app%20com%20PIN', '_blank')" style="background: var(--whatsapp); color: white; padding: 12px; border-radius: 12px; border: none; font-weight: 700; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fab fa-whatsapp"></i> Quero mais seguran√ßa
            </button>
            <button class="btn-sec" onclick="closeModal('modal-funil-security')" style="margin-top:10px">Agora n√£o</button>
        </div>
    </div>

    <div id="modal-funil-social" class="modal-overlay" onclick="closeModal('modal-funil-social')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üìä</div>
            <h3 style="margin-top:0">Fato Curioso</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px;">
                Usu√°rios que acompanham metas economizam em m√©dia mais no 3¬∫ m√™s de uso.
            </p>
            <button class="btn-primary" onclick="closeModal('modal-funil-social')">Continuar focado</button>
        </div>
    </div>

    <div id="modal-download-options" class="modal-overlay" onclick="closeModal('modal-download-options')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üì¶</div>
            <h3 style="margin-top:0">Leve o App com Voc√™</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 25px;">
                Escolha como deseja salvar seu app e seus dados:
            </p>
            <button class="btn-sec" onclick="backupDados(); closeModal('modal-download-options')" style="margin-bottom: 10px;">
                <i class="fas fa-download"></i> Backup dos Dados (.json)
                <div style="font-size: 0.65rem; font-weight: 400; margin-top: 2px; opacity: 0.7;">Salve apenas seus lan√ßamentos</div>
            </button>
            <button class="btn-offline" onclick="baixarAppHTMLClean(); closeModal('modal-download-options')">
                <i class="fas fa-code"></i> App Instal√°vel (.html)
                <div style="font-size: 0.65rem; font-weight: 400; margin-top: 2px; opacity: 0.7;">Vers√£o limpa do app, sem dados</div>
            </button>
            <button class="btn-sec" onclick="closeModal('modal-download-options')" style="margin-top:20px; border:none; background:transparent;">Cancelar</button>
        </div>
    </div>

    <div id="modal-reset-options" class="modal-overlay" onclick="closeModal('modal-reset-options')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <h3 style="margin-top:0">Zona de Perigo</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 25px;">
                Voc√™ est√° prestes a apagar tudo. Recomendamos fortemente fazer um backup dos dados antes.
            </p>
            <button class="btn-sec" onclick="backupDados()" style="margin-bottom: 10px; border-color: var(--primary); color: var(--primary);">
                <i class="fas fa-save"></i> Fazer Backup de Seguran√ßa (.json)
            </button>
            <button class="btn-danger" onclick="realReset()" style="margin-top:10px; background: var(--expense); color: white;">
                <i class="fas fa-bomb"></i> Apagar Tudo e Reiniciar
            </button>
            <button class="btn-sec" onclick="closeModal('modal-reset-options')" style="margin-top:15px; border:none; background:transparent;">Cancelar</button>
        </div>
    </div>

    <div id="modal-tutorial-completo" class="modal-overlay" onclick="closeModal('modal-tutorial-completo')">
        <div class="modal-content" onclick="event.stopPropagation()" style="text-align: left;">
            <h3 style="color: var(--primary); margin-top:0;">Central de Ajuda</h3>
            
            <div class="guide-item active" onclick="toggleGuide(this)">
                <div class="guide-header">üì± Instalar App (PWA) <i class="fas fa-chevron-down" style="float:right"></i></div>
                <div class="guide-content" style="display:block">
                    <b>iOS (iPhone):</b> Toque em Compartilhar > Adicionar √† Tela de In√≠cio.<br><br>
                    <b>Android:</b> Toque nos 3 pontos > Instalar Aplicativo.<br><br>
                    <i>O app funciona 100% offline ap√≥s instalado.</i>
                </div>
            </div>

            <div class="guide-item" onclick="toggleGuide(this)">
                <div class="guide-header">üí∏ Lan√ßamentos e Recorr√™ncia <i class="fas fa-chevron-down" style="float:right"></i></div>
                <div class="guide-content">
                    Use as abas <b>Ganhar</b> e <b>Gastar</b>. Marque "Conta mensal fixa" para gastos que se repetem todo m√™s automaticamente (ex: Aluguel, Netflix).
                </div>
            </div>
            
            <div class="guide-item" onclick="toggleGuide(this)">
                <div class="guide-header">üìä An√°lise e Metas <i class="fas fa-chevron-down" style="float:right"></i></div>
                <div class="guide-content">
                    Defina uma meta financeira e acompanhe o progresso. O app tamb√©m projeta seu futuro financeiro com base na sua m√©dia de gastos.
                </div>
            </div>

            <div class="guide-item" onclick="toggleGuide(this)">
                <div class="guide-header">üõ°Ô∏è Backup e Seguran√ßa <i class="fas fa-chevron-down" style="float:right"></i></div>
                <div class="guide-content">
                    Seus dados ficam <b>apenas no seu celular</b>. Fa√ßa backups regulares (bot√£o "Baixar App Completo" ou "Backup JSON") para n√£o perder nada se trocar de aparelho.
                </div>
            </div>
            <button class="btn-primary" onclick="closeModal('modal-tutorial-completo')" style="margin-top:15px">Entendi</button>
        </div>
    </div>

    <div id="modal-welcome" class="modal-overlay">
        <div class="modal-content" style="text-align:center">
            <div style="font-size:3rem">üëã</div>
            <h2>Bem-vindo</h2>
            <p>Como voc√™ quer ser chamado?</p>
            <input type="text" id="user-in" placeholder="Seu nome" style="text-align:center">
            <button class="btn-primary" onclick="initUser()" style="margin-top:20px">Acessar App</button>
        </div>
    </div>

    <div id="modal-pix" class="modal-overlay" onclick="closeModal('modal-pix')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <h3 id="pix-tit" style="margin-bottom: 5px;">Apoio</h3>
            <p style="font-size: 0.8rem; color: var(--text-sec); margin-top: 0; margin-bottom: 15px;">
                <i class="fas fa-university"></i> Abra o app do seu banco para pagar via PIX
            </p>
            <img id="pix-img" src="" style="width:200px; height:200px; background:white; padding:10px; border-radius:15px; border:1px solid #ddd; margin: 0 auto; display: block;">
            <button class="btn-primary" onclick="closeModal('modal-pix')" style="margin-top:20px">Fechar</button>
        </div>
    </div>

    <div id="toast">Notifica√ß√£o</div>

    <script>
        let db;
        const channel = new BroadcastChannel('contas_pro_sync');
        const FORMAT = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        let chartInstanceDoughnut = null;
        let chartInstanceBar = null;
        let chartInstanceProjecao = null;
        
        const BACKUP_EMBUTIDO = null; // __MARKER_BACKUP__

        // --- SAFE HELPERS ---
        const safeFloat = (num) => parseFloat(Number(num).toFixed(2));
        const getLocalDate = () => {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            return new Date(now.getTime() - offset).toISOString().slice(0, 10);
        };
        const getLocalMonth = () => getLocalDate().slice(0, 7);

        /* ================= SECURITY & MULTI-TAB LOGIC ================= */
        let isBlocked = false;
        let isUnloading = false;

        document.getElementById('blocker').style.display = 'none';
        window.addEventListener('beforeunload', () => { isUnloading = true; });

        channel.onmessage = (e) => {
            if (e.data === 'ping') {
                if (!isBlocked && !isUnloading) channel.postMessage('pong');
            }
            if (e.data === 'pong') {
                isBlocked = true;
                document.getElementById('blocker').style.display = 'flex';
            }
        };

        function tentarDesbloquear() {
            isBlocked = false;
            document.getElementById('blocker').style.display = 'none';
            channel.postMessage('ping');
        }
        
        setTimeout(() => channel.postMessage('ping'), 500);

        /* ================= DB INIT & OFFLINE RESTORE ================= */
        async function initDB() {
            return new Promise((resolve) => {
                const req = indexedDB.open("ContasProDB", 9); 
                req.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains("receitas")) db.createObjectStore("receitas", { keyPath: "id", autoIncrement: true });
                    if (!db.objectStoreNames.contains("despesas")) db.createObjectStore("despesas", { keyPath: "id", autoIncrement: true });
                    if (!db.objectStoreNames.contains("fechamentos")) db.createObjectStore("fechamentos", { keyPath: "mes" });
                };
                req.onsuccess = async e => { 
                    db = e.target.result; 
                    const ignore = localStorage.getItem('ignore_embed');
                    if (BACKUP_EMBUTIDO && typeof BACKUP_EMBUTIDO === 'object' && !ignore) {
                        await autoRestoreOffline(BACKUP_EMBUTIDO);
                    }
                    resolve(); 
                };
                req.onerror = () => alert("Erro cr√≠tico no banco de dados.");
            });
        }

        async function autoRestoreOffline(data) {
            return new Promise(resolve => {
                const tx = db.transaction(['receitas', 'despesas', 'fechamentos'], 'readwrite');
                tx.objectStore('receitas').clear();
                tx.objectStore('despesas').clear();
                if(tx.objectStoreNames.contains('fechamentos')) tx.objectStore('fechamentos').clear();
                
                if(data.u) localStorage.setItem('contas_user', data.u);
                
                if(data.m) {
                      if(data.m.start) localStorage.setItem('app_start_date', data.m.start);
                      if(data.m.flags) {
                          Object.keys(data.m.flags).forEach(k => localStorage.setItem(k, data.m.flags[k]));
                      }
                      if(data.m.palette) setPalette(data.m.palette);
                      if(data.m.theme) setThemeMode(data.m.theme);
                }
                
                const normalize = (item) => ({
                    desc: item.desc || item.descricao,
                    val: safeFloat(item.val || item.valor) || 0,
                    data: item.data,
                    cat: item.cat || item.categoria,
                    recorrente: item.recorrente || false,
                    diaFixo: item.diaFixo || null,
                    recorrenteAtiva: item.recorrenteAtiva !== undefined ? item.recorrenteAtiva : true
                });

                (data.r || data.receitas || []).forEach(i => tx.objectStore('receitas').add(normalize(i)));
                (data.d || data.despesas || []).forEach(i => tx.objectStore('despesas').add(normalize(i)));
                
                if(data.f){
                    data.f.forEach(f => tx.objectStore('fechamentos').put(f));
                }
                
                tx.oncomplete = () => {
                    showToast("Dados restaurados do Backup Offline!");
                    resolve();
                };
            });
        }

        async function getAll(store) {
            if(!db) return [];
            if(!db.objectStoreNames.contains(store)) return [];
            const tx = db.transaction(store, "readonly");
            return new Promise(r => { const req = tx.objectStore(store).getAll(); req.onsuccess = () => r(req.result || []); });
        }

        /* ================= CORE UI ================= */
        function setPalette(paletteName) {
            document.body.classList.remove('palette-default', 'palette-nature', 'palette-ocean', 'palette-solar', 'palette-berry', 'palette-minimal');
            if (paletteName !== 'default') {
                document.body.classList.add(`palette-${paletteName}`);
            }
            localStorage.setItem('contas_palette', paletteName);
            updateDynamicGradient();
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('selected'));
        }

        function updateDynamicGradient() {
            const primaryColor = getComputedStyle(document.body).getPropertyValue('--primary').trim();
            document.body.style.backgroundImage = `radial-gradient(at 0% 0%, ${primaryColor}33 0px, transparent 60%)`;
        }

        function setThemeMode(mode) {
            if (mode === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('mode-light').classList.add('active');
                document.getElementById('mode-dark').classList.remove('active');
            } else {
                document.body.classList.remove('light-theme');
                document.getElementById('mode-dark').classList.add('active');
                document.getElementById('mode-light').classList.remove('active');
            }
            localStorage.setItem('contas_theme', mode);
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('contas_theme') || 'dark';
            setThemeMode(savedTheme);
            const savedPalette = localStorage.getItem('contas_palette') || 'default';
            setPalette(savedPalette);
        }

        function toggleTheme() { openModal('modal-theme'); }

        function navTo(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            const titles = { "v-ganhar": "Nova Receita", "v-gastar": "Novo Gasto", "v-analise": "An√°lise Financeira", "v-apoie": "Central de Apoio" };
            const titleEl = document.getElementById("header-title");
            titleEl.style.display = 'none';
            setTimeout(() => { titleEl.innerText = titles[id]; titleEl.style.display = 'block'; }, 50);
            if(id === 'v-analise') render();
            window.scrollTo(0,0);
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleGuide(el) { document.querySelectorAll('.guide-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); }
        function zoomPix(src, tit) { document.getElementById('pix-img').src = src; document.getElementById('pix-tit').innerText = tit; openModal('modal-pix'); }

        function setupSmartBar() {
            const inputs = document.querySelectorAll('input, select');
            const bar = document.getElementById('smart-bar');
            const nav = document.getElementById('main-nav');
            inputs.forEach(i => {
                i.addEventListener('focus', () => { 
                    if(document.querySelector('.view.active').id !== 'v-analise'){ bar.classList.add('visible'); nav.classList.add('hidden'); }
                });
                i.addEventListener('blur', () => { 
                    setTimeout(() => { if(!document.activeElement.tagName.match(/INPUT|SELECT/)){ bar.classList.remove('visible'); nav.classList.remove('hidden'); }}, 100);
                });
            });
            
            document.getElementById('recorrente-gastar').addEventListener('change', function(){
                document.getElementById('opcoes-recorrente').style.display = this.checked ? 'block' : 'none';
            });
        }

        function triggerSmartSave() {
            if (navigator.vibrate) navigator.vibrate(20);
            const current = document.querySelector('.view.active').id;
            if(current === 'v-ganhar') salvar('ganhar');
            if(current === 'v-gastar') salvar('gastar');
            document.activeElement.blur();
        }

        /* ================= LOGIC ================= */
        function initUser() {
            const name = document.getElementById('user-in').value.trim();
            if(!name) return;
            localStorage.setItem('contas_user', name);
            localStorage.removeItem('ignore_embed');
            if(!localStorage.getItem('app_start_date')) {
                localStorage.setItem('app_start_date', new Date().toISOString());
            }
            closeModal('modal-welcome');
            location.reload();
        }

        async function salvar(tipo) {
            // 1. SEGURAR DADOS EM VARI√ÅVEIS ANTES DE INSERIR
            const editId = document.getElementById(`edit-id-${tipo}`).value;
            const desc = document.getElementById(`desc-${tipo}`).value;
            // Parsing seguro do valor
            let rawVal = document.getElementById(`val-${tipo}`).value;
            if(!rawVal) rawVal = "0";
            const val = safeFloat(parseFloat(rawVal.replace(/\./g,'').replace(',','.')));
            const data = document.getElementById(`data-${tipo}`).value;
            const cat = tipo === 'ganhar' ? 'salario' : document.getElementById('cat-gastar').value;

            // Valida√ß√£o
            if(!desc || val <= 0 || !data) { showToast("Preencha todos os campos!"); return; }

            // Payload do objeto
            const obj = { desc, val, data, cat };
            
            // Recorr√™ncia (apenas gastos)
            if(tipo === 'gastar'){
                const recorrente = document.getElementById('recorrente-gastar')?.checked || false;
                if(recorrente){
                    obj.recorrente = true;
                    obj.recorrenteAtiva = true;
                    obj.diaFixo = parseInt(document.getElementById('dia-fixo').value) || new Date(data).getDate();
                    obj.recorrenteInicio = data.slice(0,7);
                    const fim = document.getElementById('recorrente-fim').value;
                    if(fim) obj.recorrenteFim = fim;
                }
            }

            // Duplicidade (Relaxada em edi√ß√£o para permitir update)
            if(!editId) {
                const duplicado = await verificarDuplicidade(tipo, obj);
                if(duplicado){ showToast("Lan√ßamento duplicado!"); return; }
            }

            if(editId) obj.id = parseInt(editId);

            try {
                const tx = db.transaction(tipo === 'ganhar' ? "receitas" : "despesas", "readwrite");
                const store = tx.objectStore(tipo === 'ganhar' ? "receitas" : "despesas");
                store.put(obj);
                
                tx.oncomplete = async () => {
                    // 2. FOR√áA REC√ÅLCULO DE FECHAMENTOS (CORRE√á√ÉO PROJE√á√ÉO)
                    await recalcularFechamentos(); 
                    
                    showToast(editId ? "Atualizado!" : "Salvo!");
                    cancelarEdicao(tipo);
                    render(); 
                    if (!editId) verificarGatilhosFunil();
                };
            } catch (error) {
                console.error("Erro ao salvar no banco:", error);
                alert("Erro ao salvar. Tente recarregar a p√°gina.");
            }
        }

        function cancelarEdicao(tipo) {
            document.getElementById(`edit-id-${tipo}`).value = "";
            document.getElementById(`desc-${tipo}`).value = "";
            document.getElementById(`val-${tipo}`).value = "";
            document.getElementById(`btn-cancel-${tipo}`).classList.add('hidden');
            document.getElementById(`btn-save-${tipo}`).innerText = tipo === 'ganhar' ? "Salvar Receita" : "Confirmar Gasto";
            document.getElementById(`form-title-${tipo}`).innerHTML = tipo === 'ganhar' ? '<i class="fas fa-plus-circle"></i> Nova Receita' : '<i class="fas fa-minus-circle"></i> Novo Gasto';
            if(tipo==='gastar') {
                document.getElementById('recorrente-gastar').checked = false;
                document.getElementById('opcoes-recorrente').style.display = 'none';
            }
        }

        function openEdit(item) {
            const tipo = item.t === 'r' ? 'ganhar' : 'gastar';
            const tabIndex = tipo === 'ganhar' ? 0 : 1;
            navTo(`v-${tipo}`, document.querySelectorAll('.tab')[tabIndex]);
            
            document.getElementById(`edit-id-${tipo}`).value = item.id;
            document.getElementById(`desc-${tipo}`).value = item.desc;
            document.getElementById(`val-${tipo}`).value = item.val.toFixed(2).replace('.', ',');
            document.getElementById(`data-${tipo}`).value = item.data;
            if(tipo === 'gastar') document.getElementById('cat-gastar').value = item.cat;
            
            document.getElementById(`btn-cancel-${tipo}`).classList.remove('hidden');
            document.getElementById(`btn-save-${tipo}`).innerText = "Atualizar Item";
            document.getElementById(`form-title-${tipo}`).innerText = "Editando Item";
        }
        
        function excluirItem(type, id) {
            if(confirm("Tem certeza que deseja excluir este item?")) {
                const tx = db.transaction(type === 'r' ? "receitas" : "despesas", "readwrite");
                const store = tx.objectStore(type === 'r' ? "receitas" : "despesas");
                store.delete(id);
                tx.oncomplete = async () => { 
                    await recalcularFechamentos(); // Atualiza hist√≥rico ap√≥s exclus√£o
                    showToast("Item exclu√≠do!"); 
                    render(); 
                };
            }
        }

        function safeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        const safeVal = (v) => safeFloat(v) || 0;

        async function verificarDuplicidade(tipo, obj, editId = null) {
            const storeName = tipo === 'ganhar' ? "receitas" : "despesas";
            const lista = await getAll(storeName);

            return lista.some(item => 
                item.desc.trim().toLowerCase() === obj.desc.trim().toLowerCase() &&
                safeVal(item.val) === safeVal(obj.val) &&
                item.data === obj.data &&
                (editId ? item.id !== parseInt(editId) : true)
            );
        }

        // --- SISTEMA DE INTEGRIDADE (REC√ÅLCULO) ---
        // 3. FUN√á√ÉO DE CORRE√á√ÉO GERAL DE DADOS
        async function recalcularFechamentos() {
            if(!db) return;
            const [receitas, despesas] = await Promise.all([
                getAll("receitas"),
                getAll("despesas")
            ]);

            const mapa = {};

            // Agrupa todas receitas por M√™s (YYYY-MM)
            receitas.forEach(r=>{
                const m = r.data.slice(0,7);
                if(!mapa[m]) mapa[m] = { receitas:0, despesas:0 };
                mapa[m].receitas += safeVal(r.val);
            });

            // Agrupa todas despesas por M√™s
            despesas.forEach(d=>{
                const m = d.data.slice(0,7);
                if(!mapa[m]) mapa[m] = { receitas:0, despesas:0 };
                mapa[m].despesas += safeVal(d.val);
            });

            // Transa√ß√£o de Escrita para reconstruir a tabela de Fechamentos
            const tx = db.transaction("fechamentos","readwrite");
            const store = tx.objectStore("fechamentos");
            
            // Limpa dados antigos potencialmente errados
            store.clear();

            Object.keys(mapa).forEach(m=>{
                store.put({
                    mes: m,
                    receitas: safeFloat(mapa[m].receitas),
                    despesas: safeFloat(mapa[m].despesas),
                    saldo: safeFloat(mapa[m].receitas - mapa[m].despesas),
                    recalculadoEm: Date.now()
                });
            });

            return new Promise(res=>{
                tx.oncomplete = ()=>res();
                tx.onerror = ()=>res(); // Continua mesmo se der erro (fallback)
            });
        }

        async function fecharMesAutomatico() {
            // Fun√ß√£o mantida para compatibilidade, mas o trabalho pesado agora √© do recalcularFechamentos
            await recalcularFechamentos();
            localStorage.setItem('ultimo_mes_fechado', getLocalMonth());
        }

        async function processarRecorrencias(){
            const despesas = await getAll("despesas");
            const mesAtual = getLocalMonth();

            for(let d of despesas){
                if(!d.recorrente) continue;
                if(d.recorrenteAtiva === false) continue;
                if(d.recorrenteFim && mesAtual > d.recorrenteFim) continue;
                if(d.recorrenteInicio && mesAtual < d.recorrenteInicio) continue;

                const chaveControle = `rec_${d.id}_${mesAtual}`;
                if(localStorage.getItem(chaveControle)) continue;

                const existeNoMes = despesas.some(x => 
                    x.desc === d.desc && 
                    x.val === d.val && 
                    x.data.startsWith(mesAtual)
                );

                if(existeNoMes) {
                    localStorage.setItem(chaveControle, "true");
                    continue;
                }

                const novaData = `${mesAtual}-${String(d.diaFixo || 1).padStart(2,'0')}`;
                const novoLancamento = { desc: d.desc, val: d.val, data: novaData, cat: d.cat };

                const tx = db.transaction("despesas","readwrite");
                tx.objectStore("despesas").add(novoLancamento);
                localStorage.setItem(chaveControle,"true");
            }
        }

        // --- MOTOR DO FUNIL ---
        function verificarGatilhosFunil(saldoAtual = null) {
            Promise.all([getAll("receitas"), getAll("despesas")]).then(([r, d]) => {
                const totalContas = r.length + d.length;
                const triggers = [
                    { count: 5, id: 'funnel_seen_5', modal: 'modal-funil-identity' },
                    { count: 10, id: 'funnel_seen_10', modal: 'modal-funil-identity-10' },
                    { count: 15, id: 'funnel_seen_15', modal: 'modal-funil-engagement' },
                    { count: 30, id: 'funnel_seen_30', modal: 'modal-cafe' },
                    { count: 50, id: 'funnel_seen_50', modal: 'modal-funil-security' }
                ];
                for (let t of triggers) {
                    if (totalContas >= t.count && !localStorage.getItem(t.id)) {
                        localStorage.setItem(t.id, 'true'); openModal(t.modal); return;
                    }
                }
                const startStr = localStorage.getItem('app_start_date');
                if (startStr && !localStorage.getItem('funnel_seen_90days')) {
                    const diffTime = Math.abs(new Date() - new Date(startStr));
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    if (diffDays >= 90) {
                        localStorage.setItem('funnel_seen_90days', 'true'); openModal('modal-funil-social'); return;
                    }
                }
                if (saldoAtual !== null && saldoAtual > 0 && totalContas > 20 && !localStorage.getItem('funnel_seen_blue_streak')) { 
                      localStorage.setItem('funnel_seen_blue_streak', 'true'); openModal('modal-funil-pride');
                }
            });
        }

        // --- RENDERIZA√á√ÉO PRINCIPAL ---
        async function render() {
            if(!db) return;
            const [receitas, despesas] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const filtro = document.getElementById('filtroMes').value || getLocalMonth();
            
            const recFiltro = receitas.filter(r => r.data.startsWith(filtro));
            const despFiltro = despesas.filter(d => d.data.startsWith(filtro));

            const totalR = safeFloat(receitas.reduce((s, i) => s + safeVal(i.val), 0));
            const totalD = safeFloat(despesas.reduce((s, i) => s + safeVal(i.val), 0));
            const saldo = safeFloat(totalR - totalD);
            
            // 4. CORRE√á√ÉO NA LEITURA DE M√âDIA (M√âDIA REAL)
            const fechamentos = await getAll("fechamentos");
            let media = 0;
            if(fechamentos.length > 0) {
                media = safeFloat(fechamentos.reduce((s,f)=>s+f.saldo,0) / fechamentos.length);
            }
            if(document.getElementById('dash-media')) document.getElementById('dash-media').innerText = FORMAT.format(media);

            document.getElementById('dash-saldo').innerText = FORMAT.format(saldo);
            const gastosMes = safeFloat(despFiltro.reduce((s,i)=>s+safeVal(i.val),0));
            document.getElementById('dash-gastos').innerText = FORMAT.format(gastosMes);

            const header = document.getElementById('main-header');
            if(saldo >= 0) {
                header.classList.remove('header-neg'); header.classList.add('header-pos');
            } else {
                header.classList.remove('header-pos'); header.classList.add('header-neg');
            }
            
            updateCharts(recFiltro, despFiltro);
            renderHistoricoMensal(receitas, despesas);
            renderProjecao();
            atualizarMeta();

            const list = document.getElementById('lista-detalhada');
            list.innerHTML = "";
            const items = [...recFiltro.map(i=>({...i,t:'r'})), ...despFiltro.map(i=>({...i,t:'d'}))].sort((a,b)=>b.data.localeCompare(a.data));

            if(items.length === 0) list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-sec);">Sem lan√ßamentos neste m√™s.</div>`;

            items.forEach(i => {
                const div = document.createElement('div');
                div.className = 'item';
                const recIcon = (i.t === 'd' && i.recorrente) ? ' <i class="fas fa-sync-alt" style="font-size:0.7rem; opacity:0.6"></i>' : '';
                div.innerHTML = `
                    <div class="item-info" onclick="openEdit({id:${i.id}, desc:'${i.desc.replace(/'/g, "\\'")}', val:${i.val}, data:'${i.data}', cat:'${i.cat}', t:'${i.t}'})" style="flex-grow:1; cursor:pointer;">
                        <div><b>${safeHtml(i.desc)}${recIcon}</b><br><small>${i.data.split('-').reverse().join('/')}</small></div>
                        <div style="color:${i.t==='r'?'var(--income)':'var(--expense)'}; font-weight:800">${i.t==='r'?'+':'-'} ${FORMAT.format(safeVal(i.val))}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon edit" onclick="openEdit({id:${i.id}, desc:'${i.desc.replace(/'/g, "\\'")}', val:${i.val}, data:'${i.data}', cat:'${i.cat}', t:'${i.t}'})"><i class="fas fa-pen"></i></button>
                        <button class="btn-icon del" onclick="excluirItem('${i.t}', ${i.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        async function renderProjecao() {
            // Agora usa a store "fechamentos" que foi for√ßada a recalcular
            let fechamentos = await getAll("fechamentos");

            if(fechamentos.length < 2){
                if(chartInstanceProjecao) chartInstanceProjecao.destroy();
                document.getElementById("projecao-info").innerHTML = 
                    `<div style="text-align:center; opacity:0.6; padding:20px;">
                    Precisa de pelo menos 2 meses com dados para projetar.
                    </div>`;
                return;
            }

            fechamentos.sort((a,b)=>a.mes.localeCompare(b.mes));

            // M√©dia dos √∫ltimos 6 meses para ser mais realista
            const ultimosMeses = fechamentos.slice(-6); 
            const media = safeFloat(ultimosMeses.reduce((s,f)=>s+f.saldo,0) / ultimosMeses.length);

            // 5. CORRE√á√ÉO DE SALDO ACUMULADO REAL
            // O gr√°fico deve partir do Saldo Atual Real, n√£o de zero.
            const [r, d] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const saldoAtualReal = safeFloat(r.reduce((s,i)=>s+safeVal(i.val),0) - d.reduce((s,i)=>s+safeVal(i.val),0));

            const projecoes = [];
            let acumulador = saldoAtualReal;
            for(let k=0; k<6; k++) {
                acumulador += media;
                projecoes.push(acumulador);
            }

            const labels = [
                ...fechamentos.map(f=>f.mes), 
                ...Array.from({length:6},(_,i)=>`+${i+1}m`)
            ];

            // Dados hist√≥ricos (apenas os saldos mensais para visualiza√ß√£o de tend√™ncia)
            // Ou acumulado hist√≥rico? Geralmente proje√ß√£o financeira mostra acumulo de capital.
            // Vou manter a l√≥gica visual de "Saldo do M√™s" para hist√≥rico e "Saldo Acumulado" para proje√ß√£o pode confundir.
            // Melhor: Mostrar a tend√™ncia do Saldo L√≠quido Mensal.
            
            const dadosHistoricos = fechamentos.map(f=>f.saldo);
            const dadosFuturos = [
                ...Array(fechamentos.length-1).fill(null), 
                fechamentos[fechamentos.length-1].saldo, // Ponto de liga√ß√£o
                ...Array(6).fill(media) // Proje√ß√£o linear da m√©dia mensal
            ];

            const corProjecao = media < 0 ? '#ff453a' : '#5e5ce6';

            const ctx = document.getElementById("chart-projecao").getContext('2d');
            
            if(chartInstanceProjecao) chartInstanceProjecao.destroy();

            chartInstanceProjecao = new Chart(ctx, {
                type:'line',
                data:{
                    labels,
                    datasets:[
                        { label:'Saldo Mensal', data:dadosHistoricos, borderColor:'#30d158', tension:0.3 },
                        { label:'Tend√™ncia M√©dia', data:dadosFuturos, borderDash:[5,5], borderColor: corProjecao, tension:0.3 }
                    ]
                },
                options:{ responsive:true, plugins:{legend:{display:true}} }
            });

            document.getElementById("projecao-info").innerHTML = 
                `M√©dia Mensal: <b style="color:${corProjecao}">${FORMAT.format(media)}</b><br>
                 Saldo Acumulado em 6 meses: <b>${FORMAT.format(saldoAtualReal + (media*6))}</b>`;
        }

        // --- METAS ---
        function salvarMeta(){
            const valor = parseFloat(document.getElementById("meta-valor").value);
            const prazo = parseFloat(document.getElementById("meta-prazo").value);
            if(!valor) return;
            localStorage.setItem('meta_financeira', JSON.stringify({valorMeta: valor, prazoMeses: prazo || 6}));
            atualizarMeta();
        }
        
        async function atualizarMeta(){
            const meta = JSON.parse(localStorage.getItem('meta_financeira'));
            if(!meta) return;
            const [receitas, despesas] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const saldoTotal = safeFloat(receitas.reduce((s,i)=>s+safeVal(i.val),0) - despesas.reduce((s,i)=>s+safeVal(i.val),0));
            const progresso = Math.min((saldoTotal/meta.valorMeta)*100, 100);
            document.getElementById("meta-barra").style.width = progresso+"%";
            document.getElementById("meta-status").innerHTML = `${FORMAT.format(saldoTotal)} de ${FORMAT.format(meta.valorMeta)} (${progresso.toFixed(1)}%)`;
            if(progresso >= 100) showToast("Meta atingida! üèÜ");
        }

        function renderHistoricoMensal(receitas, despesas) {
            const container = document.getElementById('historico-mensal-list');
            if(!container) return;
            
            // Rec√°lculo local para exibi√ß√£o imediata na lista
            const mapR = {}; const mapD = {};
            receitas.forEach(r => { const m = r.data.slice(0,7); mapR[m] = (mapR[m]||0) + safeVal(r.val); });
            despesas.forEach(d => { const m = d.data.slice(0,7); mapD[m] = (mapD[m]||0) + safeVal(d.val); });
            
            const meses = [...new Set([...Object.keys(mapR), ...Object.keys(mapD)])].sort().reverse();
            let html = '';
            meses.forEach(m => {
                const r = mapR[m] || 0; const d = mapD[m] || 0; const s = r - d;
                const [ano, mesNum] = m.split('-');
                const nomeMes = new Date(ano, mesNum-1).toLocaleString('pt-BR', {month:'long'});
                html += `<div class="history-row"><div style="text-transform:capitalize;">${nomeMes}/${ano}</div><div class="hist-val ${s >= 0 ? 'hist-pos' : 'hist-neg'}">${s >= 0 ? '+' : ''} ${FORMAT.format(s)}</div></div>`;
            });
            if(!html) html = '<div style="text-align:center; padding:10px; color:var(--text-sec); font-size:0.8rem;">Hist√≥rico aparecer√° aqui.</div>';
            container.innerHTML = html;
        }

        function updateCharts(receitas, despesas) {
            const hasData = receitas.length > 0 || despesas.length > 0;
            const wrapper = document.getElementById('charts-wrapper');
            const empty = document.getElementById('empty-state');
            if(!hasData) { wrapper.classList.add('hidden'); empty.classList.remove('hidden'); return; } 
            else { wrapper.classList.remove('hidden'); empty.classList.add('hidden'); }

            const textColor = document.body.classList.contains('light-theme') ? '#333333' : '#e5e5e5';
            const gridColor = document.body.classList.contains('light-theme') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';

            const cats = {};
            despesas.forEach(d => cats[d.cat] = (cats[d.cat] || 0) + safeVal(d.val));
            const catLabels = Object.keys(cats).map(c => c.charAt(0).toUpperCase() + c.slice(1));
            const catData = Object.values(cats).map(v => safeFloat(v));
            const totR = safeFloat(receitas.reduce((s,i) => s + safeVal(i.val), 0));
            const totD = safeFloat(despesas.reduce((s,i) => s + safeVal(i.val), 0));

            if(chartInstanceDoughnut) chartInstanceDoughnut.destroy();
            if(chartInstanceBar) chartInstanceBar.destroy();

            const ctxD = document.getElementById('chart-doughnut').getContext('2d');
            chartInstanceDoughnut = new Chart(ctxD, {
                type: 'doughnut',
                data: { labels: catLabels, datasets: [{ data: catData, backgroundColor: ['#ff453a', '#ff9f0a', '#ffd60a', '#32d74b', '#64d2ff', '#0a84ff', '#5e5ce6', '#bf5af2'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: textColor, font: { size: 10 }, boxWidth: 10 } }, title: { display: true, text: 'Despesas por Categoria', color: textColor } } }
            });

            const ctxB = document.getElementById('chart-bar').getContext('2d');
            chartInstanceBar = new Chart(ctxB, {
                type: 'bar',
                data: { labels: ['Entradas', 'Sa√≠das'], datasets: [{ label: 'Valor', data: [totR, totD], backgroundColor: ['#30d158', '#ff453a'], borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Balan√ßo Mensal', color: textColor } }, scales: { y: { ticks: { color: textColor }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { display: false } } } }
            });
        }

        /* ================= OFFLINE HTML EXPORT (CLEAN) ================= */
        function abrirOpcoesDownload() { openModal('modal-download-options'); }
        function abrirOpcoesReset() { openModal('modal-reset-options'); }

        async function baixarAppHTMLClean() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
            const user = localStorage.getItem('contas_user') || 'Usuario';
            let htmlContent = document.documentElement.outerHTML;
            const injectPattern = /const\s+BACKUP_EMBUTIDO\s*=\s*[\s\S]*?; \/\/ __MARKER_BACKUP__/;
            const resetScript = `const BACKUP_EMBUTIDO = null; // __MARKER_BACKUP__`;
            if (injectPattern.test(htmlContent)) { htmlContent = htmlContent.replace(injectPattern, resetScript); } 
            else { htmlContent = htmlContent.replace(/const\s+BACKUP_EMBUTIDO\s*=\s*null;/, resetScript); }
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `AppFinanceiro_Instalavel.html`; a.click();
        }

        function backupDados() {
            const user = localStorage.getItem('contas_user') || 'Usuario';
            const flags = {};
            ['funnel_seen_5', 'funnel_seen_10', 'funnel_seen_15', 'funnel_seen_30', 'funnel_seen_50', 'funnel_seen_90days', 'funnel_seen_blue_streak'].forEach(k => { const v = localStorage.getItem(k); if(v) flags[k] = v; });
            const start = localStorage.getItem('app_start_date');
            const currentPalette = localStorage.getItem('contas_palette') || 'default';
            const currentTheme = localStorage.getItem('contas_theme') || 'dark';

            Promise.all([getAll('receitas'), getAll('despesas'), getAll('fechamentos')]).then(data => {
                const backupPayload = {
                    r: data[0], d: data[1], f: data[2], u: user,
                    m: { start: start, flags: flags, palette: currentPalette, theme: currentTheme }
                };
                const blob = new Blob([JSON.stringify(backupPayload)], {type: 'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${user}_${new Date().toISOString().slice(0,10)}.json`; a.click();
            });
        }

        function restoreDados(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!confirm(`Restaurar backup de "${data.u || 'Usu√°rio'}"?`)) return;
                    await autoRestoreOffline(data);
                    alert("Restaurado com sucesso!");
                    location.reload();
                } catch(err) { alert("Arquivo inv√°lido."); }
            };
            reader.readAsText(file);
        }

        function realReset() { 
            localStorage.clear(); localStorage.setItem('ignore_embed', 'true');
            const tx=db.transaction(['receitas','despesas','fechamentos'],'readwrite'); 
            tx.objectStore('receitas').clear(); tx.objectStore('despesas').clear(); 
            if(tx.objectStoreNames.contains('fechamentos')) tx.objectStore('fechamentos').clear();
            tx.oncomplete=()=>location.reload(); 
        }

        function removerAcentos(str) { return str.normalize('NFD').replace(/[\u0300-\u036f]/g, ""); }

        async function gerarRelatorioPDF() {
            showToast("Gerando PDF Avan√ßado...");
            const [receitas, despesas] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const mesSel = document.getElementById('filtroMes')?.value || getLocalMonth();
            const user = localStorage.getItem('contas_user') || "Usuario";
            
            const receitasMes = receitas.filter(r => r.data.startsWith(mesSel)).map(x => ({...x, tipo: 'receita'}));
            const despesasMes = despesas.filter(d => d.data.startsWith(mesSel)).map(x => ({...x, tipo: 'despesa'}));
            
            const totalR = safeFloat(receitasMes.reduce((s, i) => s + safeVal(i.val), 0));
            const totalD = safeFloat(despesasMes.reduce((s, i) => s + safeVal(i.val), 0));
            const saldo = safeFloat(totalR - totalD);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const safeText = (txt) => removerAcentos(txt || "");
            const fmtBRL = (val) => "R$ " + val.toFixed(2).replace('.', ',');
            
            // --- DIAGN√ìSTICO FINANCEIRO ---
            let statusFinanceiro = "Equilibrado";
            let corStatus = [100, 100, 100];
            let taxaPoupanca = 0;
            
            if (totalR > 0) {
                taxaPoupanca = ((saldo / totalR) * 100);
            }

            if (saldo < 0) {
                statusFinanceiro = "Cr√≠tico - Gastos Excedentes";
                corStatus = [255, 69, 58]; // Vermelho
            } else if (taxaPoupanca > 20) {
                statusFinanceiro = "Excelente - Investidor";
                corStatus = [48, 209, 88]; // Verde
            } else {
                statusFinanceiro = "Aten√ß√£o - Margem Baixa";
                corStatus = [255, 159, 10]; // Laranja
            }

            // --- CATEGORIAS ---
            const cats = {};
            despesasMes.forEach(d => cats[d.cat] = (cats[d.cat] || 0) + safeVal(d.val));
            const sortedCats = Object.entries(cats).sort((a,b) => b[1] - a[1]); // Ordena maior gasto

            // --- PDF HEADER ---
            // Fundo Branco, Texto Escuro (Padr√£o Relat√≥rio)
            doc.setFillColor(255, 255, 255); 
            doc.rect(0, 0, pageWidth, 297, 'F');
            
            // Cabe√ßalho Roxo
            doc.setFillColor(94, 92, 230); 
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            doc.setTextColor(255, 255, 255); 
            doc.setFontSize(22); doc.setFont("helvetica", 'bold'); 
            doc.text("RELAT√ìRIO FINANCEIRO", 14, 20);
            
            doc.setFontSize(10); doc.setFont("helvetica", 'normal'); 
            doc.text(`Gerado para: ${safeText(user)}`, 14, 28);
            doc.text(`Per√≠odo de Refer√™ncia: ${mesSel}`, 14, 34);
            doc.text(`Data da Emiss√£o: ${new Date().toLocaleDateString()}`, pageWidth - 60, 34);

            let yPos = 55;

            // --- SE√á√ÉO 1: RESUMO EXECUTIVO ---
            doc.setTextColor(50, 50, 50);
            doc.setFontSize(14); doc.setFont("helvetica", 'bold');
            doc.text("Resumo Executivo", 14, yPos);
            yPos += 5;

            const drawCard = (x, label, val, colorRGB) => {
                doc.setDrawColor(200, 200, 200); 
                doc.setFillColor(245, 245, 247); // Cinza bem claro
                doc.roundedRect(x, yPos, 58, 28, 3, 3, 'FD'); 
                
                doc.setFontSize(9); doc.setTextColor(100, 100, 100); 
                doc.text(label, x + 6, yPos + 10);
                
                doc.setFontSize(13); doc.setFont("helvetica", 'bold'); 
                doc.setTextColor(colorRGB[0], colorRGB[1], colorRGB[2]); 
                doc.text(val, x + 6, yPos + 22);
            };

            drawCard(14, "TOTAL ENTRADAS", fmtBRL(totalR), [48, 209, 88]); 
            drawCard(76, "TOTAL SA√çDAS", fmtBRL(totalD), [255, 69, 58]); 
            drawCard(138, "SALDO FINAL", fmtBRL(saldo), saldo >= 0 ? [94, 92, 230] : [255, 69, 58]); 
            
            yPos += 35;

            // --- SE√á√ÉO 2: SA√öDE FINANCEIRA ---
            doc.setDrawColor(corStatus[0], corStatus[1], corStatus[2]);
            doc.setFillColor(corStatus[0], corStatus[1], corStatus[2]);
            doc.rect(14, yPos, 4, 18, 'F'); // Barra lateral colorida status

            doc.setFontSize(11); doc.setTextColor(80, 80, 80); doc.setFont("helvetica", 'normal');
            doc.text("Diagn√≥stico do M√™s:", 22, yPos + 6);
            
            doc.setFontSize(12); doc.setTextColor(corStatus[0], corStatus[1], corStatus[2]); doc.setFont("helvetica", 'bold');
            doc.text(safeText(statusFinanceiro), 22, yPos + 14);

            doc.setFontSize(10); doc.setTextColor(100, 100, 100); doc.setFont("helvetica", 'normal');
            doc.text(`Taxa de Economia: ${taxaPoupanca.toFixed(1)}%`, 140, yPos + 14);

            yPos += 28;

            // --- SE√á√ÉO 3: TOP GASTOS POR CATEGORIA (TABELA) ---
            if (sortedCats.length > 0) {
                doc.setTextColor(50, 50, 50);
                doc.setFontSize(14); doc.setFont("helvetica", 'bold');
                doc.text("Top Gastos por Categoria", 14, yPos);
                yPos += 8;

                const catTableData = sortedCats.map(c => [
                    c[0].charAt(0).toUpperCase() + c[0].slice(1), // Nome Capitalizado
                    fmtBRL(c[1]),
                    ((c[1]/totalD)*100).toFixed(1) + "%" // % do total
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['Categoria', 'Valor Gasto', '% do Total']],
                    body: catTableData,
                    theme: 'grid',
                    headStyles: { fillColor: [80, 80, 80], textColor: [255, 255, 255] },
                    styles: { fontSize: 10, cellPadding: 3 },
                    columnStyles: { 
                        1: { halign: 'right', fontStyle: 'bold', textColor: [255, 69, 58] },
                        2: { halign: 'center' }
                    }
                });
                yPos = doc.lastAutoTable.finalY + 15;
            }

            // --- SE√á√ÉO 4: EXTRATO DETALHADO ---
            doc.setTextColor(50, 50, 50);
            doc.setFontSize(14); doc.setFont("helvetica", 'bold');
            doc.text("Extrato de Lan√ßamentos", 14, yPos);
            yPos += 5;

            const allItems = [...receitasMes, ...despesasMes].sort((a,b) => a.data.localeCompare(b.data));
            const tableData = allItems.map(item => [
                item.data.split('-').reverse().join('/'), 
                safeText(item.desc), 
                safeText(item.cat || "-"),
                item.tipo === 'receita' ? `+ ${fmtBRL(item.val)}` : `- ${fmtBRL(item.val)}`
            ]);

            doc.autoTable({
                startY: yPos, 
                head: [['Data', 'Descri√ß√£o', 'Categoria', 'Valor']], 
                body: tableData, 
                theme: 'striped',
                headStyles: { fillColor: [94, 92, 230] }, 
                styles: { fontSize: 9 }, 
                columnStyles: { 
                    3: { halign: 'right', fontStyle: 'bold' } 
                },
                didParseCell: function(data) {
                    // Pinta de vermelho ou verde o valor
                    if (data.section === 'body' && data.column.index === 3) {
                        const text = data.cell.raw;
                        if (text.includes('+')) data.cell.styles.textColor = [48, 209, 88];
                        else data.cell.styles.textColor = [255, 69, 58];
                    }
                }
            });

            // Tenta adicionar gr√°ficos na √∫ltima p√°gina se poss√≠vel
            try {
                // Aguarda renderiza√ß√£o
                await new Promise(r => setTimeout(r, 200)); 
                const imgDoughnut = document.getElementById('chart-doughnut').toDataURL("image/png");
                
                if(sortedCats.length > 0) {
                    doc.addPage();
                    doc.setFontSize(14); doc.setTextColor(50,50,50);
                    doc.text("Anexo Visual", 14, 20);
                    doc.addImage(imgDoughnut, 'PNG', 40, 30, 130, 130);
                    doc.setFontSize(10); doc.setTextColor(150,150,150);
                    doc.text("Gr√°fico de distribui√ß√£o de gastos por categoria", 105, 170, {align: 'center'});
                }
            } catch(e) { console.log("Gr√°ficos ignorados no PDF"); }

            doc.save(`Relatorio_Pro_${safeText(user)}_${mesSel}.pdf`);
            showToast("PDF Gerado com Sucesso!");
            // location.reload(); // Removido reload for√ßado para melhorar UX
        }

        async function compartilharZap() {
            const [receitas, despesas] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const mesSel = document.getElementById('filtroMes').value;
            const recFiltro = receitas.filter(i=>i.data.startsWith(mesSel));
            const despFiltro = despesas.filter(i=>i.data.startsWith(mesSel));
            const totalR = recFiltro.reduce((s,i)=>s+safeVal(i.val),0);
            const totalD = despFiltro.reduce((s,i)=>s+safeVal(i.val),0);
            const saldo = totalR - totalD;
            let msg = `*Relat√≥rio Financeiro - ${mesSel}*\n\n`;
            msg += `*üü¢ Entradas: R$ ${totalR.toFixed(2)}*\n`;
            msg += `\n*üî¥ Sa√≠das: R$ ${totalD.toFixed(2)}*\n`;
            msg += `\n*üí∞ Saldo Final: R$ ${saldo.toFixed(2)}*`;
            msg += `\n\nüìä Controle suas finan√ßas de gra√ßa: https://oappdopobre.oseuapp.workers.dev`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function showToast(m) { 
            const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; t.style.top = "80px";
            setTimeout(() => { t.style.opacity = 0; t.style.top = "70px"; }, 2500); 
        }

        window.onload = async () => {
            await initDB();
            initTheme();
            const user = localStorage.getItem('contas_user');
            if(!user) openModal('modal-welcome'); else document.getElementById('username-header').innerText = user;
            if(!localStorage.getItem('app_start_date')) localStorage.setItem('app_start_date', new Date().toISOString());
            
            const sel = document.getElementById('filtroMes');
            const hoje = new Date();
            for(let i=0; i<12; i++) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth()-i, 1);
                const s = d.toISOString().slice(0,7);
                sel.add(new Option(d.toLocaleDateString('pt-BR',{month:'long',year:'numeric'}), s));
            }
            
            // Mascara de Input (Moeda) Segura
            document.querySelectorAll('input[type="tel"]').forEach(i => {
                i.addEventListener('input', e => {
                    let v = e.target.value.replace(/\D/g,'');
                    if (v === "") { e.target.value = ""; return; }
                    if (v.length > 15) v = v.slice(0,15);
                    v = (parseInt(v)/100).toFixed(2).replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    e.target.value = v;
                });
            });
            
            // Corre√ß√£o de Fuso Hor√°rio nos Inputs de Data
            const localDate = getLocalDate();
            document.querySelectorAll('input[type="date"]').forEach(i => i.value = localDate);
            
            setupSmartBar();
            
            await fecharMesAutomatico(); // Chama a nova fun√ß√£o de rec√°lculo
            await processarRecorrencias();
            await render();
            navTo('v-ganhar', document.querySelector('.tab.active'));
        };
    </script>
</body>
</html>
