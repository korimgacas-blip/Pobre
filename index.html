
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>O app do Pobre</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f2f2f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            /* Palette Dark (Padr√£o) */
            --primary: #5e5ce6;
            --primary-glow: rgba(94, 92, 230, 0.5);
            --income: #30d158;
            --expense: #ff453a;
            --whatsapp: #25D366;
            
            --bg-base: #000000;
            --text-main: #f5f5f7;
            --text-sec: #8e8e93;
            
            --glass-surface: rgba(28, 28, 30, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            
            --mesh-gradient: radial-gradient(at 0% 0%, rgba(94, 92, 230, 0.25) 0px, transparent 60%), #000000;
            --radius-card: 24px;
        }

        /* TEMA CLARO */
        body.light-theme {
            --bg-base: #f2f2f7;
            --text-main: #111113;
            --text-sec: #58585e;
            
            --glass-surface: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(0, 0, 0, 0.08);
            --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            
            --mesh-gradient: radial-gradient(at 0% 0%, rgba(94, 92, 230, 0.12) 0px, transparent 50%), #f2f2f7;
        }

        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--mesh-gradient);
            background-attachment: fixed;
            margin: 0; padding-top: 65px; padding-bottom: 120px;
            color: var(--text-main);
            transition: background 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
        }

        /* --- HEADER & TERM√îMETRO --- */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: var(--glass-surface);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            z-index: 1000; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; border-bottom: 1px solid var(--glass-border);
            transition: background 0.5s ease, border-color 0.5s ease;
        }
        
        header.header-pos {
            background: linear-gradient(90deg, rgba(59,130,246,0.15), rgba(48,209,88,0.15));
            border-bottom: 1px solid rgba(48, 209, 88, 0.3);
        }
        header.header-neg {
            background: linear-gradient(90deg, rgba(239,68,68,0.15), rgba(255,69,58,0.15));
            border-bottom: 1px solid rgba(255, 69, 58, 0.3);
        }

        .user-area { display: flex; flex-direction: column; justify-content: center; }
        .user-greeting { font-size: 0.7rem; color: var(--text-sec); font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .user-name { font-size: 0.85rem; font-weight: 800; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; }

        #header-title {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-weight: 700; font-size: 0.95rem; color: var(--text-main);
            opacity: 0; animation: fadeIn 0.3s forwards; pointer-events: none;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .status-badge {
            font-size: 0.65rem; font-weight: 800; padding: 1px 5px; border-radius: 4px;
            animation: pulse-status 2s infinite ease-in-out;
        }
        .status-pos { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59,130,246,0.3); }
        .status-neg { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
        @keyframes pulse-status { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        /* --- UI CARDS --- */
        .container { padding: 0 16px; max-width: 600px; margin: 0 auto; }

        .card {
            background: var(--glass-surface); border-radius: var(--radius-card);
            border: 1px solid var(--glass-border); padding: 24px 20px; margin-bottom: 16px;
            box-shadow: var(--card-shadow); backdrop-filter: blur(30px);
        }

        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .dash-card { 
            background: var(--glass-surface); border-radius: 20px; padding: 18px 12px; 
            text-align: center; border: 1px solid var(--glass-border); 
            box-shadow: var(--card-shadow);
        }
        .dash-card small { color: var(--text-sec); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; display: block; }
        .dash-card b { font-size: 1.25rem; letter-spacing: -0.5px; }

        label { font-size: 0.75rem; font-weight: 700; color: var(--text-sec); margin: 0 0 6px 4px; display: block; }
        
        input, select {
            width: 100%; padding: 16px; border-radius: 16px; 
            border: 1px solid rgba(120, 120, 128, 0.1);
            background: rgba(120, 120, 128, 0.08); 
            color: var(--text-main); font-size: 1rem; outline: none; margin-bottom: 16px;
            transition: all 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); background: rgba(120, 120, 128, 0.12); }
        
        button {
            width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.95rem; transition: transform 0.1s, opacity 0.2s;
        }
        button:active { transform: scale(0.98); }
        
        .btn-income { background: var(--income); color: #fff; }
        .btn-expense { background: var(--expense); color: #fff; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-whatsapp { background: var(--whatsapp); color: #fff; margin-top: 10px; }
        .btn-offline { background: #333; color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        body.light-theme .btn-offline { background: #e5e5ea; color: #000; border: 1px solid rgba(0,0,0,0.1); }
        .btn-sec { background: rgba(120, 120, 128, 0.15); color: var(--text-main); }
        .btn-danger { background: rgba(255, 69, 58, 0.15); color: #ff453a; border: 1px solid rgba(255,69,58,0.3); }
        
        /* Charts Container */
        .chart-container { position: relative; height: 200px; width: 100%; margin-bottom: 20px; }
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 500px) { .chart-grid { grid-template-columns: 1fr 1fr; } }
        
        /* Empty State GIF */
        .empty-state { text-align: center; padding: 20px; opacity: 0.7; }
        .empty-state img { max-width: 150px; border-radius: 15px; mix-blend-mode: luminosity; }
        .empty-state p { margin-top: 10px; font-size: 0.8rem; color: var(--text-sec); }

        /* Footer Style */
        .app-footer {
            margin-top: 30px; border-top: 1px solid var(--glass-border); padding-top: 20px;
            text-align: center; color: var(--text-sec); font-size: 0.7rem; line-height: 1.6;
        }
        .app-footer strong { color: var(--primary); }

        /* Smart Action Bar */
        .smart-action-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 12px 16px; background: var(--glass-surface);
            border-top: 1px solid var(--glass-border); backdrop-filter: blur(30px);
            z-index: 2000; transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; gap: 10px;
        }
        .smart-action-bar.visible { transform: translateY(0); }

        /* Tiers */
        .tiers-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
        @media (min-width: 480px) { .tiers-grid { grid-template-columns: 1fr 1fr; } }
        .tier-card { 
            background: var(--glass-surface); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 15px; position: relative;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .tier-qr { width: 120px; height: 120px; border-radius: 12px; margin-top: 10px; background: #fff; padding: 5px;}
        .badge-popular { 
            position: absolute; top: 0; right: 0; background: var(--income); color: white; 
            font-size: 0.6rem; padding: 4px 8px; border-bottom-left-radius: 10px; font-weight: 700;
        }

        /* Nav */
        nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px; height: 70px;
            background: var(--glass-surface); backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); border-radius: 35px;
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
            box-shadow: var(--card-shadow); transition: transform 0.3s;
        }
        nav.hidden { transform: translateY(150%); }
        .tab { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-sec); font-size: 0.65rem; opacity: 0.7; transition: 0.2s; }
        .tab.active { color: var(--primary); font-weight: 700; opacity: 1; transform: translateY(-2px); }
        .tab i { font-size: 1.3rem; }

        .view { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .view.active { display: block; opacity: 1; transform: translateY(0); }

        .item { display: flex; justify-content: space-between; padding: 16px 8px; border-bottom: 1px solid rgba(120,120,128,0.1); cursor: pointer; }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000;
            display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--glass-surface); color: var(--text-main);
            width: 100%; max-width: 400px; border-radius: 30px; padding: 30px 25px;
            max-height: 85vh; overflow-y: auto; border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .guide-item { background: rgba(120, 120, 128, 0.05); border-radius: 16px; margin-bottom: 10px; border: 1px solid var(--glass-border); overflow: hidden; }
        .guide-header { padding: 15px; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .guide-content { padding: 0 15px 15px; font-size: 0.85rem; color: var(--text-sec); display: none; line-height: 1.6; border-top: 1px solid var(--glass-border); }
        .guide-item.active .guide-content { display: block; background: rgba(120, 120, 128, 0.03); }

        #toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 24px; border-radius: 50px; opacity: 0; z-index: 5000; transition: 0.3s; font-size: 0.85rem; font-weight: 600; pointer-events: none; white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <div id="blocker" class="modal-overlay" style="text-align: center; z-index: 9999; display: none;">
        <div class="modal-content">
            <div style="font-size: 3rem;">üõë</div>
            <h2 style="font-size: 1.3rem; margin: 10px 0;">Acesso Interrompido</h2>
            <p style="color: var(--text-sec); font-size: 0.9rem;">O app j√° est√° aberto em outra aba.<br>Use apenas uma para evitar conflitos.</p>
            <button class="btn-primary" onclick="tentarDesbloquear()" style="margin-top: 20px;">Tentar Novamente</button>
        </div>
    </div>

    <header id="main-header">
        <div class="user-area">
            <div class="user-greeting">
                <span id="status-icon" class="status-badge" style="display: none;">-1</span>
                Ol√°,
            </div>
            <div class="user-name" id="username-header">...</div>
        </div>
        
        <div id="header-title"></div> 
        <i class="fas fa-circle-half-stroke" onclick="toggleTheme()" style="cursor: pointer; font-size: 1.2rem; color: var(--primary); padding: 10px;"></i>
    </header>

    <div class="container">
        
        <div id="dashboard-main" class="dashboard">
            <div class="dash-card">
                <small>Saldo Total</small>
                <b id="dash-saldo">R$ 0,00</b>
            </div>
            <div class="dash-card">
                <small>Sa√≠da (M√™s)</small>
                <b id="dash-gastos" style="color: var(--expense);">R$ 0,00</b>
            </div>
        </div>

        <div id="v-ganhar" class="view active">
            <div class="card">
                <h3 id="form-title-ganhar" style="margin:0; color: var(--income); font-size: 1.1rem; margin-bottom: 20px;"><i class="fas fa-plus-circle"></i> Nova Receita</h3>
                <input type="hidden" id="edit-id-ganhar">
                
                <label>Descri√ß√£o</label>
                <input type="text" id="desc-ganhar" placeholder="Ex: Sal√°rio, Venda" autocomplete="off">
                
                <label>Valor (R$)</label>
                <input type="tel" id="val-ganhar" inputmode="numeric" placeholder="0,00">
                
                <label>Data</label>
                <input type="date" id="data-ganhar">
                
                <div style="height: 10px;"></div>
                <button id="btn-save-ganhar" class="btn-income" onclick="salvar('ganhar')">Salvar Receita</button>
                <button id="btn-cancel-ganhar" class="btn-sec hidden" onclick="cancelarEdicao('ganhar')" style="margin-top:10px;">Cancelar</button>
            </div>
        </div>

        <div id="v-gastar" class="view">
            <div class="card">
                <h3 id="form-title-gastar" style="margin:0; color: var(--expense); font-size: 1.1rem; margin-bottom: 20px;"><i class="fas fa-minus-circle"></i> Novo Gasto</h3>
                <input type="hidden" id="edit-id-gastar">
                
                <label>Descri√ß√£o</label>
                <input type="text" id="desc-gastar" placeholder="Ex: Mercado, Luz" autocomplete="off">
                
                <label>Categoria</label>
                <select id="cat-gastar">
                    <option value="alimentacao">üçï Alimenta√ß√£o</option>
                    <option value="transporte">üöó Transporte</option>
                    <option value="lazer">üçø Lazer</option>
                    <option value="contas">üßæ Contas</option>
                    <option value="casa">üè† Casa</option>
                    <option value="saude">üíä Sa√∫de</option>
                    <option value="edu">üìö Educa√ß√£o</option>
                    <option value="outros">üõí Outros</option>
                </select>
                
                <label>Valor (R$)</label>
                <input type="tel" id="val-gastar" inputmode="numeric" placeholder="0,00">
                
                <label>Data</label>
                <input type="date" id="data-gastar">
                
                <div style="height: 10px;"></div>
                <button id="btn-save-gastar" class="btn-expense" onclick="salvar('gastar')">Confirmar Gasto</button>
                <button id="btn-cancel-gastar" class="btn-sec hidden" onclick="cancelarEdicao('gastar')" style="margin-top:10px;">Cancelar</button>
            </div>
        </div>

        <div id="v-analise" class="view">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                    <h3 style="margin:0; font-size: 1rem;">Vis√£o Geral</h3>
                    <select id="filtroMes" onchange="render()" style="width: auto; padding: 5px; background: transparent; border: none; font-weight: 700; color: var(--primary);"></select>
                </div>
                
                <div id="charts-wrapper">
                    <div class="chart-grid">
                        <div class="chart-container">
                            <canvas id="chart-doughnut"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="chart-bar"></canvas>
                        </div>
                    </div>
                </div>

                <div id="empty-state" class="empty-state hidden">
                    <img src="https://media.giphy.com/media/26hkhKd9CQeREKsWk/giphy.gif" alt="Sem dados">
                    <p>Nada por aqui ainda...<br>Cadastre uma receita ou despesa!</p>
                </div>

                <div id="lista-detalhada" style="margin-top: 25px; border-top: 1px solid var(--glass-border); padding-top: 15px;"></div>
            </div>

            <div class="card">
                <h3 style="margin-top:0">Dados & Exporta√ß√£o</h3>
                
                <button class="btn-primary" onclick="gerarRelatorioPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                <button class="btn-whatsapp" onclick="compartilharZap()"><i class="fab fa-whatsapp"></i> Enviar Resumo no Zap</button>
                <button class="btn-offline" onclick="abrirOpcoesDownload()" style="margin-top:10px"><i class="fas fa-download"></i> Baixar App Completo (HTML)</button>
                
                <div style="border-top: 1px solid var(--glass-border); margin: 20px 0; padding-top: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn-sec" onclick="backupDados()"><i class="fas fa-download"></i> Backup</button>
                        <button class="btn-sec" onclick="document.getElementById('file-restore').click()"><i class="fas fa-upload"></i> Restaurar</button>
                    </div>
                    
                    <input type="file" id="file-restore" class="hidden" accept=".json" onchange="restoreDados(this)">
                    
                    <button class="btn-danger" onclick="abrirOpcoesReset()" style="margin-top:10px; width:100%"><i class="fas fa-trash"></i> Resetar Tudo</button>
                </div>
            </div>
        </div>

        <div id="v-apoie" class="view">
            <div class="card">
                <h3 style="margin:0; font-size: 1.1rem;"><i class="fas fa-rocket"></i> Guia Pro</h3>
                <p style="font-size: 0.85rem; color: var(--text-sec); margin: 10px 0;">Aprenda a instalar o app e dominar suas finan√ßas.</p>
                <button class="btn-primary" onclick="openModal('modal-tutorial')"><i class="fas fa-book"></i> Abrir Guia & Manual</button>
            </div>

            <div class="card">
                <h4 style="color: var(--primary); margin: 0 0 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-gift"></i> Escolha como fortalecer
                </h4>
                
                <div class="tiers-grid">
                    <div class="tier-card">
                        <div class="tier-icon">‚òï</div>
                        <div class="tier-title">O Caf√© da Firma</div>
                        <div class="tier-price">R$ 5,00 a R$ 10,00</div>
                        <div class="tier-description">Ajuda a manter o dev acordado programando novas fun√ß√µes!</div>
                        <img src="qrcode.png" class="tier-qr" onclick="zoomPix(this.src, 'O Caf√© da Firma ‚òï (PIX via Banco)')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
                        <div class="zoom-hint" onclick="zoomPix(this.previousElementSibling.src, 'O Caf√© da Firma ‚òï (PIX via Banco)')"><i class="fas fa-search-plus"></i> Ampliar</div>
                    </div>

                    <div class="tier-card" style="background: rgba(48, 209, 88, 0.08); border-color: var(--income);">
                        <div class="badge-popular">‚ú® Popular</div>
                        <div class="tier-icon">ü•™</div>
                        <div class="tier-title">O Lanche</div>
                        <div class="tier-price">R$ 15,00 a R$ 25,00</div>
                        <div class="tier-description">Mais barato que taxa de banco! Retribua pelas horas economizadas.</div>
                        <img src="qrcode.png" class="tier-qr" onclick="zoomPix(this.src, 'O Lanche ü•™ (PIX via Banco)')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
                        <div class="zoom-hint" onclick="zoomPix(this.previousElementSibling.src, 'O Lanche ü•™ (PIX via Banco)')"><i class="fas fa-search-plus"></i> Ampliar</div>
                    </div>

                    <div class="tier-card" style="background: rgba(255, 214, 10, 0.08); border-color: #ffd60a;">
                        <div class="tier-icon">üëë</div>
                        <div class="tier-title">Quer novos recursos e funcionalidades.</div>
                        <div class="tier-price">R$ 50,00+</div>
                        <div class="tier-description">Para quem virou f√£ e quer garantir os melhores recursos</div>
                        <img src="qrcode.png" class="tier-qr" onclick="zoomPix(this.src, 'Patr√£o do App üëë (PIX via Banco)')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
                        <div class="zoom-hint" onclick="zoomPix(this.previousElementSibling.src, 'Patr√£o do App üëë (PIX via Banco)')"><i class="fas fa-search-plus"></i> Ampliar</div>
                        
                        <button onclick="window.open('https://wa.me/5547996057007', '_blank')" style="background: var(--whatsapp); color: white; padding: 10px; margin-top: 10px; font-size: 0.75rem;">
                            <i class="fab fa-whatsapp"></i> contato com o dev
                        </button>
                        <div style="font-size: 0.6rem; color: var(--text-sec); margin-top: 5px;">novos recursos</div>
                    </div>
                </div>

                <div class="app-footer">
                    <p>Feito com c√≥digo limpo e foco total na sua liberdade financeira.<br>
                    <strong>Privacidade Absoluta:</strong> Seus dados financeiros vivem no seu bolso (Local Storage), n√£o na nossa nuvem. Ningu√©m, al√©m de voc√™, tem acesso.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="smart-bar" class="smart-action-bar">
        <button id="smart-save-btn" class="btn-primary" onclick="triggerSmartSave()">
            <i class="fas fa-check"></i> CONFIRMAR
        </button>
        <button class="btn-sec" style="width: 50px;" onclick="document.activeElement.blur()"><i class="fas fa-keyboard"></i></button>
    </div>

    <nav id="main-nav">
        <div class="tab active" onclick="navTo('v-ganhar',this)"><i class="fas fa-arrow-up"></i><span>Ganhar</span></div>
        <div class="tab" onclick="navTo('v-gastar',this)"><i class="fas fa-arrow-down"></i><span>Gastar</span></div>
        <div class="tab" onclick="navTo('v-analise',this)"><i class="fas fa-chart-pie"></i><span>An√°lise</span></div>
        <div class="tab" onclick="navTo('v-apoie',this)"><i class="fas fa-heart"></i><span>Apoie</span></div>
    </nav>

    <div id="modal-download-options" class="modal-overlay" onclick="closeModal('modal-download-options')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üì¶</div>
            <h3 style="margin-top:0">Leve o App com Voc√™</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 25px;">
                Escolha como deseja salvar seu app e seus dados:
            </p>
            <button class="btn-sec" onclick="backupDados(); closeModal('modal-download-options')" style="margin-bottom: 10px;">
                <i class="fas fa-download"></i> Backup dos Dados (.json)
                <div style="font-size: 0.65rem; font-weight: 400; margin-top: 2px; opacity: 0.7;">Salve apenas seus lan√ßamentos</div>
            </button>
            <button class="btn-offline" onclick="baixarAppHTMLClean(); closeModal('modal-download-options')">
                <i class="fas fa-code"></i> App Instal√°vel (.html)
                <div style="font-size: 0.65rem; font-weight: 400; margin-top: 2px; opacity: 0.7;">Vers√£o limpa do app, sem dados</div>
            </button>
            <button class="btn-sec" onclick="closeModal('modal-download-options')" style="margin-top:20px; border:none; background:transparent;">Cancelar</button>
        </div>
    </div>

    <div id="modal-reset-options" class="modal-overlay" onclick="closeModal('modal-reset-options')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <h3 style="margin-top:0">Zona de Perigo</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 25px;">
                Voc√™ est√° prestes a apagar tudo. Recomendamos fortemente fazer um backup dos dados antes.
            </p>
            <button class="btn-sec" onclick="backupDados()" style="margin-bottom: 10px; border-color: var(--primary); color: var(--primary);">
                <i class="fas fa-save"></i> Fazer Backup de Seguran√ßa (.json)
            </button>
            <button class="btn-danger" onclick="realReset()" style="margin-top:10px; background: var(--expense); color: white;">
                <i class="fas fa-bomb"></i> Apagar Tudo e Reiniciar
            </button>
            <button class="btn-sec" onclick="closeModal('modal-reset-options')" style="margin-top:15px; border:none; background:transparent;">Cancelar</button>
        </div>
    </div>

    <div id="modal-tutorial" class="modal-overlay" onclick="closeModal('modal-tutorial')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-top:0">Guia de Instala√ß√£o</h3>
            <div style="margin-bottom: 25px;">
                <div class="guide-item active" onclick="toggleGuide(this)">
                    <div class="guide-header">üì± iPhone (iOS) <i class="fas fa-chevron-down"></i></div>
                    <div class="guide-content">1. Toque no bot√£o <b>Compartilhar</b>.<br>2. Selecione <b>"Adicionar √† Tela de In√≠cio"</b>.<br>3. Confirme.</div>
                </div>
                <div class="guide-item" onclick="toggleGuide(this)">
                    <div class="guide-header">ü§ñ Android (Chrome) <i class="fas fa-chevron-down"></i></div>
                    <div class="guide-content">1. Toque nos <b>3 pontinhos</b>.<br>2. Selecione <b>"Instalar aplicativo"</b>.</div>
                </div>
                <div class="guide-item" onclick="toggleGuide(this)">
                    <div class="guide-header">üåê Samsung Internet <i class="fas fa-chevron-down"></i></div>
                    <div class="guide-content">1. Menu (3 linhas).<br>2. <b>"Adicionar p√°gina a"</b> -> <b>"Tela de Apps"</b>.</div>
                </div>
                <div class="guide-item" onclick="toggleGuide(this)">
                    <div class="guide-header">üüß Xiaomi (Mi) <i class="fas fa-chevron-down"></i></div>
                    <div class="guide-content">1. Ferramentas (barra inferior).<br>2. <b>"Adicionar atalho"</b>.</div>
                </div>
            </div>

            <div class="tutorial-list">
                <h3>Manual</h3>
                <h4><i class="fas fa-arrow-up"></i> Registrar Receitas</h4>
                <ul><li><i class="fas fa-pencil-alt"></i> <div><b>Aba "Ganhar":</b> preencha e clique em Salvar.</div></li></ul>
                <h4><i class="fas fa-arrow-down"></i> Registrar Despesas</h4>
                <ul><li><i class="fas fa-pencil-alt"></i> <div><b>Aba "Gastar":</b> descri√ß√£o, categoria e valor.</div></li></ul>
                <h4><i class="fas fa-pen"></i> Editar e Excluir</h4>
                <ul><li><i class="fas fa-mouse-pointer"></i> <div>Na aba <b>"An√°lise"</b>, clique no item para editar.</div></li></ul>
                <h4><i class="fas fa-database"></i> Dados</h4>
                <ul>
                    <li><i class="fas fa-file-pdf"></i> <div><b>PDF:</b> Relat√≥rio completo para impress√£o.</div></li>
                    <li><i class="fab fa-whatsapp"></i> <div><b>Zap:</b> Envia um resumo detalhado em texto.</div></li>
                    <li><i class="fas fa-calendar-check"></i> <div><b>Ritual da Riqueza:</b> Toda sexta-feira ou dia 05, gere o PDF e mande no grupo da fam√≠lia. O gr√°fico bonito motiva!</div></li>
                    <li><i class="fas fa-lock"></i> <div><b>Privacidade:</b> Dados 100% offline no seu aparelho.</div></li>
                </ul>
            </div>
            <button class="btn-primary" onclick="closeModal('modal-tutorial')" style="margin-top:20px">Fechar</button>
        </div>
    </div>

    <div id="modal-welcome" class="modal-overlay">
        <div class="modal-content" style="text-align:center">
            <div style="font-size:3rem">üëã</div>
            <h2>Bem-vindo</h2>
            <p>Como voc√™ quer ser chamado?</p>
            <input type="text" id="user-in" placeholder="Seu nome" style="text-align:center">
            <button class="btn-primary" onclick="initUser()" style="margin-top:20px">Acessar App</button>
        </div>
    </div>

    <div id="modal-cafe" class="modal-overlay" onclick="closeModal('modal-cafe')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <div style="font-size:3rem; margin-bottom: 10px;">üéâ</div>
            <h3 style="margin-top:0">Momento do Caf√©!</h3>
            <p style="color: var(--text-sec); font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px;">
                O app j√° te ajudou a registrar <b id="cafe-count" style="color: var(--text-main);">30</b> contas! Que tal pagar um cafezinho (R$ 5) pro desenvolvedor continuar mantendo o app sem an√∫ncios?
            </p>
            <img src="qrcode.png" class="tier-qr" onclick="zoomPix(this.src, 'O Caf√© da Firma ‚òï (PIX via Banco)')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
            <div class="zoom-hint" onclick="zoomPix(this.previousElementSibling.src, 'O Caf√© da Firma ‚òï (PIX via Banco)')"><i class="fas fa-search-plus"></i> Ampliar</div>
            <button class="btn-primary" onclick="closeModal('modal-cafe')" style="margin-top:20px">Fechar</button>
        </div>
    </div>

    <div id="modal-pix" class="modal-overlay" onclick="closeModal('modal-pix')">
        <div class="modal-content" style="text-align:center" onclick="event.stopPropagation()">
            <h3 id="pix-tit" style="margin-bottom: 5px;">Apoio</h3>
            <p style="font-size: 0.8rem; color: var(--text-sec); margin-top: 0; margin-bottom: 15px;">
                <i class="fas fa-university"></i> Abra o app do seu banco para pagar via PIX
            </p>
            <img id="pix-img" src="" style="width:200px; height:200px; background:white; padding:10px; border-radius:15px; border:1px solid #ddd; margin: 0 auto; display: block;">
            <button class="btn-primary" onclick="closeModal('modal-pix')" style="margin-top:20px">Fechar</button>
        </div>
    </div>

    <div id="toast">Notifica√ß√£o</div>

    <script>
        let db;
        const channel = new BroadcastChannel('contas_pro_sync');
        const FORMAT = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        let chartInstanceDoughnut = null;
        let chartInstanceBar = null;
        
        const BACKUP_EMBUTIDO = null; // __MARKER_BACKUP__

        /* ================= SECURITY & MULTI-TAB LOGIC ================= */
        let isBlocked = false;
        let isUnloading = false;

        document.getElementById('blocker').style.display = 'none';
        window.addEventListener('beforeunload', () => { isUnloading = true; });

        channel.onmessage = (e) => {
            if (e.data === 'ping') {
                if (!isBlocked && !isUnloading) channel.postMessage('pong');
            }
            if (e.data === 'pong') {
                isBlocked = true;
                document.getElementById('blocker').style.display = 'flex';
            }
        };

        function tentarDesbloquear() {
            isBlocked = false;
            document.getElementById('blocker').style.display = 'none';
            channel.postMessage('ping');
        }
        
        setTimeout(() => channel.postMessage('ping'), 500);

        /* ================= DB INIT & OFFLINE RESTORE ================= */
        async function initDB() {
            return new Promise((resolve) => {
                const req = indexedDB.open("ContasProDB", 7);
                req.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains("receitas")) db.createObjectStore("receitas", { keyPath: "id", autoIncrement: true });
                    if (!db.objectStoreNames.contains("despesas")) db.createObjectStore("despesas", { keyPath: "id", autoIncrement: true });
                };
                req.onsuccess = async e => { 
                    db = e.target.result; 
                    const ignore = localStorage.getItem('ignore_embed');
                    if (BACKUP_EMBUTIDO && typeof BACKUP_EMBUTIDO === 'object' && !ignore) {
                        await autoRestoreOffline(BACKUP_EMBUTIDO);
                    }
                    resolve(); 
                };
                req.onerror = () => alert("Erro cr√≠tico no banco de dados.");
            });
        }

        async function autoRestoreOffline(data) {
            return new Promise(resolve => {
                const tx = db.transaction(['receitas', 'despesas'], 'readwrite');
                tx.objectStore('receitas').clear();
                tx.objectStore('despesas').clear();
                
                if(data.u) localStorage.setItem('contas_user', data.u);
                
                // Sanitiza√ß√£o Robusta (Evita NaN)
                const normalize = (item) => ({
                    desc: item.desc || item.descricao,
                    val: parseFloat(item.val || item.valor) || 0,
                    data: item.data,
                    cat: item.cat || item.categoria
                });

                (data.r || data.receitas || []).forEach(i => tx.objectStore('receitas').add(normalize(i)));
                (data.d || data.despesas || []).forEach(i => tx.objectStore('despesas').add(normalize(i)));
                
                tx.oncomplete = () => {
                    showToast("Dados restaurados do Backup Offline!");
                    resolve();
                };
            });
        }

        async function getAll(store) {
            if(!db) return [];
            const tx = db.transaction(store, "readonly");
            return new Promise(r => { const req = tx.objectStore(store).getAll(); req.onsuccess = () => r(req.result || []); });
        }

        /* ================= CORE UI ================= */
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('contas_theme', isLight ? 'light' : 'dark');
            showToast(isLight ? "Modo Leitura" : "Modo Escuro");
            render();
        }

        function navTo(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            
            const titles = { "v-ganhar": "Nova Receita", "v-gastar": "Novo Gasto", "v-analise": "An√°lise Financeira", "v-apoie": "Central de Apoio" };
            const titleEl = document.getElementById("header-title");
            titleEl.style.display = 'none';
            setTimeout(() => { titleEl.innerText = titles[id]; titleEl.style.display = 'block'; }, 50);

            if(id === 'v-analise') render();
            window.scrollTo(0,0);
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleGuide(el) { document.querySelectorAll('.guide-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); }
        function zoomPix(src, tit) { document.getElementById('pix-img').src = src; document.getElementById('pix-tit').innerText = tit; openModal('modal-pix'); }

        function setupSmartBar() {
            const inputs = document.querySelectorAll('input, select');
            const bar = document.getElementById('smart-bar');
            const nav = document.getElementById('main-nav');
            inputs.forEach(i => {
                i.addEventListener('focus', () => { 
                    if(document.querySelector('.view.active').id !== 'v-analise'){ bar.classList.add('visible'); nav.classList.add('hidden'); }
                });
                i.addEventListener('blur', () => { 
                    setTimeout(() => { if(!document.activeElement.tagName.match(/INPUT|SELECT/)){ bar.classList.remove('visible'); nav.classList.remove('hidden'); }}, 100);
                });
            });
        }

        function triggerSmartSave() {
            if (navigator.vibrate) navigator.vibrate(20);
            const current = document.querySelector('.view.active').id;
            if(current === 'v-ganhar') salvar('ganhar');
            if(current === 'v-gastar') salvar('gastar');
            document.activeElement.blur();
        }

        /* ================= LOGIC ================= */
        function initUser() {
            const name = document.getElementById('user-in').value.trim();
            if(!name) return;
            localStorage.setItem('contas_user', name);
            localStorage.removeItem('ignore_embed');
            closeModal('modal-welcome');
            location.reload();
        }

        async function salvar(tipo) {
            const editId = document.getElementById(`edit-id-${tipo}`).value;
            const desc = document.getElementById(`desc-${tipo}`).value;
            const val = parseFloat(document.getElementById(`val-${tipo}`).value.replace(/\./g,'').replace(',','.')) || 0;
            const data = document.getElementById(`data-${tipo}`).value;
            const cat = tipo === 'ganhar' ? 'salario' : document.getElementById('cat-gastar').value;

            if(!desc || val <= 0 || !data) { showToast("Preencha todos os campos!"); return; }

            const tx = db.transaction(tipo === 'ganhar' ? "receitas" : "despesas", "readwrite");
            const store = tx.objectStore(tipo === 'ganhar' ? "receitas" : "despesas");
            const obj = { desc, val, data, cat };
            if(editId) obj.id = parseInt(editId);
            
            store.put(obj);
            
            tx.oncomplete = () => {
                showToast(editId ? "Atualizado!" : "Salvo!");
                cancelarEdicao(tipo);
                render();
                
                if (!editId) {
                    Promise.all([getAll("receitas"), getAll("despesas")]).then(([r, d]) => {
                        const totalContas = r.length + d.length;
                        if (totalContas > 0 && totalContas % 30 === 0) {
                            document.getElementById('cafe-count').innerText = totalContas;
                            openModal('modal-cafe');
                        }
                    });
                }
            };
        }

        function cancelarEdicao(tipo) {
            document.getElementById(`edit-id-${tipo}`).value = "";
            document.getElementById(`desc-${tipo}`).value = "";
            document.getElementById(`val-${tipo}`).value = "";
            document.getElementById(`btn-cancel-${tipo}`).classList.add('hidden');
            document.getElementById(`btn-save-${tipo}`).innerText = tipo === 'ganhar' ? "Salvar Receita" : "Confirmar Gasto";
            document.getElementById(`form-title-${tipo}`).innerHTML = tipo === 'ganhar' ? '<i class="fas fa-plus-circle"></i> Nova Receita' : '<i class="fas fa-minus-circle"></i> Novo Gasto';
        }

        function openEdit(item) {
            const tipo = item.t === 'r' ? 'ganhar' : 'gastar';
            navTo(`v-${tipo}`, document.querySelectorAll('.tab')[tipo === 'ganhar' ? 0 : 1]);
            
            document.getElementById(`edit-id-${tipo}`).value = item.id;
            document.getElementById(`desc-${tipo}`).value = item.desc;
            document.getElementById(`val-${tipo}`).value = item.val.toFixed(2).replace('.', ',');
            document.getElementById(`data-${tipo}`).value = item.data;
            if(tipo === 'gastar') document.getElementById('cat-gastar').value = item.cat;
            
            document.getElementById(`btn-cancel-${tipo}`).classList.remove('hidden');
            document.getElementById(`btn-save-${tipo}`).innerText = "Atualizar Item";
            document.getElementById(`form-title-${tipo}`).innerText = "Editando Item";
        }

        function safeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        async function render() {
            if(!db) return;
            const [receitas, despesas] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const filtro = document.getElementById('filtroMes').value || new Date().toISOString().slice(0,7);
            
            const recFiltro = receitas.filter(r => r.data.startsWith(filtro));
            const despFiltro = despesas.filter(d => d.data.startsWith(filtro));

            const totalR = receitas.reduce((s, i) => s + i.val, 0);
            const totalD = despesas.reduce((s, i) => s + i.val, 0);
            const saldo = totalR - totalD;

            document.getElementById('dash-saldo').innerText = FORMAT.format(saldo);
            document.getElementById('dash-gastos').innerText = FORMAT.format(despFiltro.reduce((s,i)=>s+i.val,0));

            // TERM√îMETRO DE HUMILDADE (HEADER DIN√ÇMICO)
            const header = document.getElementById('main-header');
            const badge = document.getElementById('status-icon');
            
            if(saldo >= 0) {
                header.classList.remove('header-neg');
                header.classList.add('header-pos');
                badge.innerText = '+1';
                badge.className = 'status-badge status-pos';
            } else {
                header.classList.remove('header-pos');
                header.classList.add('header-neg');
                badge.innerText = '-1';
                badge.className = 'status-badge status-neg';
            }
            badge.style.display = 'inline-block';

            updateCharts(recFiltro, despFiltro);

            const list = document.getElementById('lista-detalhada');
            list.innerHTML = "";
            const items = [...recFiltro.map(i=>({...i,t:'r'})), ...despFiltro.map(i=>({...i,t:'d'}))].sort((a,b)=>b.data.localeCompare(a.data));

            if(items.length === 0) list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-sec);">Sem lan√ßamentos neste m√™s.</div>`;

            items.forEach(i => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<div><b>${safeHtml(i.desc)}</b><br><small>${i.data.split('-').reverse().join('/')}</small></div>
                                 <div style="color:${i.t==='r'?'var(--income)':'var(--expense)'}; font-weight:800">${i.t==='r'?'+':'-'} ${FORMAT.format(i.val)}</div>`;
                div.onclick = () => { if(confirm("Editar este item?")) openEdit(i); };
                list.appendChild(div);
            });
        }

        function updateCharts(receitas, despesas) {
            const hasData = receitas.length > 0 || despesas.length > 0;
            const wrapper = document.getElementById('charts-wrapper');
            const empty = document.getElementById('empty-state');
            
            if(!hasData) {
                wrapper.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            } else {
                wrapper.classList.remove('hidden');
                empty.classList.add('hidden');
            }

            const isDark = !document.body.classList.contains('light-theme');
            const textColor = isDark ? '#e5e5e5' : '#333333';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

            const cats = {};
            despesas.forEach(d => cats[d.cat] = (cats[d.cat] || 0) + d.val);
            const catLabels = Object.keys(cats).map(c => c.charAt(0).toUpperCase() + c.slice(1));
            const catData = Object.values(cats);

            const totR = receitas.reduce((s,i) => s + i.val, 0);
            const totD = despesas.reduce((s,i) => s + i.val, 0);

            if(chartInstanceDoughnut) chartInstanceDoughnut.destroy();
            if(chartInstanceBar) chartInstanceBar.destroy();

            const ctxD = document.getElementById('chart-doughnut').getContext('2d');
            chartInstanceDoughnut = new Chart(ctxD, {
                type: 'doughnut',
                data: {
                    labels: catLabels,
                    datasets: [{
                        data: catData,
                        backgroundColor: ['#ff453a', '#ff9f0a', '#ffd60a', '#32d74b', '#64d2ff', '#0a84ff', '#5e5ce6', '#bf5af2'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%', // Mais moderno
                    plugins: { 
                        legend: { position: 'right', labels: { color: textColor, font: { size: 10 }, boxWidth: 10 } },
                        title: { display: true, text: 'Despesas por Categoria', color: textColor } 
                    }
                }
            });

            const ctxB = document.getElementById('chart-bar').getContext('2d');
            chartInstanceBar = new Chart(ctxB, {
                type: 'bar',
                data: {
                    labels: ['Entradas', 'Sa√≠das'],
                    datasets: [{
                        label: 'Valor',
                        data: [totR, totD],
                        backgroundColor: ['#30d158', '#ff453a'],
                        borderRadius: 10, // Arredondado
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: 'Balan√ßo Mensal', color: textColor } },
                    scales: {
                        y: { ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            });
        }

        /* ================= OFFLINE HTML EXPORT (CLEAN) ================= */
        function abrirOpcoesDownload() {
            openModal('modal-download-options');
        }

        function abrirOpcoesReset() {
            openModal('modal-reset-options');
        }

        async function baixarAppHTMLClean() {
            // FOR√áAR FECHAMENTO DE MODAIS ANTES DE CAPTURAR O HTML
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
            
            const user = localStorage.getItem('contas_user') || 'Usuario';
            
            // Pega o c√≥digo atual da p√°gina (agora limpo de modais abertos)
            let htmlContent = document.documentElement.outerHTML;
            
            // Garante que a vari√°vel BACKUP_EMBUTIDO esteja como null
            const injectPattern = /const\s+BACKUP_EMBUTIDO\s*=\s*[\s\S]*?; \/\/ __MARKER_BACKUP__/;
            const resetScript = `const BACKUP_EMBUTIDO = null; // __MARKER_BACKUP__`;
            
            if (injectPattern.test(htmlContent)) {
                htmlContent = htmlContent.replace(injectPattern, resetScript);
            } else {
                const fallbackPattern = /const\s+BACKUP_EMBUTIDO\s*=\s*null;/;
                htmlContent = htmlContent.replace(fallbackPattern, resetScript);
            }
            
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `AppFinanceiro_Instalavel.html`;
            a.click();
        }

        function backupDados() {
            const user = localStorage.getItem('contas_user') || 'Usuario';
            Promise.all([getAll('receitas'), getAll('despesas')]).then(data => {
                const blob = new Blob([JSON.stringify({r: data[0], d: data[1], u: user})], {type: 'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `backup_${user}_${new Date().toISOString().slice(0,10)}.json`; a.click();
            });
        }

        function restoreDados(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!confirm(`Restaurar backup de "${data.u || 'Usu√°rio'}"?`)) return;
                    const tx = db.transaction(['receitas', 'despesas'], 'readwrite');
                    tx.objectStore('receitas').clear(); tx.objectStore('despesas').clear();
                    
                    const normalize = (item) => ({
                        desc: item.desc || item.descricao,
                        val: parseFloat(item.val || item.valor) || 0, // Sanitiza√ß√£o NaN
                        data: item.data,
                        cat: item.cat || item.categoria
                    });

                    (data.r || data.receitas || []).forEach(i => tx.objectStore('receitas').add(normalize(i)));
                    (data.d || data.despesas || []).forEach(i => tx.objectStore('despesas').add(normalize(i)));
                    
                    tx.oncomplete = () => { alert("Restaurado!"); location.reload(); };
                } catch(err) { alert("Arquivo inv√°lido."); }
            };
            reader.readAsText(file);
        }

        function realReset() { 
            // Hard Reset Action
            localStorage.removeItem('contas_user');
            localStorage.setItem('ignore_embed', 'true');
            const tx=db.transaction(['receitas','despesas'],'readwrite'); 
            tx.objectStore('receitas').clear(); tx.objectStore('despesas').clear(); 
            tx.oncomplete=()=>location.reload(); 
        }

        function removerAcentos(str) { return str.normalize('NFD').replace(/[\u0300-\u036f]/g, ""); }

        async function gerarRelatorioPDF() {
            showToast("Gerando PDF com Gr√°ficos...");
            const [receitas, despesas] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const mesSel = document.getElementById('filtroMes')?.value || new Date().toISOString().substring(0, 7);
            const user = localStorage.getItem('contas_user') || "Usuario";
            const receitasMes = receitas.filter(r => r.data.startsWith(mesSel)).map(x => ({...x, tipo: 'receita'}));
            const despesasMes = despesas.filter(d => d.data.startsWith(mesSel)).map(x => ({...x, tipo: 'despesa'}));
            const totalR = receitasMes.reduce((s, i) => s + i.val, 0);
            const totalD = despesasMes.reduce((s, i) => s + i.val, 0);
            const saldo = totalR - totalD;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const safeText = (txt) => removerAcentos(txt || "");
            const fmtBRL = (val) => "R$ " + val.toFixed(2).replace('.', ',');
            
            // --- HACK PARA GR√ÅFICOS ESCUROS NO PDF ---
            // Salva cores originais para restaurar depois
            const originalDoughnutColor = chartInstanceDoughnut.options.plugins.legend.labels.color;
            const originalBarColor = chartInstanceBar.options.scales.y.ticks.color;
            const originalGridColor = chartInstanceBar.options.scales.y.grid.color;
            
            // For√ßa cor escura para impress√£o (Black)
            const printColor = '#333333';
            
            // Aplica cores no Doughnut
            chartInstanceDoughnut.options.plugins.legend.labels.color = printColor;
            chartInstanceDoughnut.options.plugins.title.color = printColor;
            chartInstanceDoughnut.update(); // Renderiza com cor escura
            
            // Aplica cores no Bar Chart
            chartInstanceBar.options.scales.y.ticks.color = printColor;
            chartInstanceBar.options.scales.x.ticks.color = printColor;
            chartInstanceBar.options.plugins.title.color = printColor;
            chartInstanceBar.options.scales.y.grid.color = 'rgba(0,0,0,0.1)'; // Grid vis√≠vel no branco
            chartInstanceBar.update(); // Renderiza com cor escura

            // --- GERA O PDF ---
            
            // Header Premium
            doc.setFillColor(94, 92, 230); doc.rect(0, 0, pageWidth, 50, 'F');
            doc.setTextColor(255, 255, 255); 
            doc.setFontSize(24); doc.setFont("helvetica", 'bold'); doc.text(safeText(`RELATORIO FINANCEIRO`), 14, 25);
            doc.setFontSize(12); doc.setFont("helvetica", 'normal'); doc.text(safeText(`${user}`), 14, 35);
            doc.text(`Periodo: ${mesSel}`, pageWidth - 50, 35);
            
            // Summary Cards (Refined UI)
            let yPos = 65;
            const drawCard = (x, label, val, colorRGB) => {
                doc.setDrawColor(220, 220, 220); doc.setFillColor(252, 252, 253);
                doc.roundedRect(x, yPos, 58, 28, 4, 4, 'FD'); 
                doc.setFontSize(9); doc.setTextColor(100, 100, 100); doc.text(label, x + 6, yPos + 10);
                doc.setFontSize(14); doc.setFont("helvetica", 'bold'); 
                doc.setTextColor(colorRGB[0], colorRGB[1], colorRGB[2]); doc.text(val, x + 6, yPos + 22);
            };
            
            drawCard(14, "GANHOS", fmtBRL(totalR), [48, 209, 88]); 
            drawCard(76, "GASTOS", fmtBRL(totalD), [255, 69, 58]); 
            drawCard(138, "SALDO LIQUIDO", fmtBRL(saldo), saldo >= 0 ? [94, 92, 230] : [255, 69, 58]); 

            yPos += 45;

            // --- CAPTURA DE GR√ÅFICOS COM T√çTULOS ---
            const chartDoughnut = document.getElementById('chart-doughnut');
            const chartBar = document.getElementById('chart-bar');
            
            if (chartDoughnut && chartBar && (receitasMes.length > 0 || despesasMes.length > 0)) {
                try {
                    // T√≠tulos dos Gr√°ficos (Texto Nativo do PDF)
                    doc.setFontSize(11); doc.setTextColor(60, 60, 60); doc.setFont("helvetica", 'bold');
                    doc.text("Despesas por Categoria", 30, yPos);
                    doc.text("Balanco Mensal", 130, yPos);
                    
                    yPos += 5; 
                    
                    // Aguarda renderiza√ß√£o
                    await new Promise(r => setTimeout(r, 100));

                    const imgDoughnut = chartDoughnut.toDataURL("image/png");
                    const imgBar = chartBar.toDataURL("image/png");
                    
                    doc.addImage(imgDoughnut, 'PNG', 15, yPos, 70, 70);
                    doc.addImage(imgBar, 'PNG', 115, yPos, 70, 70);
                    
                    yPos += 80;
                } catch(e) { console.error("Erro ao capturar gr√°fico", e); }
            }

            // Tabela Refinada
            const allItems = [...receitasMes, ...despesasMes].sort((a,b) => a.data.localeCompare(b.data));
            const tableData = allItems.map(item => [
                item.data.split('-').reverse().join('/'),
                safeText(item.desc),
                safeText(item.tipo === 'receita' ? 'ENTRADA' : 'SAIDA'),
                item.tipo === 'receita' ? `+ ${fmtBRL(item.val)}` : `- ${fmtBRL(item.val)}`
            ]);

            doc.autoTable({
                startY: yPos, 
                head: [['Data', 'Descricao', 'Tipo', 'Valor']], 
                body: tableData, 
                theme: 'striped',
                headStyles: { fillColor: [94, 92, 230], textColor: 255, fontStyle: 'bold', halign: 'center' },
                styles: { fontSize: 10, cellPadding: 4, textColor: [60, 60, 60] }, 
                columnStyles: { 
                    0: { halign: 'center' },
                    3: { halign: 'right', fontStyle: 'bold' } 
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 3) {
                        data.cell.styles.textColor = data.cell.raw.includes('+') ? [48, 209, 88] : [255, 69, 58];
                    }
                }
            });

            // Rodap√© com Branding
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8); doc.setTextColor(150);
                doc.text(`Pagina ${i} de ${totalPages} | Gerado via O App do Pobre - https://oappdopobre.oseuapp.workers.dev`, pageWidth / 2, pageHeight - 10, { align: 'center' });
            }

            doc.save(`Relatorio_${safeText(user)}_${mesSel}.pdf`);
            showToast("PDF Gerado!");

            // --- RESTAURA CORES ORIGINAIS DO TEMA ---
            chartInstanceDoughnut.options.plugins.legend.labels.color = originalDoughnutColor;
            chartInstanceDoughnut.options.plugins.title.color = originalDoughnutColor;
            
            chartInstanceBar.options.scales.y.ticks.color = originalBarColor;
            chartInstanceBar.options.scales.x.ticks.color = originalBarColor;
            chartInstanceBar.options.plugins.title.color = originalBarColor;
            chartInstanceBar.options.scales.y.grid.color = originalGridColor;

            chartInstanceDoughnut.update();
            chartInstanceBar.update();
        }

        async function compartilharZap() {
            const [receitas, despesas] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const mesSel = document.getElementById('filtroMes').value;
            const recFiltro = receitas.filter(i=>i.data.startsWith(mesSel));
            const despFiltro = despesas.filter(i=>i.data.startsWith(mesSel));
            const totalR = recFiltro.reduce((s,i)=>s+i.val,0);
            const totalD = despFiltro.reduce((s,i)=>s+i.val,0);
            const saldo = totalR - totalD;
            const meses = ["janeiro","fevereiro","mar√ßo","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];
            const [ano, mes] = mesSel.split('-');
            const nomeMes = meses[parseInt(mes)-1];
            let msg = `*Relat√≥rio Financeiro - ${nomeMes} de ${ano}*\n\n`;
            msg += `*üü¢ Entradas: R$ ${totalR.toFixed(2)}*\n`;
            recFiltro.forEach(r => msg += `üîπ ${r.desc}: R$ ${r.val.toFixed(2)}\n`);
            msg += `\n*üî¥ Sa√≠das: R$ ${totalD.toFixed(2)}*\n`;
            despFiltro.forEach(d => msg += `üî∏ ${d.desc}: R$ ${d.val.toFixed(2)}\n`);
            msg += `\n*üí∞ Saldo Final: R$ ${saldo.toFixed(2)}*`;
            msg += `\n\nüìä Controle suas finan√ßas de gra√ßa: https://oappdopobre.oseuapp.workers.dev`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function showToast(m) { 
            const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; t.style.top = "80px";
            setTimeout(() => { t.style.opacity = 0; t.style.top = "70px"; }, 2500); 
        }

        window.onload = async () => {
            await initDB();
            const user = localStorage.getItem('contas_user');
            if(!user) openModal('modal-welcome'); else document.getElementById('username-header').innerText = user;
            const savedTheme = localStorage.getItem('contas_theme');
            if(savedTheme === 'light') document.body.classList.add('light-theme');
            const sel = document.getElementById('filtroMes');
            const hoje = new Date();
            for(let i=0; i<12; i++) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth()-i, 1);
                const s = d.toISOString().slice(0,7);
                sel.add(new Option(d.toLocaleDateString('pt-BR',{month:'long',year:'numeric'}), s));
            }
            document.querySelectorAll('input[type="tel"]').forEach(i => {
                i.addEventListener('input', e => {
                    let v = e.target.value.replace(/\D/g,'');
                    v = (v/100).toFixed(2).replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    e.target.value = v;
                });
            });
            document.querySelectorAll('input[type="date"]').forEach(i => i.value = hoje.toISOString().slice(0,10));
            setupSmartBar();
            navTo('v-ganhar', document.querySelector('.tab.active'));
            render();
        };
    </script>
</body>
</html>
