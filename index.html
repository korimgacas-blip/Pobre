
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Contas</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f2f2f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Contas">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            /* --- PALETA IOS 26 --- */
            --primary: #5e5ce6;      /* Indigo Apple Deep */
            --primary-glow: rgba(94, 92, 230, 0.5);
            --income: #30d158;       /* Green Apple */
            --expense: #ff453a;      /* Red Apple */
            
            --bg-base: #f2f2f7;
            --text-main: #000000;
            --text-sec: #8e8e93;

            /* --- GLASS PHYSICS SYSTEM --- */
            --glass-surface: rgba(255, 255, 255, 0.75); /* Mais opaco para legibilidade */
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-highlight: rgba(255, 255, 255, 0.9);
            --glass-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.05),
                0 1px 3px rgba(0,0,0,0.02);
            
            /* Blur ultra pesado "Liquid" */
            --blur-strength: 50px;
            
            --radius-dock: 38px;
            --radius-card: 28px;
            --radius-input: 18px;

            /* Gradiente de fundo Mesh Fluido */
            --mesh-gradient: 
                radial-gradient(at 0% 0%, rgba(94, 92, 230, 0.18) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(50, 215, 75, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(255, 69, 58, 0.12) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(10, 132, 255, 0.15) 0px, transparent 50%),
                #f2f2f7;
        }

        /* DARK MODE AUTOM√ÅTICO - "OBSIDIAN GLASS" */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #5e5ce6;
                --bg-base: #000000;
                --text-main: #ffffff;
                --text-sec: #98989d;
                
                --glass-surface: rgba(30, 30, 32, 0.70);
                --glass-border: rgba(255, 255, 255, 0.12);
                --glass-highlight: rgba(255, 255, 255, 0.10);
                --glass-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
                
                --mesh-gradient: 
                    radial-gradient(at 0% 0%, rgba(94, 92, 230, 0.3) 0px, transparent 60%),
                    radial-gradient(at 90% 90%, rgba(255, 59, 48, 0.1) 0px, transparent 60%),
                    #000000;
            }
        }

        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--mesh-gradient);
            background-attachment: fixed;
            margin: 0;
            padding-bottom: 130px; /* Espa√ßo extra pro dock */
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- GPU LAYERS --- */
        .glass-card, .card, input, button {
            transform: translate3d(0,0,0);
            will-change: transform, opacity;
        }

        /* --- HEADER "ISLAND" FLUTUANTE --- */
        header {
            position: sticky;
            top: 12px;
            margin: 12px 16px 24px;
            padding: 16px 24px;
            background: var(--glass-surface);
            backdrop-filter: blur(var(--blur-strength)) saturate(180%);
            -webkit-backdrop-filter: blur(var(--blur-strength)) saturate(180%);
            border-radius: 32px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            /* Specular Highlight Topo */
            box-shadow: inset 0 1px 0 var(--glass-highlight), var(--glass-shadow);
        }

        .header-content { display: flex; flex-direction: column; justify-content: center; }
        /* Ocultamos o greeting antigo pois o nome vai pro titulo */
        .user-greeting { display: none !important; }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            padding: 0 16px;
            position: relative;
            z-index: 20;
        }

        /* --- GLASS CARDS --- */
        .card, .dash-card, .glass-card {
            background: var(--glass-surface);
            backdrop-filter: blur(var(--blur-strength)) saturate(160%);
            -webkit-backdrop-filter: blur(var(--blur-strength)) saturate(160%);
            border-radius: var(--radius-card);
            border: 1px solid var(--glass-border);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.15), var(--glass-shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .dash-card { padding: 22px 18px; text-align: center; }
        .card { padding: 24px; margin-bottom: 20px; }

        .dash-card:active { transform: scale(0.97); }

        .dash-card small { 
            color: var(--text-sec); 
            font-size: 0.75rem; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            display: block;
            margin-bottom: 6px;
        }
        .dash-card b { font-size: 1.4rem; letter-spacing: -0.5px; color: var(--text-main); }

        /* --- INPUTS ESTILO IOS --- */
        label {
            font-size: 0.8rem; font-weight: 600; color: var(--text-sec);
            margin: 12px 0 6px 4px; display: block;
        }

        input, select {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-input);
            font-size: 17px;
            background: rgba(120, 120, 128, 0.08); /* Cinza Apple */
            border: 1px solid transparent;
            color: var(--text-main);
            transition: all 0.3s ease;
            appearance: none; -webkit-appearance: none;
        }

        input:focus, select:focus {
            background: rgba(120, 120, 128, 0.12);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
            outline: none;
        }

        /* --- BOT√ïES LIQUID --- */
        button {
            width: 100%;
            padding: 16px;
            border-radius: 20px;
            border: none;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
            position: relative;
        }
        
        button:active { transform: scale(0.96); opacity: 0.9; }

        .btn-income { background: linear-gradient(135deg, #34c759, #30d158); color: white; box-shadow: 0 8px 20px rgba(48, 209, 88, 0.3); }
        .btn-expense { background: linear-gradient(135deg, #ff3b30, #ff453a); color: white; box-shadow: 0 8px 20px rgba(255, 69, 58, 0.3); }
        .btn-primary { background: linear-gradient(135deg, #5856d6, #5e5ce6); color: white; box-shadow: 0 8px 20px rgba(94, 92, 230, 0.35); }
        
        .btn-delete { background: rgba(255, 69, 58, 0.1); color: var(--expense); border: 1px solid rgba(255, 69, 58, 0.2); margin-top: 12px;}
        .btn-sec { background: rgba(120, 120, 128, 0.08); color: var(--text-main); margin-top: 12px; }
        
        .btn-pix { background: #32bcad; color: white; }
        .btn-mp { background: #009ee3; color: white; }
        .btn-wpp { background: #25d366; color: white; }
        .btn-tutorial { background: #af52de; color: white; }

        /* --- CATEGORIAS --- */
        .category-selector {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 24px;
        }
        .category-option {
            padding: 12px 4px;
            background: rgba(120, 120, 128, 0.06);
            border-radius: 16px;
            text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--text-sec);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .category-option.selected {
            background: var(--glass-surface);
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--glass-shadow);
            transform: translateY(-2px);
        }

        /* --- NAV DOCK FLUTUANTE --- */
        nav {
            position: fixed; bottom: 24px; left: 20px; right: 20px;
            background: var(--glass-surface);
            backdrop-filter: blur(var(--blur-strength)) saturate(180%);
            -webkit-backdrop-filter: blur(var(--blur-strength)) saturate(180%);
            border-radius: var(--radius-dock);
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15), inset 0 1px 0 var(--glass-highlight);
            z-index: 100;
            height: 75px;
            display: flex; justify-content: space-evenly; align-items: center;
        }
        
        .tab { 
            color: var(--text-sec); font-size: 0.65rem; font-weight: 600; 
            display: flex; flex-direction: column; align-items: center; gap: 4px; 
            cursor: pointer; width: 60px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0.7;
        }
        .tab.active { 
            color: var(--primary); 
            transform: translateY(-8px) scale(1.1); 
            opacity: 1;
        }
        .tab i { font-size: 1.4rem; margin-bottom: 2px; }

        /* --- STICKY BUTTON --- */
        .sticky-actions {
            position: fixed; bottom: 110px; left: 20px; right: 20px; z-index: 90;
            display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(40px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .sticky-actions.active { display: block; }
        .sticky-actions button {
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        /* --- MOTION --- */
        .container { padding: 20px 16px; max-width: 600px; margin: 0 auto; }
        .view { display: none; }
        .view.active { 
            display: block; 
            animation: iosFade 0.35s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; 
        }
        @keyframes iosFade { 
            from { opacity: 0; transform: scale(0.96) translateY(10px); } 
            to { opacity: 1; transform: scale(1) translateY(0); } 
        }

        /* --- EXTRATO --- */
        .item {
            display: flex; justify-content: space-between; padding: 18px 0;
            border-bottom: 1px solid rgba(120, 120, 128, 0.1); cursor: pointer;
        }
        .item:last-child { border-bottom: none; }
        .item:hover { background: rgba(120, 120, 128, 0.03); margin: 0 -24px; padding: 18px 24px; }

        /* --- PRESERVA√á√ÉO --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.01); backdrop-filter: blur(8px);
            z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from {opacity:0} to {opacity:1}}

        .tiers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin: 20px 0; }
        .tier-card { 
            background: rgba(255,255,255,0.5); border-radius: 18px; padding: 16px 12px; 
            text-align: center; border: 1px solid rgba(255,255,255,0.6); position: relative;
        }
        @media (prefers-color-scheme: dark) {
            .tier-card { background: rgba(60, 60, 60, 0.4); border-color: rgba(255,255,255,0.1); }
            .tier-title { color: #fff !important; }
            .tier-price { color: #ccc !important; }
            .tier-description { color: #aaa !important; }
        }
        .tier-icon { font-size: 2.2rem; margin-bottom: 8px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); }
        .tier-title { font-weight: 800; color: var(--primary); font-size: 0.95rem; }
        .tier-price { font-weight: 700; font-size: 1rem; color: var(--text-main); margin-bottom: 8px; }
        .tier-description { font-size: 0.7rem; color: var(--text-sec); margin-bottom: 12px; line-height: 1.4; }
        .tier-qr { width: 100px; height: 100px; object-fit: contain; margin: 0 auto; border-radius: 10px; background: white; padding: 4px; }
        .badge-popular { 
            position: absolute; top: -8px; left: 50%; transform: translateX(-50%); 
            background: var(--primary); color: white; font-size: 0.6rem; font-weight: 800; 
            padding: 4px 10px; border-radius: 12px; text-transform: uppercase; 
        }

        #toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 24px; border-radius: 50px;
            opacity: 0; transition: opacity 0.3s; z-index: 2000; pointer-events: none;
            backdrop-filter: blur(10px); font-size: 0.9rem; font-weight: 500;
        }
        canvas { max-height: 250px; width: 100% !important; }
        .info-section { font-size: 0.85rem; line-height: 1.5; color: var(--text-sec); }
        .info-section h4 { color: var(--primary); margin: 15px 0 8px; display: flex; align-items: center; gap: 6px; }
        .privacy-box { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 15px; border-radius: 15px; margin-top: 15px; color: var(--text-main); }
    </style>
</head>
<body>
    <header class="gpu-accelerated">
        <div class="header-content">
            <div class="app-title" id="app-title-display" style="font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px; color: var(--text-main)">Pobre 3.1</div>
            <div id="user-greeting" class="user-greeting"></div>
        </div>
        <div id="status-tag" style="color: var(--primary); font-size: 1.2rem;"><i class="fas fa-wallet"></i></div>
    </header>

    <div class="dashboard">
        <div class="dash-card">
            <small>Saldo Geral</small>
            <b id="dash-saldo">R$ 0,00</b>
        </div>
        <div class="dash-card">
            <small>Gastos (M√™s)</small>
            <b id="dash-gastos-mes" style="color: var(--expense)">R$ 0,00</b>
        </div>
    </div>

    <div id="welcome-modal" class="modal-overlay">
        <div class="glass-card" style="max-width: 340px; text-align: center; padding: 30px 20px;">
            <div style="font-size: 3rem; margin-bottom: 10px;">üëã</div>
            <h2 style="color: var(--primary); margin: 0 0 10px;">Bem-vindo(a)!</h2>
            <p style="color: var(--text-sec); font-size: 0.9rem; margin-bottom: 20px;">Para personalizar seus backups e relat√≥rios, como voc√™ quer ser chamado?</p>
            <input type="text" id="user-name-input" placeholder="Ex: Gabriel, Casa, Loja...">
            <button class="btn-primary" onclick="salvarUsuario()" style="margin-top: 15px;">Come√ßar</button>
        </div>
    </div>

    <div id="tutorial-modal" class="modal-overlay">
        <div class="glass-card" style="max-height: 85vh; overflow-y: auto; padding: 25px 20px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: var(--primary); margin: 0; display: flex; align-items: center; gap: 8px;"><i class="fas fa-book-open"></i> Guia Completo</h3>
                <i class="fas fa-times" onclick="closeTutorialModal()" style="font-size: 1.5rem; color: var(--text-sec); cursor: pointer;"></i>
            </div>
            <div class="tutorial-list" style="color: var(--text-sec); font-size: 0.9rem;">
                <p>Use as abas abaixo para navegar entre Ganhar e Gastar.</p>
                <ul style="padding-left: 20px; line-height: 1.6;">
                    <li>As setas indicam se √© Receita ou Despesa.</li>
                    <li>Use a aba An√°lise para ver gr√°ficos e extrato.</li>
                    <li>Toque em um item do extrato para editar.</li>
                </ul>
            </div>
            <button class="btn-primary" onclick="closeTutorialModal()" style="margin-top: 20px;">Entendi</button>
        </div>
    </div>

    <div id="pix-modal" class="modal-overlay" onclick="closePixModal()">
        <div class="glass-card" onclick="event.stopPropagation()" style="text-align: center; max-width: 340px;">
            <h3 id="modal-qr-title" style="color: var(--primary); margin-top: 0;">Ajude com um caf√© ‚òï</h3>
            <div style="background: white; padding: 15px; border-radius: 15px; display: inline-block; margin: 10px 0;">
                <img id="modal-qr-img" src="qrcode.png" alt="QR Code" style="width: 250px; height: 250px; object-fit: contain; display: block;" onerror="this.src='https://placehold.co/200x200?text=QR+Code+PIX'">
            </div>
            <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 20px;">Escaneie o c√≥digo acima usando o aplicativo do seu banco.</p>
            <button class="btn-primary" onclick="closePixModal()" style="background: #374151;">Fechar</button>
        </div>
    </div>

    <div class="container">
        <div id="v-receita" class="view active">
            <div class="card">
                <h3 id="titulo-receita" style="color: var(--text-main); margin-top:0"><i class="fas fa-plus-circle" style="color: var(--income)"></i> Nova Receita</h3>
                <input type="hidden" id="receita-id">
                
                <label for="descricao-receita">Descri√ß√£o</label>
                <input type="text" id="descricao-receita" placeholder="Ex: Sal√°rio Freelance" autocomplete="off" maxlength="60">

                <div class="category-selector" id="categoria-receita-selector" style="margin-top: 15px;">
                    <div class="category-option selected" data-category="salario" onclick="selectCategory('receita', 'salario')">üíº<br>Sal√°rio</div>
                    <div class="category-option" data-category="investimentos" onclick="selectCategory('receita', 'investimentos')">üìà<br>Invest.</div>
                    <div class="category-option" data-category="outros" onclick="selectCategory('receita', 'outros')">üéÅ<br>Outros</div>
                </div>
                <input type="hidden" id="categoria-receita" value="salario">

                <label for="valor-receita">Valor</label>
                <input type="text" id="valor-receita" inputmode="decimal" placeholder="R$ 0,00" autocomplete="off">

                <label for="data-receita">Data</label>
                <input type="date" id="data-receita">

                <button id="btn-salvar-receita" class="btn-income" onclick="salvar('receita')" style="margin-top: 20px;">Salvar Receita</button>
                <button id="del-receita" class="btn-delete" style="display:none;" onclick="deletarRegistro('receita')">Excluir</button>
                <button id="btn-cancel-receita" class="btn-sec" style="display:none;" onclick="cancelarEdicao('receitas')">Voltar</button>
            </div>
        </div>

        <div id="v-despesa" class="view">
            <div class="card">
                <h3 id="titulo-despesa" style="color: var(--text-main); margin-top:0"><i class="fas fa-minus-circle" style="color: var(--expense)"></i> Novo Gasto</h3>
                <input type="hidden" id="despesa-id">
                
                <label for="descricao-despesa">Descri√ß√£o</label>
                <input type="text" id="descricao-despesa" placeholder="Ex: Mercado" autocomplete="off" maxlength="60">

                <div class="category-selector" id="categoria-despesa-selector" style="margin-top: 15px;">
                    <div class="category-option selected" data-category="alimentacao" onclick="selectCategory('despesa', 'alimentacao')">üçï<br>Comida</div>
                    <div class="category-option" data-category="transporte" onclick="selectCategory('despesa', 'transporte')">üöó<br>Transp.</div>
                    <div class="category-option" data-category="lazer" onclick="selectCategory('despesa', 'lazer')">üçø<br>Lazer</div>
                    <div class="category-option" data-category="contas" onclick="selectCategory('despesa', 'contas')">üßæ<br>Contas</div>
                    <div class="category-option" data-category="moradia" onclick="selectCategory('despesa', 'moradia')">üè†<br>Casa</div>
                    <div class="category-option" data-category="saude" onclick="selectCategory('despesa', 'saude')">üíä<br>Sa√∫de</div>
                    <div class="category-option" data-category="educacao" onclick="selectCategory('despesa', 'educacao')">üìö<br>Estudo</div>
                    <div class="category-option" data-category="compras" onclick="selectCategory('despesa', 'compras')">üõí<br>Compra</div>
                </div>
                <input type="hidden" id="categoria-despesa" value="alimentacao">

                <label for="valor-despesa">Valor</label>
                <input type="text" id="valor-despesa" inputmode="decimal" placeholder="R$ 0,00" autocomplete="off">

                <label for="data-despesa">Data</label>
                <input type="date" id="data-despesa">

                <button id="btn-salvar-despesa" class="btn-expense" onclick="salvar('despesa')" style="margin-top: 20px;">Confirmar Gasto</button>
                <button id="del-despesa" class="btn-delete" style="display:none;" onclick="deletarRegistro('despesa')">Excluir</button>
                <button id="btn-cancel-despesa" class="btn-sec" style="display:none;" onclick="cancelarEdicao('despesas')">Voltar</button>
            </div>
        </div>

        <div id="v-consulta" class="view">
            <div class="card">
                <h3><i class="fas fa-chart-pie" style="color: var(--primary)"></i> Gastos por Categoria</h3>
                <select id="filtroMes" onchange="render()"></select>
                <div class="chart-container" style="position: relative; height: 250px; margin-bottom: 20px;">
                    <canvas id="graficoPizza"></canvas>
                </div>
                <div id="categoria-legend" style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 15px; font-size: 0.75rem; color: var(--text-sec);"></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-chart-line" style="color: var(--primary)"></i> Evolu√ß√£o</h3>
                <div class="chart-container" style="position: relative; height: 250px;">
                    <canvas id="graficoMensal"></canvas>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-history" style="color: var(--primary)"></i> Extrato</h3>
                <div id="lista-detalhada"></div>
            </div>

            <div class="card" style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-sec" onclick="gerarRelatorioPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF (Dossi√™)</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-sec" onclick="exportarBackup()"><i class="fas fa-download"></i> Backup</button>
                    <button class="btn-sec" onclick="document.getElementById('restore-file').click()"><i class="fas fa-upload"></i> Restaurar</button>
                    <input type="file" id="restore-file" style="display:none" accept=".json" onchange="restaurarBackup(this)">
                </div>
                <button onclick="confirmarLimpeza()" style="color: var(--expense); background: rgba(255, 69, 58, 0.1); border: 1px solid rgba(255, 69, 58, 0.2);"><i class="fas fa-trash-alt"></i> Limpar Dados</button>
            </div>
        </div>

        <div id="v-apoie" class="view">
            <div class="card">
                <h3 style="color: var(--text-main)"><i class="fas fa-hand-holding-heart" style="color: #ff2d55;"></i> O App do Pobre ajudou?</h3>
                <div class="info-section">
                    <p>O <b>Pobre 3.1</b> foi criado para colocar o controle financeiro na palma da sua m√£o, sem frescura e <b>sem vender seus dados</b>.</p>
                    <h4><i class="fas fa-calculator"></i> Roda at√© em calculadora</h4>
                    <p>Feito leve de prop√≥sito. N√£o trava seu celular tijol√£o, gasta pouca bateria e funciona sem internet.</p>
                    <h4><i class="fas fa-user-secret"></i> Contra o Sistema</h4>
                    <p>Diferente dos apps de banco, <b>n√≥s n√£o espiamos o que voc√™ compra</b>. Tudo fica salvo apenas no seu aparelho.</p>
                    <div class="privacy-box">
                        <p><i class="fas fa-shield-alt"></i> <b>Zero Taxas. Zero An√∫ncios.</b><br>
                        Manter esse app no ar custa tempo e caf√©. Se ele te ajudou, considere apoiar o desenvolvedor!</p>
                    </div>
                </div>
                <div style="margin-top: 30px; border-top: 1px solid rgba(120,120,128,0.2); padding-top: 20px;">
                    <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-gift"></i> Escolha como fortalecer
                    </h4>
                    <div class="tiers-grid">
                        <div class="tier-card">
                            <div class="tier-icon">‚òï</div>
                            <div class="tier-title">Caf√© da Firma</div>
                            <div class="tier-price">R$ 5,00 - R$ 10,00</div>
                            <div class="tier-description">Ajuda demais a manter o c√≥digo rodando sem sono!</div>
                            <img src="qrcode.png" alt="QR Code" class="tier-qr" onclick="abrirQrCodeZoom(this.src, 'Caf√© da Firma')" onerror="this.src='https://placehold.co/200x200?text=QR+Code+PIX'">
                        </div>
                        <div class="tier-card" style="border-color: var(--primary);">
                            <div class="badge-popular">‚ú® Popular</div>
                            <div class="tier-icon">ü•™</div>
                            <div class="tier-title">O Lanche</div>
                            <div class="tier-price">R$ 15,00 - R$ 25,00</div>
                            <div class="tier-description">Retribua pelas horas economizadas e relat√≥rios PDF.</div>
                            <img src="qrcode.png" alt="QR Code" class="tier-qr" onclick="abrirQrCodeZoom(this.src, 'O Lanche')" onerror="this.src='https://placehold.co/200x200?text=QR+Code+PIX'">
                        </div>
                        <div class="tier-card">
                            <div class="tier-icon">üëë</div>
                            <div class="tier-title">Patr√£o</div>
                            <div class="tier-price">R$ 50,00+</div>
                            <div class="tier-description">Vire s√≥cio moral do projeto. Garante que o app continue existindo.</div>
                            <img src="qrcode.png" alt="QR Code" class="tier-qr" onclick="abrirQrCodeZoom(this.src, 'Patr√£o')" onerror="this.src='https://placehold.co/200x200?text=QR+Code+PIX'">
                        </div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 15px;">
                    <button class="btn-tutorial" onclick="openTutorialModal()"><i class="fas fa-book-reader"></i> Tutorial</button>
                    <button class="btn-mp" onclick="window.open('https://link.mercadopago.com.br/cuecasa', '_blank')"><i class="fas fa-credit-card"></i> Apoiar via Cart√£o/MP</button>
                    <button class="btn-wpp" onclick="window.open('https://wa.me/5547996249149?text=Opa,%20vim%20pelo%20App%20do%20Pobre!', '_blank')"><i class="fab fa-whatsapp"></i> Falar com Dev</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sticky-save" class="sticky-actions">
        <button id="sticky-btn" class="btn-primary">
            <i class="fas fa-check"></i> Salvar
        </button>
    </div>

    <nav>
        <div class="tab active" onclick="navTo('v-receita',this)"><i class="fas fa-arrow-up"></i><span>Ganhar</span></div>
        <div class="tab" onclick="navTo('v-despesa',this)"><i class="fas fa-arrow-down"></i><span>Gastar</span></div>
        <div class="tab" onclick="navTo('v-consulta',this)"><i class="fas fa-chart-bar"></i><span>An√°lise</span></div>
        <div class="tab" onclick="navTo('v-apoie',this)"><i class="fas fa-heart"></i><span>Apoie</span></div>
    </nav>
    <div id="toast">Mensagem</div>

    <script>
        // ==================== CONFIGURA√á√ÉO INICIAL E SINGLE TAB ====================
        if ('BroadcastChannel' in window) {
            const channel = new BroadcastChannel('pobre_3_1_auth');
            let isAnotherTabOpen = false;
            channel.onmessage = (event) => {
                if (event.data === 'ping') { channel.postMessage('pong'); } 
                else if (event.data === 'pong') {
                    isAnotherTabOpen = true;
                    document.body.innerHTML = '<div style="display:flex;height:100vh;align-items:center;justify-content:center;text-align:center;padding:20px;flex-direction:column;color:var(--text-main);"><h1>‚ö†Ô∏è App j√° aberto</h1><p>O Pobre 3.1 j√° est√° rodando em outra aba.</p></div>';
                    window.stop();
                }
            };
            setTimeout(() => channel.postMessage('ping'), 100);
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(reg => reg.update()));
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {}));
        }

        let db;
        let chartInstancePie;
        let chartInstanceMonthly;
        const FORMAT_BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const CATEGORIES = {
            receita: { salario: "Sal√°rio", investimentos: "Investimentos", outros: "Outros" },
            despesa: { alimentacao: "Alimenta√ß√£o", transporte: "Transporte", lazer: "Lazer", contas: "Contas", moradia: "Moradia", saude: "Sa√∫de", educacao: "Educa√ß√£o", compras: "Compras" }
        };
        const CHART_COLORS = ['#5e5ce6', '#30d158', '#ff9f0a', '#ff453a', '#bf5af2', '#5ac8fa', '#64d2ff', '#ff375f'];

        // ==================== FUN√á√ïES UX/UI ====================
        
        // 1. STICKY SAVE CONTROL
        function ativarSticky(tipo){
            const bar = document.getElementById('sticky-save');
            const btn = document.getElementById('sticky-btn');
            bar.classList.add('active');
            btn.onclick = () => salvar(tipo);
        }

        function desativarSticky(){
            document.getElementById('sticky-save').classList.remove('active');
        }

        document.addEventListener('focusin', (e)=>{
            if(e.target.matches('#v-receita input')) ativarSticky('receita');
            if(e.target.matches('#v-despesa input')) ativarSticky('despesa');
        });

        document.addEventListener('focusout', (e)=>{
            setTimeout(() => {
                if(!document.querySelector('#v-receita input:focus') && 
                   !document.querySelector('#v-despesa input:focus')){
                    desativarSticky();
                }
            }, 100);
        });

        // 2. M√ÅSCARA MONET√ÅRIA
        function formatarMoedaInput(input){
            let valor = input.value.replace(/\D/g,'');
            valor = (parseInt(valor || 0)/100).toFixed(2);
            valor = valor.replace('.',',');
            valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g,'.');
            input.value = valor;
        }

        function getValorNumerico(inputId){
            const el = document.getElementById(inputId);
            if(!el || !el.value) return 0;
            const val = el.value.replace(/\./g,'').replace(',','.');
            return parseFloat(val);
        }

        // 3. VALIDA√á√ÉO INLINE
        function validarCampo(input, condicao, mensagem){
            let erro = input.nextElementSibling;
            if(!erro || !erro.classList.contains('erro-msg')){
                erro = document.createElement('div');
                erro.className = 'erro-msg';
                erro.style.color = 'var(--expense)';
                erro.style.fontSize = '0.75rem';
                erro.style.marginTop = '-5px'; 
                erro.style.marginBottom = '10px';
                input.after(erro);
            }
            
            if(!condicao){
                erro.innerText = mensagem;
                input.style.borderColor = 'var(--expense)';
                if(navigator.vibrate) navigator.vibrate(60); 
            } else {
                erro.innerText = '';
                input.style.borderColor = 'transparent'; 
            }
        }

        // 4. MICROINTERA√á√ïES E RIPPLE
        function rippleEffect(e){
            const button = e.currentTarget;
            const circle = document.createElement("span");
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${e.clientX - button.getBoundingClientRect().left - radius}px`;
            circle.style.top = `${e.clientY - button.getBoundingClientRect().top - radius}px`;
            circle.style.position = "absolute";
            circle.style.borderRadius = "50%";
            circle.style.background = "rgba(255,255,255,0.4)";
            circle.style.transform = "scale(0)";
            circle.style.animation = "ripple 0.5s linear";
            circle.style.pointerEvents = "none";
            button.appendChild(circle);
            setTimeout(()=>circle.remove(),500);
        }
        const style = document.createElement('style');
        style.innerHTML = `@keyframes ripple{ to{ transform: scale(4); opacity:0; } }`;
        document.head.appendChild(style);

        // ==================== LOGICA PRINCIPAL ====================
        function checkUser() {
            const user = localStorage.getItem('pobre_user_name');
            if (!user) { document.getElementById('welcome-modal').style.display = 'flex'; } 
            else { updateUserUI(user); }
        }
        function salvarUsuario() {
            const name = document.getElementById('user-name-input').value.trim();
            if (!name) return alert("Por favor, digite um nome.");
            localStorage.setItem('pobre_user_name', name);
            document.getElementById('welcome-modal').style.display = 'none';
            updateUserUI(name); showToast(`Bem-vindo, ${name}!`);
        }
        
        // --- ATUALIZA√á√ÉO DO T√çTULO DIN√ÇMICO ---
        function updateUserUI(name) {
            // Altera√ß√£o solicitada: Muda de "Pobre 3.1" para "Contas [Nome]"
            const titleEl = document.getElementById('app-title-display');
            if(titleEl) {
                // Primeira letra mai√∫scula apenas por est√©tica
                const formattedName = name.charAt(0).toUpperCase() + name.slice(1);
                titleEl.innerText = `Contas ${formattedName}`;
            }
        }
        
        function getUserName() { return localStorage.getItem('pobre_user_name') || "Usu√°rio"; }
        function getSafeFileName() { return getUserName().replace(/[^a-z0-9]/gi, '_'); }

        function abrirQrCodeZoom(imageSrc, titulo) {
            document.getElementById('modal-qr-img').src = imageSrc;
            document.getElementById('modal-qr-title').innerText = titulo;
            document.getElementById('pix-modal').style.display = 'flex';
        }
        function closePixModal() { document.getElementById('pix-modal').style.display = 'none'; }
        function openTutorialModal() { document.getElementById('tutorial-modal').style.display = 'flex'; }
        function closeTutorialModal() { document.getElementById('tutorial-modal').style.display = 'none'; }
        function removerAcentos(str) { if (!str) return ""; return str.toString().normalize('NFD').replace(/[\u0300-\u036f]/g, ""); }

        async function initDB() {
            return new Promise((resolve, reject) => {
                function abrirBanco() {
                    const request = indexedDB.open("GastosProDB", 3);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains("receitas")) db.createObjectStore("receitas", { keyPath: "id", autoIncrement: true });
                        if (!db.objectStoreNames.contains("despesas")) db.createObjectStore("despesas", { keyPath: "id", autoIncrement: true });
                    };
                    request.onsuccess = (e) => {
                        db = e.target.result;
                        db.onversionchange = () => { db.close(); alert("Nova vers√£o. Recarregue."); };
                        resolve();
                    };
                    request.onerror = async (e) => {
                        if(db) db.close();
                        const deleteReq = indexedDB.deleteDatabase("GastosProDB");
                        deleteReq.onsuccess = () => abrirBanco();
                        deleteReq.onerror = () => reject("Erro cr√≠tico DB");
                    };
                }
                abrirBanco();
            });
        }

        async function getAll(storeName) {
            if(!db) return [];
            const tx = db.transaction(storeName, "readonly");
            return new Promise(r => { 
                const req = tx.objectStore(storeName).getAll();
                req.onsuccess = () => r(req.result || []);
                req.onerror = () => r([]);
            });
        }

        async function salvar(tipo) {
            const id = document.getElementById(`${tipo}-id`).value;
            const desc = document.getElementById(`descricao-${tipo}`).value.trim();
            const cat = document.getElementById(`categoria-${tipo}`).value;
            const valor = getValorNumerico(`valor-${tipo}`);
            const data = document.getElementById(`data-${tipo}`).value;

            if (!desc) { showToast("Descri√ß√£o obrigat√≥ria!"); return; }
            if (!data) { showToast("Data obrigat√≥ria!"); return; }
            if (isNaN(valor) || valor <= 0) { showToast("Valor deve ser maior que zero!"); return; }

            const item = { descricao: desc, categoria: cat, valor: valor, data: data };
            if (id) item.id = parseInt(id);

            const storeName = tipo === 'receita' ? "receitas" : "despesas";
            const tx = db.transaction(storeName, "readwrite");
            tx.objectStore(storeName).put(item);
            tx.oncomplete = () => { showToast(id ? "Atualizado!" : "Salvo!"); cancelarEdicao(storeName); render(); };
        }

        async function deletarRegistro(tipo) {
            const id = parseInt(document.getElementById(`${tipo}-id`).value);
            if (!id || !confirm("Quer apagar mesmo?")) return;
            const storeName = tipo === 'receita' ? "receitas" : "despesas";
            const tx = db.transaction(storeName, "readwrite");
            tx.objectStore(storeName).delete(id);
            tx.oncomplete = () => { showToast("Removido."); cancelarEdicao(storeName); render(); navTo('v-consulta', document.querySelectorAll('.tab')[2]); };
        }

        async function exportarBackup() {
            const data = { receitas: await getAll("receitas"), despesas: await getAll("despesas") };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = `backup_${getSafeFileName()}_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        async function restaurarBackup(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(confirm("Importar dados? Isso substituir√° TODOS os dados atuais.")) {
                        const tx = db.transaction(["receitas", "despesas"], "readwrite");
                        tx.objectStore("receitas").clear(); tx.objectStore("despesas").clear();
                        if (data.receitas) data.receitas.forEach(r => { delete r.id; tx.objectStore("receitas").add(r); });
                        if (data.despesas) data.despesas.forEach(d => { delete d.id; tx.objectStore("despesas").add(d); });
                        tx.oncomplete = () => { showToast("Dados restaurados!"); render(); };
                    }
                } catch(err) { showToast("Erro no backup!"); }
            };
            reader.readAsText(file);
        }

        // --- PDF DOSSIE PRO (Vers√£o atualizada) ---
        async function gerarRelatorioPDF() {
            showToast("Preparando o dossi√™...");
            
            const [receitas, despesas] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            const mesSelecionado = document.getElementById('filtroMes')?.value || new Date().toISOString().substring(0, 7);
            
            const receitasMes = receitas.filter(r => r.data.startsWith(mesSelecionado)).map(x => ({...x, tipo: 'receita'}));
            const despesasMes = despesas.filter(d => d.data.startsWith(mesSelecionado)).map(x => ({...x, tipo: 'despesa'}));
            
            const totalReceitas = receitasMes.reduce((s, i) => s + i.valor, 0);
            const totalDespesas = despesasMes.reduce((s, i) => s + i.valor, 0);
            const saldoMes = totalReceitas - totalDespesas;
            
            const cats = {}; 
            despesasMes.forEach(d => cats[d.categoria] = (cats[d.categoria] || 0) + d.valor);
            const topCats = Object.entries(cats).sort(([,a], [,b]) => b - a).slice(0, 5);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const safeText = (txt) => removerAcentos(txt);
            const fmtBRL = (val) => "R$ " + val.toFixed(2).replace('.', ',');

            doc.setFillColor(94, 92, 230); // Indigo
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            doc.setTextColor(255, 255, 255); 
            doc.setFontSize(22); doc.setFont("helvetica", 'bold');
            doc.text("DOSSIE MENSAL", 14, 20);
            
            doc.setFontSize(10); doc.setFont("helvetica", 'normal');
            doc.text(`Usuario: ${safeText(getUserName())}`, 14, 28);
            doc.text(`Periodo: ${mesSelecionado}`, 14, 33);

            doc.setFontSize(16);
            doc.text("APP DO POBRE", pageWidth - 14, 20, { align: 'right' });
            doc.setFontSize(8);
            doc.text("Controle Financeiro Raiz", pageWidth - 14, 25, { align: 'right' });

            let yPos = 55;
            
            const drawCard = (x, label, val, color) => {
                doc.setFillColor(243, 244, 246);
                doc.setDrawColor(229, 231, 235);
                doc.roundedRect(x, yPos, 55, 25, 3, 3, 'FD');
                doc.setFontSize(8); doc.setTextColor(107, 114, 128); doc.text(label, x + 5, yPos + 8);
                doc.setFontSize(12); doc.setFont("helvetica", 'bold'); doc.setTextColor(...color);
                doc.text(val, x + 5, yPos + 18);
            };

            drawCard(14, "GANHOS", fmtBRL(totalReceitas), [48, 209, 88]);
            drawCard(75, "GASTOS", fmtBRL(totalDespesas), [255, 69, 58]);
            drawCard(136, "SALDO FINAL", fmtBRL(saldoMes), saldoMes >= 0 ? [94, 92, 230] : [255, 69, 58]);

            yPos += 40;
            doc.setFontSize(11); doc.setTextColor(50, 50, 50);
            doc.text("Para onde o dinheiro foi (Top 5):", 14, yPos);
            
            yPos += 8;
            doc.setFontSize(9); doc.setFont("helvetica", 'normal');
            let xCat = 14;
            
            if(topCats.length === 0) {
                doc.text("Nenhum gasto registrado.", 14, yPos);
            } else {
                topCats.forEach(([cat, val], index) => {
                    const nomeCat = CATEGORIES.despesa[cat] || cat;
                    const texto = `${index + 1}. ${safeText(nomeCat)}: ${fmtBRL(val)}`;
                    doc.text(texto, xCat, yPos);
                    xCat += 65; 
                    if (index === 2) { xCat = 14; yPos += 6; }
                });
            }

            const allItems = [...receitasMes, ...despesasMes].sort((a,b) => a.data.localeCompare(b.data));
            const tableData = allItems.map(item => [
                item.data.split('-').reverse().join('/'),
                safeText(item.descricao),
                safeText(item.tipo === 'receita' ? CATEGORIES.receita[item.categoria] : CATEGORIES.despesa[item.categoria]),
                item.tipo === 'receita' ? `+ ${fmtBRL(item.valor)}` : `- ${fmtBRL(item.valor)}`
            ]);

            doc.autoTable({
                startY: yPos + 15,
                head: [['Data', 'Descricao', 'Categoria', 'Valor']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [94, 92, 230], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: { 0: { cellWidth: 25 }, 3: { cellWidth: 35, halign: 'right', fontStyle: 'bold' } },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 3) {
                        const isPositive = data.cell.raw.includes('+');
                        data.cell.styles.textColor = isPositive ? [48, 209, 88] : [255, 69, 58];
                    }
                }
            });

            const finalY = doc.lastAutoTable.finalY + 20;
            let veredicto = "";
            if (saldoMes > 1000) veredicto = "VEREDICTO: Patrao! Sobrou dinheiro pra investir.";
            else if (saldoMes > 0) veredicto = "VEREDICTO: Na trave! Sobrou pouco. Cuidado mes que vem.";
            else if (saldoMes === 0) veredicto = "VEREDICTO: Zero a zero. Voce vive perigosamente.";
            else veredicto = "VEREDICTO: DEU RUIM. Acione o plano de emergencia.";

            doc.setDrawColor(94, 92, 230); doc.setLineWidth(0.5); doc.line(14, finalY, pageWidth - 14, finalY);
            doc.setFontSize(10); doc.setTextColor(100); doc.text(safeText(veredicto), pageWidth / 2, finalY + 10, { align: 'center' });
            doc.setFontSize(8); doc.setTextColor(150); doc.text(`Gerado em ${new Date().toLocaleDateString()}`, pageWidth / 2, pageHeight - 10, { align: 'center' });

            doc.save(`Relatorio_${getSafeFileName()}_${mesSelecionado}.pdf`);
            showToast("Dossi√™ gerado!");
        }

        function navTo(id, el) {
            document.querySelectorAll('.view').forEach(v => v.style.opacity = 0);
            setTimeout(() => {
                document.querySelectorAll('.view, .tab').forEach(e => e.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if(el) el.classList.add('active');
                document.getElementById(id).style.opacity = 1;
                if (id === 'v-consulta') { popularFiltro(); render(); }
            }, 150);
        }

        function selectCategory(tipo, cat) {
            document.querySelectorAll(`#categoria-${tipo}-selector .category-option`).forEach(e => e.classList.remove('selected'));
            const opt = document.querySelector(`#categoria-${tipo}-selector [data-category="${cat}"]`);
            if (opt) opt.classList.add('selected');
            document.getElementById(`categoria-${tipo}`).value = cat;
        }

        function openEdit(item) {
            const tipo = item.t;
            const tabIndex = tipo === 'receita' ? 0 : 1;
            const tabEl = document.querySelectorAll('.tab')[tabIndex];
            navTo(tipo === 'receita' ? 'v-receita' : 'v-despesa', tabEl);
            
            document.getElementById(`${tipo}-id`).value = item.id;
            document.getElementById(`descricao-${tipo}`).value = item.descricao;
            
            const inputVal = document.getElementById(`valor-${tipo}`);
            inputVal.value = (item.valor * 100).toFixed(0);
            formatarMoedaInput(inputVal);
            
            document.getElementById(`data-${tipo}`).value = item.data;
            selectCategory(tipo, item.categoria);
            
            document.getElementById(`del-${tipo}`).style.display = "block";
            document.getElementById(`btn-cancel-${tipo}`).style.display = "block";
            
            const btnSalvar = document.getElementById(`btn-salvar-${tipo}`);
            if(btnSalvar) btnSalvar.innerHTML = `<i class="fas fa-sync-alt"></i> Atualizar`;
            const titulo = document.getElementById(`titulo-${tipo}`);
            if(titulo) titulo.innerHTML = `<i class="fas fa-pen"></i> Editando`;
        }

        function cancelarEdicao(store) {
            const tipo = store === 'receitas' ? 'receita' : 'despesa';
            document.getElementById(`${tipo}-id`).value = "";
            document.getElementById(`descricao-${tipo}`).value = "";
            document.getElementById(`valor-${tipo}`).value = "";
            document.getElementById(`data-${tipo}`).value = new Date().toISOString().split('T')[0];
            document.getElementById(`del-${tipo}`).style.display = "none";
            document.getElementById(`btn-cancel-${tipo}`).style.display = "none";
            
            const btnSalvar = document.getElementById(`btn-salvar-${tipo}`);
            if(btnSalvar) btnSalvar.innerHTML = tipo === 'receita' ? `Salvar Receita` : `Confirmar Gasto`;
            const titulo = document.getElementById(`titulo-${tipo}`);
            if(titulo) titulo.innerHTML = tipo === 'receita' ? `<i class="fas fa-plus-circle" style="color: var(--income)"></i> Nova Receita` : `<i class="fas fa-minus-circle" style="color: var(--expense)"></i> Novo Gasto`;
        }

        async function render() {
            if (!db) return;
            const [r, d] = await Promise.all([getAll("receitas"), getAll("despesas")]);
            let filtro = document.getElementById('filtroMes') ? document.getElementById('filtroMes').value : '';
            if(!filtro) {
                filtro = new Date().toISOString().substring(0, 7);
                const el = document.getElementById('filtroMes'); if(el) el.value = filtro;
            }
            const totalR = r.reduce((s, i) => s + i.valor, 0);
            const totalD = d.reduce((s, i) => s + i.valor, 0);
            document.getElementById('dash-saldo').innerText = FORMAT_BRL.format(totalR - totalD);
            const gastosMes = d.filter(i => i.data.startsWith(filtro)).reduce((s, i) => s + i.valor, 0);
            document.getElementById('dash-gastos-mes').innerText = FORMAT_BRL.format(gastosMes);
            
            const listCont = document.getElementById('lista-detalhada'); listCont.innerHTML = "";
            const receitasMes = r.filter(i => i.data.startsWith(filtro));
            const despesasMes = d.filter(i => i.data.startsWith(filtro));
            const fragment = document.createDocumentFragment();
            [...receitasMes.map(x => ({...x, t:'receita'})), ...despesasMes.map(x => ({...x, t:'despesa'}))]
                .sort((a,b) => b.data.localeCompare(a.data))
                .forEach(item => {
                    const el = document.createElement('div'); el.className = 'item'; el.onclick = () => openEdit(item);
                    el.innerHTML = `<div style="flex: 1;"><b style="font-size: 0.95rem; color: var(--text-main)">${item.descricao}</b><br><small style="color: var(--text-sec); font-size: 0.75rem; display: flex; align-items: center; gap: 5px; margin-top: 4px;"><i class="far fa-calendar"></i> ${item.data.split('-').reverse().join('/')}</small></div><div style="font-weight: 700; font-size: 0.95rem; color:${item.t === 'receita' ? 'var(--income)' : 'var(--expense)'}">${item.t === 'receita' ? '+' : '-'} ${FORMAT_BRL.format(item.valor)}</div>`;
                    fragment.appendChild(el);
                });
            if(fragment.childElementCount === 0) listCont.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--text-sec);">Nenhum lan√ßamento.</div>';
            else listCont.appendChild(fragment);
            
            updateChart(despesasMes); updateMonthlyChart(r, d);
        }

        function updateChart(dados) {
            const ctx = document.getElementById('graficoPizza').getContext('2d');
            if (chartInstancePie) chartInstancePie.destroy();
            const cats = {}; dados.forEach(d => cats[d.categoria] = (cats[d.categoria] || 0) + d.valor);
            const labels = Object.keys(cats).map(k => CATEGORIES.despesa[k] || k);
            const values = Object.values(cats);
            const legendDiv = document.getElementById('categoria-legend'); legendDiv.innerHTML = '';
            labels.forEach((label, i) => {
                const color = CHART_COLORS[i % CHART_COLORS.length];
                legendDiv.innerHTML += `<div class="legend-item" style="display:flex;align-items:center;gap:6px;"><span class="legend-color" style="width:12px;height:12px;border-radius:4px;background: ${color}"></span> ${label}</div>`;
            });
            chartInstancePie = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: values, backgroundColor: labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]), borderWidth: 0, hoverOffset: 8 }] },
                options: { maintainAspectRatio: false, responsive: true, cutout: '70%', plugins: { legend: { display: false } } }
            });
        }

        function updateMonthlyChart(receitas, despesas) {
            const ctx = document.getElementById('graficoMensal').getContext('2d');
            if (chartInstanceMonthly) chartInstanceMonthly.destroy();
            const hoje = new Date(); const meses = [];
            for (let i = 5; i >= 0; i--) { const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1); meses.push(d.toISOString().substring(0, 7)); }
            const receitasPorMes = meses.map(m => receitas.filter(r => r.data.startsWith(m)).reduce((s, i) => s + i.valor, 0));
            const despesasPorMes = meses.map(m => despesas.filter(d => d.data.startsWith(m)).reduce((s, i) => s + i.valor, 0));
            const labels = meses.map(m => { const [ano, mes] = m.split('-'); return `${mes}/${ano.substring(2)}`; });
            chartInstanceMonthly = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Receitas', data: receitasPorMes, backgroundColor: '#34c759', borderRadius: 4 }, { label: 'Despesas', data: despesasPorMes, backgroundColor: '#ff3b30', borderRadius: 4 }] },
                options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#8e8e93' } } }, scales: { x: { ticks: { color: '#8e8e93' } }, y: { ticks: { color: '#8e8e93' } } } }
            });
        }

        function popularFiltro() {
            const sel = document.getElementById('filtroMes');
            if (!sel || sel.options.length > 0) return;
            const hoje = new Date();
            for(let i=0; i<6; i++) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                sel.add(new Option(d.toLocaleDateString('pt-BR', {month:'long', year:'numeric'}), d.toISOString().substring(0, 7)));
            }
            sel.value = hoje.toISOString().substring(0, 7);
        }

        function showToast(m) {
            const t = document.getElementById("toast"); t.innerText = m; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }
        function confirmarLimpeza() {
            if(confirm("‚ö†Ô∏è Isso apagar√° TODOS os dados. Continuar?")) {
                db.transaction("receitas", "readwrite").objectStore("receitas").clear();
                db.transaction("despesas", "readwrite").objectStore("despesas").clear();
                showToast("Limpo!"); render();
            }
        }

        window.onload = async () => {
            try { await initDB(); } catch (err) { console.error(err); return; }
            checkUser();
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('data-receita').value = hoje;
            document.getElementById('data-despesa').value = hoje;
            popularFiltro(); render();

            document.querySelectorAll("button").forEach(btn => {
                btn.addEventListener("click", rippleEffect);
            });

            ['receita', 'despesa'].forEach(tipo => {
                const valInput = document.getElementById(`valor-${tipo}`);
                const descInput = document.getElementById(`descricao-${tipo}`);
                
                valInput.addEventListener('input', e => formatarMoedaInput(e.target));
                valInput.addEventListener('focus', () => setTimeout(()=> valInput.select(), 100));
                
                valInput.addEventListener('blur', e => {
                    validarCampo(e.target, getValorNumerico(`valor-${tipo}`) > 0, "Digite um valor");
                });
                descInput.addEventListener('blur', e => {
                    validarCampo(e.target, e.target.value.trim().length > 2, "M√≠nimo 3 letras");
                });
                
                [valInput, descInput].forEach(inp => {
                    inp.addEventListener("focus", () => inp.closest(".card")?.style.setProperty("transform", "scale(1.02)"));
                    inp.addEventListener("blur", () => inp.closest(".card")?.style.removeProperty("transform"));
                });
            });
        };
    </script>
</body>
</html>
